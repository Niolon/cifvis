(function(u,g){typeof exports=="object"&&typeof module<"u"?g(exports,require("mathjs"),require("three")):typeof define=="function"&&define.amd?define(["exports","mathjs","three"],g):(u=typeof globalThis<"u"?globalThis:u||self,g(u.CifVis={},u.math,u.THREE))})(this,function(u,g,S){"use strict";var me=Object.defineProperty;var Pt=u=>{throw TypeError(u)};var fe=(u,g,S)=>g in u?me(u,g,{enumerable:!0,configurable:!0,writable:!0,value:S}):u[g]=S;var L=(u,g,S)=>fe(u,typeof g!="symbol"?g+"":g,S),Bt=(u,g,S)=>g.has(u)||Pt("Cannot "+S);var O=(u,g,S)=>(Bt(u,g,"read from private field"),S?S.call(u):g.get(u)),It=(u,g,S)=>g.has(u)?Pt("Cannot add the same private member more than once"):g instanceof WeakSet?g.add(u):g.set(u,S),Ft=(u,g,S,J)=>(Bt(u,g,"write to private field"),J?J.call(u,S):g.set(u,S),S);var E;function J(c){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(c){for(const e in c)if(e!=="default"){const o=Object.getOwnPropertyDescriptor(c,e);Object.defineProperty(t,e,o.get?o:{enumerable:!0,get:()=>c[e]})}}return t.default=c,Object.freeze(t)}const h=J(S);function at(c,t=!0){const e=/^([+-]?)(\d+\.?\d*|\.\d+)[eE]([+-]?\d+)\((\d+)\)$/,o=c.match(e);if(t&&o){const[,a,l,d,m]=o,f=a==="-"?-1:1,y=parseFloat(l),p=parseInt(d),_=l.includes(".")?l.split(".")[1].length:0,P=Number(f*y*Math.pow(10,p)),K=p-_,Rt=Number(parseInt(m)*Math.pow(10,K));return _-p>=0&&_-p<=100?{value:Number(P.toFixed(_-p)),su:Number(Rt.toFixed(_-p))}:{value:P,su:Rt}}const s=/^([+-]?)(\d+\.?\d*|\.\d+)[eE]([+-]?\d+)$/,i=c.match(s);if(i){const[,a,l,d]=i,m=a==="-"?-1:1,f=l.includes(".")?l.split(".")[1].length:0,y=parseInt(d),p=Number(m*parseFloat(l)*Math.pow(10,y));return f-y>=0&&f-y<=100?{value:Number(p.toFixed(f-y)),su:NaN}:{value:p,su:NaN}}const r=/^([+-]?)(\d+\.?\d*|\.\d+)\((\d+)\)$/,n=c.match(r);if(t&&n){const[,a,l,d]=n,m=a==="-"?-1:1;if(l.includes(".")){const f=l.split(".")[1].length,y=Number((m*parseFloat(l)).toFixed(f)),p=Number((Math.pow(10,-f)*parseFloat(d)).toFixed(f));return{value:y,su:p}}else{const f=m*parseInt(l),y=parseInt(d);return{value:f,su:y}}}return isNaN(c)?/^".*"$/.test(c)||/^'.*'$/.test(c)?{value:c.slice(1,-1).replace(/\\([^\\])/g,"$1"),su:NaN}:{value:c.replace(/\\([^\\])/g,"$1"),su:NaN}:{value:c.includes(".")?parseFloat(c):parseInt(c),su:NaN}}function _t(c,t){const e=[c[t].slice(1)],o=c.slice(t+1),s=o.findIndex(a=>a.startsWith(";")),i=e.concat(o.slice(0,s)),r=i.findIndex(a=>a.trim()!==""),n=i.findLastIndex(a=>a.trim!=="");return{value:i.slice(r,n+1).join(`
`),endIndex:t+s+1}}const zt=["_space_group_symop_ssg","_space_group_symop","_symmetry_equiv","_geom_bond","_geom_hbond","_geom_angle","_geom_torsion","_diffrn_refln","_refln","_atom_site_fourier_wave_vector","_atom_site_moment_fourier_param","_atom_site_moment_special_func","_atom_site_moment","_atom_site_rotation","_atom_site_displace_Fourier","_atom_site_displace_special_func","_atom_site_occ_Fourier","_atom_site_occ_special_func","_atom_site_phason","_atom_site_rot_Fourier_param","_atom_site_rot_Fourier","_atom_site_rot_special_func","_atom_site_U_Fourier","_atom_site_anharm_gc_c","_atom_site_anharm_gc_d","_atom_site_aniso","_atom_site"];class Q{constructor(t,e,o,s,i=null){this.splitSU=s,this.headerLines=t,this.dataLines=e,this.endIndex=o,this.headers=null,this.data=null,this.name=null,i?this.name=i:this.name=this.findCommonStart()}static fromLines(t,e){let o=1;for(;o<t.length&&t[o].trim().startsWith("_");)o++;const s=t.slice(1,o).map(l=>l.trim());let i=o,r=!1;for(;i<t.length&&(!t[i].trim().startsWith("_")&&!t[i].trim().startsWith("loop_")||r);)t[i].startsWith(";")&&(r=!r),i++;const n=t.slice(o,i),a=i;return new Q(s,n,a,e)}parse(){if(this.data!==null)return;this.headers=[...this.headerLines],this.data={};const t=this.dataLines.reduce((o,s,i)=>{if(s=s.trim(),!s.length)return o;if(s.startsWith(";")){const n=_t(this.dataLines,i);o.push({value:n.value,su:NaN});for(let a=i;a<n.endIndex+1;a++)this.dataLines[a]="";return o}const r=Array.from(s.matchAll(/'([^']*(?:'\S[^']*)*)'|"([^"]*(?:"\S[^"]*)*)"|\S+/g));return o.concat(r.map(n=>at(n[1]||n[2]||n[0],this.splitSU)))},[]),e=this.headers.length;if(t.length%e!==0){const o=t.map(({value:s,su:i})=>`{value: ${s}, su: ${i}}`).join(", ");throw new Error(`Loop ${this.name}: Cannot distribute ${t.length} values evenly into ${e} columns
entries are: ${o}`)}else if(t.length===0)throw new Error(`Loop ${this.name} has no data values.`);for(let o=0;o<e;o++){const s=this.headers[o],i=t.slice(o).filter((n,a)=>a%e===0);i.some(n=>!isNaN(n.su))?(this.data[s]=i.map(n=>n.value),this.data[s+"_su"]=i.map(n=>n.su),this.headers.push(s+"_su")):this.data[s]=i.map(n=>n.value)}}findCommonStart(t=!0){if(t){for(const r of zt)if(this.headerLines.filter(a=>a.toLowerCase().startsWith(r.toLowerCase())).length>=this.headerLines.length/2)return r}const e=this.headerLines.map(r=>r.split("."));if(e[0].length>1){const r=e[0][0];if(this.headerLines.filter(a=>a.split(".")[0]===r).length>=this.headerLines.length/2)return r}const o=this.headerLines.map(r=>r.split(/[_.]/).filter(n=>n)),s=Math.min(...o.map(r=>r.length));let i="";for(let r=0;r<s;r++){const n=o[0][r],a=o.filter(l=>l[r]===n).length;if(this.headerLines.length===2)if(a===2)i+="_"+n;else break;else if(a>=this.headerLines.length/2)i+="_"+n;else break}return i}get(t,e=null){this.parse();const o=Array.isArray(t)?t:[t];for(const s of o){const i=this.data[s];if(i!==void 0)return i}if(e!==null)return e;throw new Error(`None of the keys [${o.join(", ")}] found in CIF loop ${this.name}`)}getIndex(t,e,o=null){this.parse();const s=Array.isArray(t)?t:[t];if(!s.some(r=>this.headers.includes(r))){if(o!==null)return o;throw new Error(`None of the keys [${s.join(", ")}] found in CIF loop ${this.name}`)}const i=this.get(s);if(e<i.length)return i[e];throw new Error(`Tried to look up value of index ${e} in ${this.name}, but length is only ${i.length}`)}getHeaders(){return this.headers||this.parse(),this.headers}getName(){return this.name}getEndIndex(){return this.endIndex}}function X(c){return c&&typeof c.getHeaders=="function"}function lt(c){return c.getHeaders()[0].split("_").filter(e=>e.length>0)}function Ht(c,t,e){const o=X(c)?c:t,s=e.split("_").filter(n=>n.length>0),i=lt(o),r="_"+s.join("_")+"_"+i[s.length];return X(c)?[r,e]:[e,r]}function $t(c,t){const e=c.findCommonStart(!1),o=t.findCommonStart(!1);return e.length!==o.length?[e,o]:null}function Vt(c,t,e){const o=e.split("_").filter(r=>r.length>0),s=lt(c),i=lt(t);return s.length>=i.length?[e+"_"+s[o.length],e]:[e,e+"_"+i[o.length]]}function Gt(c,t,e){let o;!X(c)||!X(t)?o=Ht(c,t,e):o=$t(c,t)||Vt(c,t,e);const s=[c,t];return s.forEach((i,r)=>{X(i)&&(i.name=o[r])}),{newNames:o,newEntries:s}}class bt{constructor(t,e=!0){this.splitSU=e,this.rawCifBlocks=this.splitCifBlocks(`

`+t),this.blocks=Array(this.rawCifBlocks.length).fill(null)}splitCifBlocks(t){const e=[],o=t.replaceAll(`\r
`,`
`).split(/\r?\ndata_/).slice(1);let s=0;for(;s<o.length;){let i=o[s];const r=/\n;/g,n=i.match(r);let a=n?n.length:0;for(;a%2===1&&s+1<o.length;){s++,i+=`
data_`+o[s];const l=i.match(r);a=l?l.length:0}e.push(i),s++}return e}getBlock(t=0){return this.blocks[t]||(this.blocks[t]=new wt(this.rawCifBlocks[t],this.splitSU)),this.blocks[t]}getAllBlocks(){for(let t=0;t<this.blocks.length;t++)this.blocks[t]||(this.blocks[t]=new wt(this.rawCifBlocks[t],this.splitSU));return this.blocks}}class wt{constructor(t,e=!0){this.rawText=t,this.splitSU=e,this.data=null,this.dataBlockName=null}parse(){if(this.data!==null)return;this.data={};const t=this.rawText.split(`
`).filter(o=>!o.trim().startsWith("#")).map(o=>{const s=/ #(?=(?:[^"]*"[^"]*")*[^"]*$)(?=(?:[^']*'[^']*')*[^']*$)/;return o.split(s)[0]});this.dataBlockName=t[0];let e=1;for(;e<t.length;){if(e+1<t.length&&t[e+1].startsWith(";")){const i=_t(t,e+1);this.data[t[e]]=i.value,e=i.endIndex+1;continue}if(t[e].trim().startsWith("loop_")){const i=Q.fromLines(t.slice(e),this.splitSU);if(!Object.prototype.hasOwnProperty.call(this.data,i.getName()))this.data[i.getName()]=i;else{const r=Gt(this.data[i.getName()],i,i.getName());this.data[r.newNames[0]]=r.newEntries[0],this.data[r.newNames[1]]=r.newEntries[1]}e+=i.getEndIndex();continue}const o=t[e].trim();if(o.length===0){e++;continue}const s=o.match(/^(_\S+)\s+(.*)$/);if(s){const i=s[1],r=at(s[2],this.splitSU);this.data[i]=r.value,isNaN(r.su)||(this.data[i+"_su"]=r.su)}else if(o.startsWith("_")&&!t[e+1].startsWith("_")){const i=o,r=at(t[e+1].trim(),this.splitSU);this.data[i]=r.value,isNaN(r.su)||(this.data[i+"_su"]=r.su),e++}else throw new Error("Could not parse line "+String(e)+": "+t[e]);e++}}get dataBlockName(){return this._dataBlockName||this.parse(),this._dataBlockName}set dataBlockName(t){this._dataBlockName=t}get(t,e=null){this.parse();const o=Array.isArray(t)?t:[t];for(const s of o){const i=this.data[s];if(i!==void 0)return i}if(e!==null)return e;throw new Error(`None of the keys [${o.join(", ")}] found in CIF block`)}}const v=g.create(g.all,{});function H(c){const t=v.unit(c.alpha,"deg").toNumber("rad"),e=v.unit(c.beta,"deg").toNumber("rad"),o=v.unit(c.gamma,"deg").toNumber("rad"),s=Math.cos(t),i=Math.cos(e),r=Math.cos(o),n=Math.sin(o),a=Math.sqrt(1-s*s-i*i-r*r+2*s*i*r);return v.matrix([[c.a,c.b*r,c.c*i],[0,c.b*n,c.c*(s-i*r)/n],[0,0,c.c*a/n]])}function Ct(c){return v.matrix([[c[0],c[3],c[4]],[c[3],c[1],c[5]],[c[4],c[5],c[2]]])}function Ut(c){const t=v.matrix(c);return[t.get([0,0]),t.get([1,1]),t.get([2,2]),t.get([0,1]),t.get([0,2]),t.get([1,2])]}function qt(c,t){const e=v.matrix(c),o=v.transpose(v.inv(e)),s=v.diag(v.matrix(v.transpose(o).toArray().map(a=>v.norm(a)))),i=Ct(t),r=v.multiply(v.multiply(s,i),v.transpose(s)),n=v.multiply(v.multiply(e,r),v.transpose(e));return Ut(n)}const vt=g.create(g.all),yt=class yt{constructor(t,e,o){It(this,E);if(new.target===yt)throw new TypeError("BasePosition is an abstract class and cannot be instantiated directly, you probably want CartPosition");Ft(this,E,[Number(t),Number(e),Number(o)]),Object.defineProperties(this,{0:{get:()=>O(this,E)[0]},1:{get:()=>O(this,E)[1]},2:{get:()=>O(this,E)[2]},length:{value:3},[Symbol.iterator]:{value:function*(){yield O(this,E)[0],yield O(this,E)[1],yield O(this,E)[2]}}})}get x(){return O(this,E)[0]}get y(){return O(this,E)[1]}get z(){return O(this,E)[2]}set x(t){O(this,E)[0]=t}set y(t){O(this,E)[1]=t}set z(t){O(this,E)[2]=t}toCartesian(t){throw new Error("toCartesian must be implemented by subclass")}};E=new WeakMap;let tt=yt;class Mt extends tt{constructor(t,e,o){super(t,e,o)}toCartesian(t){const e=vt.multiply(t.fractToCartMatrix,vt.matrix([this.x,this.y,this.z]));return new St(...e.toArray())}}class St extends tt{constructor(t,e,o){super(t,e,o)}toCartesian(t){return this}}class Yt{static fromCIF(t,e){let o=!1;const s=t.get("_atom_site"),i=[".","?"];if(String(s.getIndex(["_atom_site.calc_flag","_atom_site_calc_flag"],e,"")).toLowerCase()==="dum")throw new Error("Dummy atom: calc_flag is dum");try{const n=s.getIndex(["_atom_site.fract_x","_atom_site_fract_x"],e),a=s.getIndex(["_atom_site.fract_y","_atom_site_fract_y"],e),l=s.getIndex(["_atom_site.fract_z","_atom_site_fract_z"],e);if(!i.includes(n)&&!i.includes(a)&&!i.includes(l))return new Mt(n,a,l);o=!0}catch{}try{const n=s.getIndex(["_atom_site.Cartn_x","_atom_site.cartn_x","_atom_site_Cartn_x"],e),a=s.getIndex(["_atom_site.Cartn_y","_atom_site.cartn_y","_atom_site_Cartn_y"],e),l=s.getIndex(["_atom_site.Cartn_z","_atom_site.cartn_z","_atom_site_Cartn_z"],e);if(!i.includes(n)&&!i.includes(a)&&!i.includes(l))return new St(n,a,l);o=!0}catch{}throw o?new Error("Dummy atom: Invalid position"):new Error("Invalid position: No valid fractional or Cartesian coordinates found")}}const T=g.create(g.all,{});class ${constructor(t){this.uiso=t}static fromBiso(t){return new $(t/(8*Math.PI*Math.PI))}}class V{constructor(t,e,o,s,i,r){this.u11=t,this.u22=e,this.u33=o,this.u12=s,this.u13=i,this.u23=r}static fromBani(t,e,o,s,i,r){const n=1/(8*Math.PI*Math.PI);return new V(t*n,e*n,o*n,s*n,i*n,r*n)}getUCart(t){return qt(t.fractToCartMatrix,[this.u11,this.u22,this.u33,this.u12,this.u13,this.u23])}getEllipsoidMatrix(t){const e=Ct(this.getUCart(t)),{eigenvectors:o}=T.eigs(e),s=T.transpose(T.matrix(o.map(l=>l.vector))),i=T.matrix(o.map(l=>l.value>0?l.value:NaN)),r=T.det(s),n=T.diag(i.map(Math.sqrt));let a;if(T.abs(r-1)>1e-10){const l=T.multiply(s,1/r);a=T.multiply(l,n)}else a=T.multiply(s,n);return T.matrix(a)}}class D{static fromCIF(t,e){const o=t.get("_atom_site"),s=o.getIndex(["_atom_site.label","_atom_site_label"],e),i=o.getIndex(["_atom_site.adp_type","_atom_site_adp_type","_atom_site.thermal_displace_type","_atom_site_thermal_displace_type"],e,!1);if(i)return D.createFromExplicitType(t,e,s,i);if(D.isInAnisoLoop(t,s)){const l=D.createUani(t,s);if(l!==null)return l;const d=D.createBani(t,s);if(d!==null)return d}const n=D.createUiso(t,e);if(n!==null)return n;const a=D.createBiso(t,e);return a!==null?a:null}static createFromExplicitType(t,e,o,s){switch(s.toLowerCase()){case"uani":return D.createUani(t,o);case"aniso":return D.createUani(t,o);case"bani":return D.createBani(t,o);case"uiso":return D.createUiso(t,e);case"iso":return D.createUiso(t,e);case"biso":return D.createBiso(t,e);default:return null}}static isInAnisoLoop(t,e){try{return t.get("_atom_site_aniso").get(["_atom_site_aniso.label","_atom_site_aniso_label"]).includes(e)}catch{return!1}}static createUani(t,e){let o;try{o=t.get("_atom_site_aniso")}catch{throw new Error(`Atom ${e} had ADP type UAni, but no atom_site_aniso loop was found`)}const i=o.get(["_atom_site_aniso.label","_atom_site_aniso_label"]).indexOf(e);if(i===-1)throw new Error(`Atom ${e} has ADP type Uani, but was not found in atom_site_aniso.label`);const r=o.getIndex(["_atom_site_aniso.u_11","_atom_site_aniso_U_11"],i,NaN),n=o.getIndex(["_atom_site_aniso.u_22","_atom_site_aniso_U_22"],i,NaN),a=o.getIndex(["_atom_site_aniso.u_33","_atom_site_aniso_U_33"],i,NaN),l=o.getIndex(["_atom_site_aniso.u_12","_atom_site_aniso_U_12"],i,NaN),d=o.getIndex(["_atom_site_aniso.u_13","_atom_site_aniso_U_13"],i,NaN),m=o.getIndex(["_atom_site_aniso.u_23","_atom_site_aniso_U_23"],i,NaN);return[r,n,a,l,d,m].some(isNaN)?null:new V(r,n,a,l,d,m)}static createBani(t,e){let o;try{o=t.get("_atom_site_aniso")}catch{throw new Error(`Atom ${e} had ADP type BAni, but no atom_site_aniso loop was found`)}const i=o.get(["_atom_site_aniso.label","_atom_site_aniso_label"]).indexOf(e);if(i===-1)throw new Error(`Atom ${e} has ADP type Bani, but was not found in atom_site_aniso.label`);const r=o.getIndex(["_atom_site_aniso.b_11","_atom_site_aniso_B_11"],i,NaN),n=o.getIndex(["_atom_site_aniso.b_22","_atom_site_aniso_B_22"],i,NaN),a=o.getIndex(["_atom_site_aniso.b_33","_atom_site_aniso_B_33"],i,NaN),l=o.getIndex(["_atom_site_aniso.b_12","_atom_site_aniso_B_12"],i,NaN),d=o.getIndex(["_atom_site_aniso.b_13","_atom_site_aniso_B_13"],i,NaN),m=o.getIndex(["_atom_site_aniso.b_23","_atom_site_aniso_B_23"],i,NaN);return[r,n,a,l,d,m].some(isNaN)?null:V.fromBani(r,n,a,l,d,m)}static createUiso(t,e){try{const s=t.get("_atom_site").getIndex(["_atom_site.u_iso_or_equiv","_atom_site_U_iso_or_equiv"],e,NaN);return isNaN(s)?null:new $(s)}catch{return null}}static createBiso(t,e){try{const s=t.get("_atom_site").getIndex(["_atom_site.b_iso_or_equiv","_atom_site_B_iso_or_equiv"],e,NaN);return isNaN(s)?null:$.fromBiso(s)}catch{return null}}}const x=g.create(g.all);function kt(c){if(Math.abs(c)<.0021)return"";const t=[2,3,4,6],e=c<0?"-":"",o=Math.abs(c);if(Math.abs(o-Math.round(o))<.0021)return e+Math.round(o);for(const s of t){const i=o*s,r=Math.round(i);if(Math.abs(i-r)<.0021)return r===s?e+"1":e+r+"/"+s}return e+o.toString()}class G{constructor(t){const{matrix:e,vector:o}=this.parseSymmetryInstruction(t);this.rotMatrix=e,this.transVector=o}parseSymmetryInstruction(t){const e=Array(3).fill().map(()=>Array(3).fill(0)),o=Array(3).fill(0),s=t.split(",").map(i=>i.trim().toUpperCase());if(s.length!==3)throw new Error("Symmetry operation must have exactly three components");return s.forEach((i,r)=>{const n=/([+-]?\d*\.?\d*(?:\/\d+)?)\*?([XYZ])/g;let a;for(;(a=n.exec(i))!==null;){let m=a[1];const f=a[2];if(!m||m==="+")m="1";else if(m==="-")m="-1";else if(m.includes("/")){const[p,_]=m.split("/");m=parseFloat(p)/parseFloat(_)}m=parseFloat(m);const y=f==="X"?0:f==="Y"?1:2;e[r][y]=m}const d=i.replace(/[+-]?\d*\.?\d*(?:\/\d+)?\*?[XYZ]/g,"").match(/[+-]?\d*\.?\d+(?:\/\d+)?/g)||[];for(const m of d)if(m.includes("/")){const[f,y]=m.split("/");o[r]+=parseFloat(f)/parseFloat(y)}else o[r]+=parseFloat(m)}),{matrix:e,vector:o}}static fromCIF(t,e){const s=t.get(["_space_group_symop","_symmetry_equiv","_space_group_symop.operation_xyz","_space_group_symop_operation_xyz","_symmetry_equiv.pos_as_xyz","_symmetry_equiv_pos_as_xyz"]).getIndex(["_space_group_symop.operation_xyz","_space_group_symop_operation_xyz","_symmetry_equiv.pos_as_xyz","_symmetry_equiv_pos_as_xyz"],e);return new G(s)}applyToPoint(t){const e=x.add(x.multiply(this.rotMatrix,t),this.transVector);return Array.isArray(e)?e:e.toArray()}applyToAtom(t){const e=new Mt(...x.add(x.multiply(this.rotMatrix,[t.position.x,t.position.y,t.position.z]),this.transVector));let o=null;if(t.adp&&t.adp instanceof V){const s=[[t.adp.u11,t.adp.u12,t.adp.u13],[t.adp.u12,t.adp.u22,t.adp.u23],[t.adp.u13,t.adp.u23,t.adp.u33]],i=this.rotMatrix,r=x.transpose(i),n=x.multiply(x.multiply(i,s),r);o=new V(n[0][0],n[1][1],n[2][2],n[0][1],n[0][2],n[1][2])}else t.adp&&t.adp instanceof $&&(o=new $(t.adp.uiso));return new Z(t.label,t.atomType,e,o,t.disorderGroup)}applyToAtoms(t){return t.map(e=>this.applyToAtom(e))}copy(){const t=new G("x,y,z");return t.rotMatrix=x.clone(this.rotMatrix),t.transVector=x.clone(this.transVector),t}toSymmetryString(t=null){const e=["x","y","z"],o=[],s=t?x.add(this.transVector,t):this.transVector;for(let i=0;i<3;i++){let r="";const n=[];for(let a=0;a<3;a++){const l=this.rotMatrix[i][a];if(Math.abs(l)>1e-10)if(Math.abs(Math.abs(l)-1)<1e-10)n.push(l>0?e[a]:`-${e[a]}`);else{const d=kt(Math.abs(l));n.push(l>0?`${d}${e[a]}`:`-${d}${e[a]}`)}}if(r=n.join("+"),r===""&&(r="0"),Math.abs(s[i])>1e-10){const a=kt(Math.abs(s[i])),l=s[i]<0?`-${a}`:a;r==="0"?r=l:r.startsWith("-")?r=`${l}${r}`:r=`${l}+${r}`}o.push(r)}return o.join(",")}}class q{constructor(t,e,o,s=null){var i;this.spaceGroupName=t,this.spaceGroupNumber=e,this.symmetryOperations=o,this.operationIds=s||new Map(o.map((r,n)=>[(n+1).toString(),n])),this.identitySymOpId=(i=Array.from(this.operationIds.entries()).find(([r,n])=>{const a=this.symmetryOperations[n];return x.equal(a.rotMatrix,x.identity(3))&&x.equal(a.transVector,x.zeros(3))}))==null?void 0:i[0]}generateEquivalentPositions(t){return this.symmetryOperations.map(e=>e.applyToPoint(t))}parsePositionCode(t){let e,o;try{const[r,n]=t.split("_");o=r,e=n.split("").map(a=>parseInt(a)-5)}catch{o=t.toString(),e=[0,0,0]}const s=this.operationIds.get(o);if(s===void 0)throw new Error(`Invalid symmetry operation ID in string ${t}: ${o}, expecting string format "<symOpId>_abc". ID entry in present symOp loop?`);return{symOp:this.symmetryOperations[s],transVector:e}}applySymmetry(t,e){const{symOp:o,transVector:s}=this.parsePositionCode(t);if(Array.isArray(e)){const r=o.applyToAtoms(e);return r.forEach(n=>{n.position.x+=s[0],n.position.y+=s[1],n.position.z+=s[2]}),r}const i=o.applyToAtom(e);return i.position.x+=s[0],i.position.y+=s[1],i.position.z+=s[2],i}static fromCIF(t){const e=t.get(["_space_group.name_h-m_alt","_space_group.name_H-M_full","_symmetry_space_group_name_H-M","_space_group_name_H-M_alt"],"Unknown"),o=t.get(["_space_group.it_number","_space_group.IT_number","_symmetry_Int_Tables_number","_space_group_IT_number"],0),s=t.get(["_space_group_symop","_symmetry_equiv","_symmetry_equiv_pos","_space_group_symop.operation_xyz","_space_group_symop_operation_xyz","_symmetry_equiv.pos_as_xyz","_symmetry_equiv_pos_as_xyz"],!1);if(s&&!(s instanceof Q))return new q(e,o,[new G(s)]);if(s||console.warn(Object.keys(t).filter(i=>i.includes("sym"))),s){const i=s.get(["_space_group_symop.operation_xyz","_space_group_symop_operation_xyz","_symmetry_equiv.pos_as_xyz","_symmetry_equiv_pos_as_xyz"]);let r=null;try{const a=s.get(["_space_group_symop.id","_space_group_symop_id","_symmetry_equiv.id","_symmetry_equiv_pos_site_id"]);r=new Map(a.map((l,d)=>[l.toString(),d]))}catch{}const n=i.map(a=>new G(a));return new q(e,o,n,r)}else return console.warn("No symmetry operations found in CIF block, will use P1"),new q("Unknown",0,[new G("x,y,z")])}}class B{constructor(t,e,o=null,s=null,i=null){this.atom1Label=t,this.atom2Label=e,this.bondLength=o,this.bondLengthSU=s,this.atom2SiteSymmetry=i}static fromCIF(t,e){const o=t.get("_geom_bond");let s=o.getIndex(["_geom_bond.site_symmetry_2","_geom_bond_site_symmetry_2"],e,".");const i=o.getIndex(["_geom_bond.site_symmetry_1","_geom_bond_site_symmetry_1"],e,!1);return i&&i===s&&(s="."),new B(o.getIndex(["_geom_bond.atom_site_label_1","_geom_bond_atom_site_label_1"],e),o.getIndex(["_geom_bond.atom_site_label_2","_geom_bond_atom_site_label_2"],e),o.getIndex(["_geom_bond.distance","_geom_bond_distance"],e),o.getIndex(["_geom_bond.distance_su","_geom_bond_distance_su"],e,NaN),s!=="?"?s:".")}}class Y{constructor(t,e,o,s,i,r,n,a,l,d,m,f){this.donorAtomLabel=t,this.hydrogenAtomLabel=e,this.acceptorAtomLabel=o,this.donorHydrogenDistance=s,this.donorHydrogenDistanceSU=i,this.acceptorHydrogenDistance=r,this.acceptorHydrogenDistanceSU=n,this.donorAcceptorDistance=a,this.donorAcceptorDistanceSU=l,this.hBondAngle=d,this.hBondAngleSU=m,this.acceptorAtomSymmetry=f}static fromCIF(t,e){const o=t.get("_geom_hbond"),s=o.getIndex(["_geom_hbond.site_symmetry_a","_geom_hbond_site_symmetry_A"],e,".");return new Y(o.getIndex(["_geom_hbond.atom_site_label_d","_geom_hbond_atom_site_label_D"],e),o.getIndex(["_geom_hbond.atom_site_label_h","_geom_hbond_atom_site_label_H"],e),o.getIndex(["_geom_hbond.atom_site_label_a","_geom_hbond_atom_site_label_A"],e),o.getIndex(["_geom_hbond.distance_dh","_geom_hbond_distance_DH"],e,NaN),o.getIndex(["_geom_hbond.distance_dh_su","_geom_hbond_distance_DH_su"],e,NaN),o.getIndex(["_geom_hbond.distance_ha","_geom_hbond_distance_HA"],e,NaN),o.getIndex(["_geom_hbond.distance_ha_su","_geom_hbond_distance_HA_su"],e,NaN),o.getIndex(["_geom_hbond.distance_da","_geom_hbond_distance_DA"],e,NaN),o.getIndex(["_geom_hbond.distance_da_su","_geom_hbond_distance_DA_su"],e,NaN),o.getIndex(["_geom_hbond.angle_dha","_geom_hbond_angle_DHA"],e,NaN),o.getIndex(["_geom_hbond.angle_dha_su","_geom_hbond_angle_DHA_su"],e,NaN),s!=="?"?s:".")}}class Et{constructor(){this.atomLabelErrors=[],this.symmetryErrors=[]}addAtomLabelError(t){this.atomLabelErrors.push(t)}addSymmetryError(t){this.symmetryErrors.push(t)}isValid(){return this.atomLabelErrors.length+this.symmetryErrors.length===0}report(t,e){let o="";return this.atomLabelErrors.length!==0&&(o+=`Unknown atom label(s). Known labels are 
`,o+=t.map(s=>s.label).join(", "),o+=`
`,o+=this.atomLabelErrors.join(`
`)),this.symmetryErrors.length!==0&&(o.length!==0&&(o+=`
`),o+="Unknown symmetry ID(s) or String format. Expected format is <id>_abc. ",o+=`Known IDs are:
`,o+=Array.from(e.operationIds.keys()).join(", "),o+=`
`,o+=this.symmetryErrors.join(`
`)),o}}class N{static createBonds(t,e){try{const o=t.get("_geom_bond"),s=o.get(["_geom_bond.atom_site_label_1","_geom_bond_atom_site_label_1"]).length,i=[];for(let r=0;r<s;r++){const n=o.getIndex(["_geom_bond.atom_site_label_1","_geom_bond_atom_site_label_1"],r),a=o.getIndex(["_geom_bond.atom_site_label_2","_geom_bond_atom_site_label_2"],r);N.isValidBondPair(n,a,e)&&i.push(B.fromCIF(t,r))}return i}catch{return[]}}static createHBonds(t,e){const o=t.get("_geom_hbond",!1);if(!o)return[];const s=o.get(["_geom_hbond.atom_site_label_d","_geom_hbond_atom_site_label_D"]).length,i=[];for(let r=0;r<s;r++){const n=o.getIndex(["_geom_hbond.atom_site_label_d","_geom_hbond_atom_site_label_D"],r,"?"),a=o.getIndex(["_geom_hbond.atom_site_label_h","_geom_hbond_atom_site_label_H"],r,"?"),l=o.getIndex(["_geom_hbond.atom_site_label_a","_geom_hbond_atom_site_label_A"],r,"?");N.isValidHBondTriplet(n,a,l,e)&&i.push(Y.fromCIF(t,r))}return i}static validateBonds(t,e,o){const s=new Et,i=new Set(e.map(r=>r.label));for(const r of t){const n=[];if(i.has(r.atom1Label)||n.push(r.atom1Label),i.has(r.atom2Label)||n.push(r.atom2Label),n.length>0&&s.addAtomLabelError(`Non-existent atoms in bond: ${r.atom1Label} - ${r.atom2Label}, non-existent atom(s): ${n.join(", ")}`),r.atom2SiteSymmetry&&r.atom2SiteSymmetry!==".")try{o.parsePositionCode(r.atom2SiteSymmetry)}catch{s.addSymmetryError(`Invalid symmetry in bond: ${r.atom1Label} - ${r.atom2Label}, invalid symmetry operation: ${r.atom2SiteSymmetry}`)}}return s}static validateHBonds(t,e,o){const s=new Et,i=new Set(e.map(r=>r.label));for(const r of t){const n=[];if(i.has(r.donorAtomLabel)||n.push(r.donorAtomLabel),i.has(r.hydrogenAtomLabel)||n.push(r.hydrogenAtomLabel),i.has(r.acceptorAtomLabel)||n.push(r.acceptorAtomLabel),n.length>0&&s.addAtomLabelError(`Non-existent atoms in H-bond: ${r.donorAtomLabel} - ${r.hydrogenAtomLabel} - ${r.acceptorAtomLabel}, non-existent atom(s): ${n.join(", ")}`),r.acceptorAtomSymmetry&&r.acceptorAtomSymmetry!==".")try{o.parsePositionCode(r.acceptorAtomSymmetry)}catch{s.addSymmetryError(`Invalid symmetry in H-bond: ${r.donorAtomLabel} - ${r.hydrogenAtomLabel} - ${r.acceptorAtomLabel}, invalid symmetry operation: ${r.acceptorAtomSymmetry}`)}}return s}static isValidLabel(t){return/^(Cg|Cnt|CG|CNT)/.test(t)}static isValidBondPair(t,e,o){const s=N.isValidLabel(t),i=N.isValidLabel(e);return t==="?"||e==="?"?!1:(!s||o.has(t))&&(!i||o.has(e))}static isValidHBondTriplet(t,e,o,s){const i=N.isValidLabel(t),r=N.isValidLabel(e),n=N.isValidLabel(o);return t==="?"||e==="?"||o==="?"?!1:(!i||s.has(t))&&(!r||s.has(e))&&(!n||s.has(o))}}function et(c){if(!c||typeof c!="string")throw new Error(`Invalid atom label: ${c}`);const t=c.toUpperCase(),e=["HE","LI","BE","NE","NA","MG","AL","SI","CL","AR","CA","SC","TI","CR","MN","FE","CO","NI","CU","ZN","GA","GE","AS","SE","BR","KR","RB","SR","ZR","NB","MO","TC","RU","RH","PD","AG","CD","IN","SN","SB","TE","XE","CS","BA","LA","CE","PR","ND","PM","SM","EU","GD","TB","DY","HO","ER","TM","YB","LU","HF","TA","RE","OS","IR","PT","AU","HG","TL","PB","BI","PO","AT","RN","FR","RA","AC","TH","PA","NP","PU","AM","CM"],o=new RegExp(`^(${e.join("|")})`),s=t.match(o);if(s)return Dt(s[1]);const i=t.match(/^(H|B|C|N|O|F|P|S|K|V|Y|I|W|U|D)/);if(i)return Dt(i[1]);throw new Error(`Could not infer element type from atom label: ${c}`)}function Dt(c){return c.length===1?c:c[0]+c[1].toLowerCase()}class R{constructor(t,e,o=[],s=[],i=null){this.cell=t,this.atoms=e,this.bonds=o,this.hBonds=s,this.recalculateConnectedGroups(),this.symmetry=i||new q("None",0,[new G("x,y,z")])}static fromCIF(t){const e=ct.fromCIF(t),s=t.get("_atom_site").get(["_atom_site.label","_atom_site_label"]),i=Array.from({length:s.length},(f,y)=>{try{return Z.fromCIF(t,y)}catch(p){if(p.message.includes("Dummy atom"))return null;throw p}}).filter(f=>f!==null);if(i.length===0)throw new Error("The cif file contains no valid atoms.");const r=new Set(i.map(f=>f.label)),n=N.createBonds(t,r),a=N.createHBonds(t,r),l=q.fromCIF(t),d=N.validateBonds(n,i,l),m=N.validateHBonds(a,i,l);if(!d.isValid()||!m.isValid()){const f=`There were errors in the bond or H-bond creation
`,y=d.report(i,l),p=m.report(i,l);throw y.length!==0&&p.length!==0?new Error(f+y+`
`+p):new Error(f+y+p)}return new R(e,i,n,a,l)}getAtomByLabel(t){for(const o of this.atoms)if(o.label===t)return o;const e=this.atoms.map(o=>o.label).join(", ");throw new Error(`Could not find atom with label: ${t}, available are: ${e}`)}recalculateConnectedGroups(){const t=new Map,e=[],o=i=>{if(t.has(i.label))return t.get(i.label);const r={atoms:new Set,bonds:new Set,hBonds:new Set};return e.push(r),r};for(const i of this.bonds){const r=this.getAtomByLabel(i.atom1Label),n=this.getAtomByLabel(i.atom2Label);if(i.atom2SiteSymmetry!=="."&&i.atom2SiteSymmetry!==null)continue;const a=t.get(r.label),l=t.get(n.label),d=a||l;if(d){if(d.atoms.add(r),d.atoms.add(n),d.bonds.add(i),t.set(r.label,d),t.set(n.label,d),a&&l&&a!==l){for(const m of l.atoms)a.atoms.add(m),t.set(m.label,a);for(const m of l.bonds)a.bonds.add(m);e.splice(e.indexOf(l),1)}}else{const m=o(r);m.atoms.add(r),m.atoms.add(n),m.bonds.add(i),t.set(r.label,m),t.set(n.label,m)}}for(const i of this.hBonds){const r=this.getAtomByLabel(i.donorAtomLabel),n=this.getAtomByLabel(i.acceptorAtomLabel);if(i.acceptorAtomSymmetry!=="."&&i.acceptorAtomSymmetry!==null)continue;o(r).hBonds.add(i),t.has(n.label)&&o(n).hBonds.add(i)}this.atoms.filter(i=>!e.some(r=>r.atoms.has(i))).forEach(i=>{const r={atoms:new Set([i]),bonds:new Set,hBonds:new Set};e.push(r)}),this.connectedGroups=e.map(i=>({atoms:Array.from(i.atoms),bonds:Array.from(i.bonds),hBonds:Array.from(i.hBonds)}))}}class ct{constructor(t,e,o,s,i,r){this._a=t,this._b=e,this._c=o,this._alpha=s,this._beta=i,this._gamma=r,this.fractToCartMatrix=H(this)}static fromCIF(t){const e=[t.get(["_cell.length_a","_cell_length_a"],-9999.9),t.get(["_cell.length_b","_cell_length_b"],-9999.9),t.get(["_cell.length_c","_cell_length_c"],-9999.9),t.get(["_cell.angle_alpha","_cell_angle_alpha"],-9999.9),t.get(["_cell.angle_beta","_cell_angle_beta"],-9999),t.get(["_cell.angle_gamma","_cell_angle_gamma"],-9999.9)];if(e.some(o=>o<0)){const o=["a","b","c","alpha","beta","gamma"],s=[];e.forEach((r,n)=>{r<0&&s.push(o[n])});const i=s.join(", ");throw new Error(`Unit cell parameter entries missing in CIF or negative for cell parameters: ${i}`)}return new ct(...e)}get a(){return this._a}set a(t){if(t<=0)throw new Error("Cell parameter 'a' must be positive");this._a=t,this.fractToCartMatrix=H(this)}get b(){return this._b}set b(t){if(t<=0)throw new Error("Cell parameter 'b' must be positive");this._b=t,this.fractToCartMatrix=H(this)}get c(){return this._c}set c(t){if(t<=0)throw new Error("Cell parameter 'c' must be positive");this._c=t,this.fractToCartMatrix=H(this)}get alpha(){return this._alpha}set alpha(t){if(t<=0||t>=180)throw new Error("Angle alpha must be between 0 and 180 degrees");this._alpha=t,this.fractToCartMatrix=H(this)}get beta(){return this._beta}set beta(t){if(t<=0||t>=180)throw new Error("Angle beta must be between 0 and 180 degrees");this._beta=t,this.fractToCartMatrix=H(this)}get gamma(){return this._gamma}set gamma(t){if(t<=0||t>=180)throw new Error("Angle gamma must be between 0 and 180 degrees");this._gamma=t,this.fractToCartMatrix=H(this)}}class Z{constructor(t,e,o,s=null,i=0){this.label=String(t),this.atomType=e,this.position=o,this.adp=s,this.disorderGroup=i}static fromCIF(t,e=null,o=null){const s=t.get("_atom_site"),i=s.get(["_atom_site.label","_atom_site_label"]);let r=e;if(e===null&&o)r=i.indexOf(o);else if(e===null)throw new Error("either atomIndex or atomLabel need to be provided");const n=i[r],a=[".","?"];if(a.includes(n))throw new Error("Dummy atom: Invalid label");if(String(s.getIndex(["_atom_site.calc_flag","_atom_site_calc_flag"],r,"")).toLowerCase()==="dum")throw new Error("Dummy atom: calc_flag is dum");let d=s.getIndex(["_atom_site.type_symbol","_atom_site_type_symbol"],r,!1);if(d||(d=et(n)),a.includes(d))throw new Error("Dummy atom: Invalid atom type");const m=Yt.fromCIF(t,r),f=D.fromCIF(t,r),y=s.getIndex(["_atom_site.disorder_group","_atom_site_disorder_group"],r,".");return new Z(n,d,m,f,y==="."?0:y)}}const b={camera:{minDistance:1,maxDistance:100,wheelZoomSpeed:8e-4,pinchZoomSpeed:.001,initialPosition:[0,0,10],fov:45,near:.1,far:1e3},selection:{mode:"multiple",markerMult:1.3,bondMarkerMult:1.7,highlightEmissive:11184810,markerColors:[2062260,16744206,2924588,14034728,9725885,9197131,14907330,8355711,12369186,1556175]},interaction:{rotationSpeed:5,clickThreshold:200,mouseRaycast:{lineThreshold:.5,pointsThreshold:.5,meshThreshold:.1},touchRaycast:{lineThreshold:2,pointsThreshold:2,meshThreshold:.2}},renderMode:"onDemand",hydrogenMode:"none",disorderMode:"all",symmetryMode:"bonds-no-hbonds-no",bondGrowToleranceFactor:1.2,fixCifErrors:!1,atomDetail:3,atomColorRoughness:.3,atomColorMetalness:.5,atomADPRingWidthFactor:1,atomADPRingHeight:.06,atomADPRingSections:18,atomADPInnerSections:7,atomConstantRadiusMultiplier:.25,bondRadius:.05,bondSections:15,bondColor:"#666666",bondColorRoughness:.3,bondColorMetalness:.1,hbondRadius:.04,hbondColor:"#AAAAAA",hbondColorRoughness:.3,hbondColorMetalness:.1,hbondDashSegmentLength:.3,hbondDashFraction:.6,elementProperties:{H:{radius:.31,atomColor:"#ffffff",ringColor:"#000000"},D:{radius:.31,atomColor:"#ffffff",ringColor:"#000000"},He:{radius:.28,atomColor:"#d9ffff",ringColor:"#000000"},Li:{radius:1.28,atomColor:"#cc80ff",ringColor:"#000000"},Be:{radius:.96,atomColor:"#c2ff00",ringColor:"#000000"},B:{radius:.85,atomColor:"#ffb5b5",ringColor:"#000000"},C:{radius:.76,atomColor:"#000000",ringColor:"#ffffff"},N:{radius:.71,atomColor:"#3050f8",ringColor:"#ffffff"},O:{radius:.66,atomColor:"#ff0d0d",ringColor:"#ffffff"},F:{radius:.57,atomColor:"#90e050",ringColor:"#000000"},Ne:{radius:.58,atomColor:"#b3e3f5",ringColor:"#000000"},Na:{radius:1.66,atomColor:"#ab5cf2",ringColor:"#ffffff"},Mg:{radius:1.41,atomColor:"#8aff00",ringColor:"#000000"},Al:{radius:1.21,atomColor:"#bfa6a6",ringColor:"#000000"},Si:{radius:1.11,atomColor:"#f0c8a0",ringColor:"#000000"},P:{radius:1.07,atomColor:"#ff8000",ringColor:"#000000"},S:{radius:1.05,atomColor:"#ffff30",ringColor:"#000000"},Cl:{radius:1.02,atomColor:"#1ff01f",ringColor:"#000000"},Ar:{radius:1.06,atomColor:"#80d1e3",ringColor:"#000000"},K:{radius:2.03,atomColor:"#8f40d4",ringColor:"#ffffff"},Ca:{radius:1.76,atomColor:"#3dff00",ringColor:"#000000"},Sc:{radius:1.7,atomColor:"#e6e6e6",ringColor:"#000000"},Ti:{radius:1.6,atomColor:"#bfc2c7",ringColor:"#000000"},V:{radius:1.53,atomColor:"#a6a6ab",ringColor:"#000000"},Cr:{radius:1.39,atomColor:"#8a99c7",ringColor:"#000000"},Mn:{radius:1.39,atomColor:"#9c7ac7",ringColor:"#000000"},Fe:{radius:1.32,atomColor:"#e06633",ringColor:"#ffffff"},Co:{radius:1.26,atomColor:"#f090a0",ringColor:"#000000"},Ni:{radius:1.24,atomColor:"#50d050",ringColor:"#000000"},Cu:{radius:1.32,atomColor:"#c88033",ringColor:"#000000"},Zn:{radius:1.22,atomColor:"#7d80b0",ringColor:"#000000"},Ga:{radius:1.22,atomColor:"#c28f8f",ringColor:"#000000"},Ge:{radius:1.2,atomColor:"#668f8f",ringColor:"#000000"},As:{radius:1.19,atomColor:"#bd80e3",ringColor:"#000000"},Se:{radius:1.2,atomColor:"#ffa100",ringColor:"#000000"},Br:{radius:1.2,atomColor:"#a62929",ringColor:"#ffffff"},Kr:{radius:1.16,atomColor:"#5cb8d1",ringColor:"#000000"},Rb:{radius:2.2,atomColor:"#702eb0",ringColor:"#ffffff"},Sr:{radius:1.95,atomColor:"#00ff00",ringColor:"#000000"},Y:{radius:1.9,atomColor:"#94ffff",ringColor:"#000000"},Zr:{radius:1.75,atomColor:"#94e0e0",ringColor:"#000000"},Nb:{radius:1.64,atomColor:"#73c2c9",ringColor:"#000000"},Mo:{radius:1.54,atomColor:"#54b5b5",ringColor:"#000000"},Tc:{radius:1.47,atomColor:"#3b9e9e",ringColor:"#000000"},Ru:{radius:1.46,atomColor:"#248f8f",ringColor:"#000000"},Rh:{radius:1.42,atomColor:"#0a7d8c",ringColor:"#000000"},Pd:{radius:1.39,atomColor:"#006985",ringColor:"#ffffff"},Ag:{radius:1.45,atomColor:"#c0c0c0",ringColor:"#000000"},Cd:{radius:1.44,atomColor:"#ffd98f",ringColor:"#000000"},In:{radius:1.42,atomColor:"#a67573",ringColor:"#000000"},Sn:{radius:1.39,atomColor:"#668080",ringColor:"#000000"},Sb:{radius:1.39,atomColor:"#9e63b5",ringColor:"#ffffff"},Te:{radius:1.38,atomColor:"#d47a00",ringColor:"#000000"},I:{radius:1.39,atomColor:"#940094",ringColor:"#ffffff"},Xe:{radius:1.4,atomColor:"#429eb0",ringColor:"#000000"},Cs:{radius:2.44,atomColor:"#57178f",ringColor:"#ffffff"},Ba:{radius:2.15,atomColor:"#00c900",ringColor:"#000000"},La:{radius:2.07,atomColor:"#70d4ff",ringColor:"#000000"},Ce:{radius:2.04,atomColor:"#ffffc7",ringColor:"#000000"},Pr:{radius:2.03,atomColor:"#d9ffc7",ringColor:"#000000"},Nd:{radius:2.01,atomColor:"#c7ffc7",ringColor:"#000000"},Pm:{radius:1.99,atomColor:"#a3ffc7",ringColor:"#000000"},Sm:{radius:1.98,atomColor:"#8fffc7",ringColor:"#000000"},Eu:{radius:1.98,atomColor:"#61ffc7",ringColor:"#000000"},Gd:{radius:1.96,atomColor:"#45ffc7",ringColor:"#000000"},Tb:{radius:1.94,atomColor:"#30ffc7",ringColor:"#000000"},Dy:{radius:1.92,atomColor:"#1fffc7",ringColor:"#000000"},Ho:{radius:1.92,atomColor:"#00ff9c",ringColor:"#000000"},Er:{radius:1.89,atomColor:"#00e675",ringColor:"#000000"},Tm:{radius:1.9,atomColor:"#00d452",ringColor:"#000000"},Yb:{radius:1.87,atomColor:"#00bf38",ringColor:"#000000"},Lu:{radius:1.87,atomColor:"#00ab24",ringColor:"#000000"},Hf:{radius:1.75,atomColor:"#4dc2ff",ringColor:"#000000"},Ta:{radius:1.7,atomColor:"#4da6ff",ringColor:"#000000"},W:{radius:1.62,atomColor:"#2194d6",ringColor:"#000000"},Re:{radius:1.51,atomColor:"#267dab",ringColor:"#000000"},Os:{radius:1.44,atomColor:"#266696",ringColor:"#ffffff"},Ir:{radius:1.41,atomColor:"#175487",ringColor:"#ffffff"},Pt:{radius:1.36,atomColor:"#d0d0e0",ringColor:"#000000"},Au:{radius:1.36,atomColor:"#ffd123",ringColor:"#000000"},Hg:{radius:1.32,atomColor:"#b8b8d0",ringColor:"#000000"},Tl:{radius:1.45,atomColor:"#a6544d",ringColor:"#ffffff"},Pb:{radius:1.46,atomColor:"#575961",ringColor:"#ffffff"},Bi:{radius:1.48,atomColor:"#9e4fb5",ringColor:"#ffffff"},Po:{radius:1.4,atomColor:"#ab5c00",ringColor:"#ffffff"},At:{radius:1.5,atomColor:"#754f45",ringColor:"#ffffff"},Rn:{radius:1.5,atomColor:"#428296",ringColor:"#000000"},Fr:{radius:2.6,atomColor:"#420066",ringColor:"#ffffff"},Ra:{radius:2.21,atomColor:"#007d00",ringColor:"#000000"},Ac:{radius:2.15,atomColor:"#70abfa",ringColor:"#000000"},Th:{radius:2.06,atomColor:"#00baff",ringColor:"#000000"},Pa:{radius:2,atomColor:"#00a1ff",ringColor:"#000000"},U:{radius:1.96,atomColor:"#008fff",ringColor:"#000000"},Np:{radius:1.9,atomColor:"#0080ff",ringColor:"#000000"},Pu:{radius:1.87,atomColor:"#006bff",ringColor:"#ffffff"},Am:{radius:1.8,atomColor:"#545cf2",ringColor:"#ffffff"},Cm:{radius:1.69,atomColor:"#785ce3",ringColor:"#ffffff"},Bk:{radius:1.65,atomColor:"#8a4fe3",ringColor:"#ffffff"},Cf:{radius:1.81,atomColor:"#a136d4",ringColor:"#ffffff"}}};class F{constructor(t,e,o,s=[]){if(new.target===F)throw new TypeError("Cannot instantiate BaseFilter directly");this.MODES=Object.freeze(t),this.PREFERRED_FALLBACK_ORDER=Object.freeze(s),this.filterName=o,this._mode=null,this.mode=e}get requiresCameraUpdate(){return!1}get mode(){return this._mode}set mode(t){const e=t.toLowerCase().replace(/_/g,"-"),o=Object.values(this.MODES);if(!o.includes(e))throw new Error(`Invalid ${this.filterName} mode: "${t}". Valid modes are: ${o.join(", ")}`);this._mode=e}ensureValidMode(t){const e=this.getApplicableModes(t);e.includes(this.mode)||(this.mode=this.PREFERRED_FALLBACK_ORDER.find(o=>e.includes(o))||e[0])}apply(t){throw new Error('Method "apply" must be implemented by subclass')}getApplicableModes(t){throw new Error('Method "getApplicableModes" must be implemented by subclass')}cycleMode(t){const e=this.getApplicableModes(t);this.ensureValidMode(t);const o=e.indexOf(this._mode);return this._mode=e[(o+1)%e.length],this._mode}}g.create(g.all);const k=class k extends F{constructor(t=k.MODES.NONE){super(k.MODES,t,"HydrogenFilter",k.PREFERRED_FALLBACK_ORDER)}apply(t){this.ensureValidMode(t);const e=t.atoms.filter(i=>i.atomType!=="H"||this.mode!==k.MODES.NONE).map(i=>new Z(i.label,i.atomType,i.position,i.atomType==="H"&&this.mode===k.MODES.CONSTANT?null:i.adp,i.disorderGroup)),o=t.bonds.filter(i=>{if(this.mode===k.MODES.NONE){const r=t.getAtomByLabel(i.atom1Label),n=t.getAtomByLabel(i.atom2Label);return!(r.atomType==="H"||n.atomType==="H")}return!0}),s=this.mode===k.MODES.NONE?[]:t.hBonds;return new R(t.cell,e,o,s,t.symmetry)}getApplicableModes(t){const e=[k.MODES.NONE];return t.atoms.some(i=>i.atomType==="H")&&(e.push(k.MODES.CONSTANT),t.atoms.some(i=>{var r;return i.atomType==="H"&&((r=i.adp)==null?void 0:r.constructor.name)==="UAnisoADP"})&&e.push(k.MODES.ANISOTROPIC)),e}};L(k,"MODES",Object.freeze({NONE:"none",CONSTANT:"constant",ANISOTROPIC:"anisotropic"})),L(k,"PREFERRED_FALLBACK_ORDER",[k.MODES.ANISOTROPIC,k.MODES.CONSTANT,k.MODES.NONE]);let ot=k;const M=class M extends F{constructor(t=M.MODES.ALL){super(M.MODES,t,"DisorderFilter",M.PREFERRED_FALLBACK_ORDER)}apply(t){this.ensureValidMode(t);const e=t.atoms.filter(i=>!(this.mode===M.MODES.GROUP1&&i.disorderGroup>1||this.mode===M.MODES.GROUP2&&i.disorderGroup===1)),o=t.bonds.filter(i=>{const r=t.getAtomByLabel(i.atom1Label),n=t.getAtomByLabel(i.atom2Label);return!(this.mode===M.MODES.GROUP1&&(r.disorderGroup>1||n.disorderGroup>1)||this.mode===M.MODES.GROUP2&&(r.disorderGroup===1||n.disorderGroup===1))}),s=t.hBonds.filter(i=>{const r=t.getAtomByLabel(i.donorAtomLabel),n=t.getAtomByLabel(i.hydrogenAtomLabel),a=t.getAtomByLabel(i.acceptorAtomLabel);return!(this.mode===M.MODES.GROUP1&&(r.disorderGroup>1||n.disorderGroup>1||a.disorderGroup>1)||this.mode===M.MODES.GROUP2&&(r.disorderGroup===1||n.disorderGroup===1||a.disorderGroup===1))});return new R(t.cell,e,o,s,t.symmetry)}getApplicableModes(t){const e=[M.MODES.ALL];return t.atoms.some(s=>s.disorderGroup>0)&&(t.atoms.some(s=>s.disorderGroup===1)&&e.push(M.MODES.GROUP1),t.atoms.some(s=>s.disorderGroup>1)&&e.push(M.MODES.GROUP2)),e}};L(M,"MODES",Object.freeze({ALL:"all",GROUP1:"group1",GROUP2:"group2"})),L(M,"PREFERRED_FALLBACK_ORDER",[M.MODES.ALL,M.MODES.GROUP1,M.MODES.GROUP2]);let st=M;const w=class w extends F{constructor(t=w.MODES.BONDS_NO_HBONDS_NO){super(w.MODES,t,"SymmetryGrower",w.PREFERRED_FALLBACK_ORDER)}get requiresCameraUpdate(){return!0}static combineSymOpLabel(t,e){return!e||e==="."?t:`${t}@${e}`}findGrowableAtoms(t){const e=t.bonds.filter(({atom2SiteSymmetry:s})=>s&&s!==".").map(({atom2Label:s,atom2SiteSymmetry:i})=>[s,i]),o=t.hBonds.filter(({acceptorAtomSymmetry:s})=>s&&s!==".").map(({acceptorAtomLabel:s,acceptorAtomSymmetry:i})=>[s,i]);return{bondAtoms:e,hBondAtoms:o}}growAtomArray(t,e,o){for(const[s,i]of e){const r=w.combineSymOpLabel(s,i);if(o.labels.has(r))continue;const n=t.connectedGroups.find(l=>l.atoms.some(d=>d.label===s));if(!n)throw new Error(`Atom ${s} is not in any group. Typo or structure.recalculateConnectedGroups()?`);t.symmetry.applySymmetry(i,n.atoms).forEach(l=>{l.label=w.combineSymOpLabel(l.label,i),o.labels.add(l.label),o.atoms.add(l)}),n.bonds.filter(({atom2SiteSymmetry:l})=>l===".").forEach(l=>{o.bonds.add(new B(w.combineSymOpLabel(l.atom1Label,i),w.combineSymOpLabel(l.atom2Label,i),l.bondLength,l.bondLengthSU,"."))}),n.hBonds.filter(({acceptorAtomSymmetry:l})=>l===".").forEach(l=>{o.hBonds.add(new Y(w.combineSymOpLabel(l.donorAtomLabel,i),w.combineSymOpLabel(l.hydrogenAtomLabel,i),w.combineSymOpLabel(l.acceptorAtomLabel,i),l.donorHydrogenDistance,l.donorHydrogenDistanceSU,l.acceptorHydrogenDistance,l.acceptorHydrogenDistanceSU,l.donorAcceptorDistance,l.donorAcceptorDistanceSU,l.hBondAngle,l.hBondAngleSU,"."))})}return o}apply(t){this.ensureValidMode(t);const e=this.findGrowableAtoms(t),o={atoms:new Set(t.atoms),bonds:new Set(t.bonds),hBonds:new Set(t.hBonds),labels:new Set(t.atoms.map(({label:r})=>r))};this.mode.startsWith("bonds-yes")&&this.growAtomArray(t,e.bondAtoms,o),this.mode.includes("hbonds-yes")&&this.growAtomArray(t,e.hBondAtoms,o);const s=Array.from(o.atoms);for(const r of t.bonds){if(r.atom2SiteSymmetry===".")continue;const n=w.combineSymOpLabel(r.atom2Label,r.atom2SiteSymmetry);s.some(a=>a.label===n)&&o.bonds.add(new B(r.atom1Label,n,r.bondLength,r.bondLengthSU,"."))}for(const r of t.hBonds){if(r.acceptorAtomSymmetry===".")continue;const n=w.combineSymOpLabel(r.acceptorAtomLabel,r.acceptorAtomSymmetry);s.some(a=>a.label===n)&&o.hBonds.add(new Y(r.donorAtomLabel,r.hydrogenAtomLabel,n,r.donorHydrogenDistance,r.donorHydrogenDistanceSU,r.acceptorHydrogenDistance,r.acceptorHydrogenDistanceSU,r.donorAcceptorDistance,r.donorAcceptorDistanceSU,r.hBondAngle,r.hBondAngleSU,"."))}const i=Array.from(o.hBonds).filter(({acceptorAtomLabel:r,hydrogenAtomLabel:n,donorAtomLabel:a})=>{const l=o.labels.has(r),d=o.labels.has(n),m=o.labels.has(a);return l&&d&&m});return new R(t.cell,s,Array.from(o.bonds),i,t.symmetry)}getApplicableModes(t){const e=this.findGrowableAtoms(t),o=e.bondAtoms.length>0,s=e.hBondAtoms.length>0;return!o&&!s?[w.MODES.BONDS_NONE_HBONDS_NONE]:o?s?[w.MODES.BONDS_YES_HBONDS_YES,w.MODES.BONDS_YES_HBONDS_NO,w.MODES.BONDS_NO_HBONDS_NO]:[w.MODES.BONDS_YES_HBONDS_NONE,w.MODES.BONDS_NO_HBONDS_NONE]:[w.MODES.BONDS_NONE_HBONDS_YES,w.MODES.BONDS_NONE_HBONDS_NO]}};L(w,"MODES",Object.freeze({BONDS_YES_HBONDS_YES:"bonds-yes-hbonds-yes",BONDS_YES_HBONDS_NO:"bonds-yes-hbonds-no",BONDS_YES_HBONDS_NONE:"bonds-yes-hbonds-none",BONDS_NO_HBONDS_NO:"bonds-no-hbonds-no",BONDS_NO_HBONDS_NONE:"bonds-no-hbonds-none",BONDS_NONE_HBONDS_YES:"bonds-none-hbonds-yes",BONDS_NONE_HBONDS_NO:"bonds-none-hbonds-no",BONDS_NONE_HBONDS_NONE:"bonds-none-hbonds-none"})),L(w,"PREFERRED_FALLBACK_ORDER",[w.MODES.BONDS_NO_HBONDS_NO,w.MODES.BONDS_NO_HBONDS_NONE,w.MODES.BONDS_NONE_HBONDS_NO]);let W=w;function Wt(c){const t={position:0,rotation:0,scale:0,matrix:0};function e(o){const s=o.position,i=o.rotation,r=o.scale,n=o.matrix.elements;[s.x,s.y,s.z].some(isNaN)&&(console.log("pos"),console.log(s),console.log(o.userData),t.position++),[i.x,i.y,i.z].some(isNaN)&&(t.rotation++,console.log("rot"),console.log(i),console.log(o.userData)),[r.x,r.y,r.z].some(isNaN)&&(console.log("scale"),console.log(r),console.log(o.userData),t.scale++),n.some(isNaN)&&(t.matrix++,console.log("matrix"),console.log(n),console.log(o.userData));for(const a of o.children)e(a)}return e(c),t}function jt(c,t){const o=c.getEllipsoidMatrix(t).toArray();return new h.Matrix4(o[0][0],o[0][1],o[0][2],0,o[1][0],o[1][1],o[1][2],0,o[2][0],o[2][1],o[2][2],0,0,0,0,1)}function xt(c,t){const e=t.clone().sub(c),o=e.length();if(o===0)throw new Error("Error in ORTEP Bond Creation. Trying to create a zero length bond.");const s=e.divideScalar(o),i=new h.Vector3(0,1,0),r=new h.Vector3().crossVectors(s,i),n=-Math.acos(s.dot(i));return new h.Matrix4().makeScale(1,o,1).premultiply(new h.Matrix4().makeRotationAxis(r.normalize(),n)).setPosition(c.clone().add(t).multiplyScalar(.5))}class Kt{constructor(t={}){const e=t||{};this.options={...b,...e,elementProperties:{...b.elementProperties,...e.elementProperties||{}}},this.scaling=1.5384,this.geometries={},this.materials={},this.elementMaterials={},this.initializeGeometries(),this.initializeMaterials()}initializeGeometries(){this.geometries.atom=new h.IcosahedronGeometry(this.scaling,this.options.atomDetail),this.geometries.adpRing=this.createADPHalfTorus(),this.geometries.bond=new h.CylinderGeometry(this.options.bondRadius,this.options.bondRadius,.98,this.options.bondSections,1,!0),this.geometries.hbond=new h.CylinderGeometry(this.options.hbondRadius,this.options.hbondRadius,.98,this.options.bondSections,1,!0)}initializeMaterials(){this.materials.bond=new h.MeshStandardMaterial({color:this.options.bondColor,roughness:this.options.bondColorRoughness,metalness:this.options.bondColorMetalness}),this.materials.hbond=new h.MeshStandardMaterial({color:this.options.hbondColor,roughness:this.options.hbondColorRoughness,metalness:this.options.hbondColorMetalness})}validateElementType(t){if(!this.options.elementProperties[t])throw new Error(`Unknown element type: ${t}. Please ensure element properties are defined.Pass the type settings as custom options, ifthey are element from periodic table`)}getAtomMaterials(t){let e=t;this.options.elementProperties[e]||(e=et(t)),this.validateElementType(e);const o=`${e}_materials`;if(!this.elementMaterials[o]){const s=this.options.elementProperties[e],i=new h.MeshStandardMaterial({color:s.atomColor,roughness:this.options.atomColorRoughness,metalness:this.options.atomColorMetalness}),r=new h.MeshStandardMaterial({color:s.ringColor,roughness:this.options.atomColorRoughness,metalness:this.options.atomColorMetalness});this.elementMaterials[o]=[i,r]}return this.elementMaterials[o]}createADPHalfTorus(){const t=new h.TorusGeometry(this.scaling*this.options.atomADPRingWidthFactor,this.options.atomADPRingHeight,this.options.atomADPInnerSections,this.options.atomADPRingSections),e=t.attributes.position.array,o=t.index.array,s=[],i=[],r=new Set;for(let d=0;d<o.length;d+=3){const m=o[d]*3,f=o[d+1]*3,y=o[d+2]*3,p=[m,f,y].map(_=>({index:_/3,distance:Math.sqrt(e[_]*e[_]+e[_+1]*e[_+1]+e[_+2]*e[_+2])}));p.some(_=>_.distance>=this.scaling)&&p.forEach(_=>r.add(o[d+_.index%3]))}const n=new Map;let a=0;r.forEach(d=>{const m=d*3;s.push(e[m],e[m+1],e[m+2]),n.set(d,a++)});for(let d=0;d<o.length;d+=3)r.has(o[d])&&r.has(o[d+1])&&r.has(o[d+2])&&i.push(n.get(o[d]),n.get(o[d+1]),n.get(o[d+2]));const l=new h.BufferGeometry;return l.setAttribute("position",new h.Float32BufferAttribute(s,3)),l.setIndex(i),l.computeVertexNormals(),l.rotateX(.5*Math.PI),t.dispose(),l}dispose(){Object.values(this.geometries).forEach(t=>t.dispose()),Object.values(this.materials).forEach(t=>t.dispose()),Object.values(this.elementMaterials).forEach(([t,e])=>{t.dispose(),e.dispose()})}}class At{constructor(t,e={}){const o=e||{},s={...b.elementProperties};o.elementProperties&&Object.entries(o.elementProperties).forEach(([i,r])=>{s[i]={...s[i],...r}}),this.options={...b,...o,elementProperties:s},this.crystalStructure=t,this.cache=new Kt(this.options),this.createStructure()}createStructure(){this.atoms3D=[],this.bonds3D=[],this.hBonds3D=[];const t=this.crystalStructure.atoms.map(s=>s.label);for(const s of this.crystalStructure.atoms){const[i,r]=this.cache.getAtomMaterials(s.atomType);s.adp instanceof V?this.atoms3D.push(new Xt(s,this.crystalStructure.cell,this.cache.geometries.atom,i,this.cache.geometries.adpRing,r)):s.adp instanceof $?this.atoms3D.push(new Zt(s,this.crystalStructure.cell,this.cache.geometries.atom,i)):this.atoms3D.push(new Jt(s,this.crystalStructure.cell,this.cache.geometries.atom,i,this.options))}const e=this.crystalStructure.bonds.map(s=>new B(s.atom1Label,W.combineSymOpLabel(s.atom2Label,s.atom2SiteSymmetry),s.bondLength,s.bondLengthSU,".")).filter(s=>t.includes(s.atom2Label));for(const s of e)try{this.bonds3D.push(new Qt(s,this.crystalStructure,this.cache.geometries.bond,this.cache.materials.bond))}catch(i){if(i.message!=="Error in ORTEP Bond Creation. Trying to create a zero length bond.")throw i}const o=this.crystalStructure.hBonds.map(s=>new Y(s.donorAtomLabel,s.hydrogenAtomLabel,W.combineSymOpLabel(s.acceptorAtomLabel,s.acceptorAtomSymmetry),s.donorHydrogenDistance,s.donorHydrogenDistanceSU,s.acceptorHydrogenDistance,s.acceptorHydrogenDistanceSU,s.donorAcceptorDistance,s.donorAcceptorDistanceSU,s.hBondAngle,s.hBondAngleSU,".")).filter(s=>t.includes(s.acceptorAtomLabel));for(const s of o)try{this.hBonds3D.push(new te(s,this.crystalStructure,this.cache.geometries.hbond,this.cache.materials.hbond,this.options.hbondDashSegmentLength,this.options.hbondDashFraction))}catch(i){if(i.message!=="Error in ORTEP Bond Creation. Trying to create a zero length bond.")throw i}}getGroup(){const t=new h.Group;for(const e of this.atoms3D)t.add(e);for(const e of this.bonds3D)t.add(e);for(const e of this.hBonds3D)t.add(e);return Wt(t),t}dispose(){this.cache.dispose()}}class it extends h.Mesh{constructor(t,e){if(new.target===it)throw new TypeError("ORTEPObject is an abstract class and cannot be instantiated directly.");super(t,e),this._selectionColor=null,this.marker=null}get selectionColor(){return this._selectionColor}createSelectionMaterial(t){return new h.MeshBasicMaterial({color:t,transparent:!0,opacity:.9,side:h.BackSide})}select(t,e){var i;this._selectionColor=t;const o=this.material.clone();(i=o.emissive)==null||i.setHex(e.selection.highlightEmissive),this.originalMaterial=this.material,this.material=o;const s=this.createSelectionMarker(t,e);this.add(s),this.marker=s}deselect(){this._selectionColor=null,this.removeSelectionMarker()}createSelectionMarker(t,e){throw new Error("createSelectionMarker needs to be implemented in a subclass")}removeSelectionMarker(){var t,e;this.marker&&(this.remove(this.marker),(t=this.marker.geometry)==null||t.dispose(),(e=this.marker.material)==null||e.dispose(),this.marker=null),this.originalMaterial&&(this.material.dispose(),this.material=this.originalMaterial,this.originalMaterial=null)}dispose(){var t,e;this.deselect(),(t=this.geometry)==null||t.dispose(),(e=this.material)==null||e.dispose()}}class dt extends it{constructor(t,e,o,s){super(o,s);const i=new h.Vector3(...t.position.toCartesian(e));this.position.copy(i),this.userData={type:"atom",atomData:t,selectable:!0}}createSelectionMarker(t,e){const o=new h.Mesh(this.geometry,this.createSelectionMaterial(t));return o.scale.multiplyScalar(e.selection.markerMult),o.userData.selectable=!1,o}}class Xt extends dt{constructor(t,e,o,s,i,r){if(super(t,e,o,s),[t.adp.u11,t.adp.u3,t.adp.u33].some(a=>a<=0))this.geometry=new h.TetrahedronGeometry(.8);else{const a=jt(t.adp,e);if(a.toArray().includes(NaN))this.geometry=new h.TetrahedronGeometry(.8);else{for(const l of this.adpRingMatrices){const d=new h.Mesh(i,r);d.applyMatrix4(l),d.userData.selectable=!1,this.add(d)}this.applyMatrix4(a)}}const n=new h.Vector3(...t.position.toCartesian(e));this.position.copy(n),this.userData={type:"atom",atomData:t,selectable:!0}}get adpRingMatrices(){return[new h.Matrix4().set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),new h.Matrix4().set(1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1),new h.Matrix4().set(0,-1,0,0,1,0,0,0,0,0,1,0,0,0,0,1)]}}class Zt extends dt{constructor(t,e,o,s){if(super(t,e,o,s),!t.adp||!("uiso"in t.adp))throw new Error("Atom must have isotropic displacement parameters (UIsoADP)");t.adp.uiso<=0?this.geometry=new h.TetrahedronGeometry(1):this.scale.multiplyScalar(Math.sqrt(t.adp.uiso))}}class Jt extends dt{constructor(t,e,o,s,i){super(t,e,o,s);let r=t.atomType;try{i.elementProperties[r]||(r=et(t.atomType))}catch{throw new Error(`Element properties not found for atom type: '${t.atomType}'`)}this.scale.multiplyScalar(i.atomConstantRadiusMultiplier*i.elementProperties[r].radius)}}class Qt extends it{constructor(t,e,o,s){super(o,s);const i=e.getAtomByLabel(t.atom1Label),r=e.getAtomByLabel(t.atom2Label),n=new h.Vector3(...i.position.toCartesian(e.cell)),a=new h.Vector3(...r.position.toCartesian(e.cell)),l=xt(n,a);this.applyMatrix4(l),this.userData={type:"bond",bondData:t,selectable:!0}}createSelectionMarker(t,e){const o=new h.Mesh(this.geometry,this.createSelectionMaterial(t));return o.scale.x*=e.selection.bondMarkerMult,o.scale.z*=e.selection.bondMarkerMult,o.userData.selectable=!1,o}}class ht extends h.Group{constructor(){if(new.target===ht)throw new TypeError("ORTEPGroupObject is an abstract class and cannot be instantiated directly.");super(),this._selectionColor=null,this.marker=null}get selectionColor(){return this._selectionColor}add(...t){return t.forEach(e=>{if(e instanceof h.Mesh){const o=e.raycast;e.raycast=(s,i)=>{const r=[];if(o.call(e,s,r),r.length>0){const n=r[0];i.push({distance:n.distance,point:n.point,object:this,face:n.face,faceIndex:n.faceIndex,uv:n.uv})}}}}),super.add(...t)}createSelectionMaterial(t){return new h.MeshBasicMaterial({color:t,transparent:!0,opacity:.9,side:h.BackSide})}select(t,e){this._selectionColor=t,this.traverse(s=>{var i;if(s instanceof h.Mesh){const r=s.material.clone();(i=r.emissive)==null||i.setHex(e.selection.highlightEmissive),s.originalMaterial=s.material,s.material=r}});const o=this.createSelectionMarker(t,e);this.add(o),this.marker=o}deselect(){this._selectionColor=null,this.marker&&(this.remove(this.marker),this.marker.traverse(t=>{var e,o;t instanceof h.Mesh&&((e=t.geometry)==null||e.dispose(),(o=t.material)==null||o.dispose())}),this.marker=null),this.traverse(t=>{t instanceof h.Mesh&&t.originalMaterial&&(t.material.dispose(),t.material=t.originalMaterial,t.originalMaterial=null)})}createSelectionMarker(t,e){throw new Error("createSelectionMarker needs to be implemented in a subclass")}dispose(){this.marker&&this.deselect(),this.traverse(t=>{var e,o;t instanceof h.Mesh&&((e=t.geometry)==null||e.dispose(),(o=t.material)==null||o.dispose())}),this.clear()}}class te extends ht{constructor(t,e,o,s,i,r){super(),this.userData={type:"hbond",hbondData:t,selectable:!0};const n=e.getAtomByLabel(t.hydrogenAtomLabel),a=e.getAtomByLabel(t.acceptorAtomLabel),l=new h.Vector3(...n.position.toCartesian(e.cell)),d=new h.Vector3(...a.position.toCartesian(e.cell));this.createDashedBondSegments(l,d,o,s,i,r)}createDashedBondSegments(t,e,o,s,i,r){const n=t.distanceTo(e),a=Math.max(1,Math.floor(n/i)),d=n/a*r;for(let m=0;m<a;m++){const f=m/a,y=f+d/n,p=new h.Vector3().lerpVectors(t,e,f),_=new h.Vector3().lerpVectors(t,e,y),P=new h.Mesh(o,s.clone());P.applyMatrix4(xt(p,_)),P.userData=this.userData,this.add(P)}}createSelectionMarker(t,e){const o=new h.Group,s=this.createSelectionMaterial(t);return this.children.forEach(i=>{const r=new h.Mesh(i.geometry,s);r.applyMatrix4(i.matrix),r.scale.x*=e.selection.bondMarkerMult,r.scale.y*=.8*e.selection.bondMarkerMult,r.scale.z*=e.selection.bondMarkerMult,r.userData.selectable=!1,o.add(r)}),o}}function Ot(c,t,e=4){if(!isFinite(1/t))return mt(c,e).toFixed(e);let o=Math.floor(Math.log10(t));t*Math.pow(10,-o)<2&&(o-=1);const s=mt(c,-o);if(o<0){const r=Math.round(t/Math.pow(10,o));return`${s.toFixed(-o)}(${r})`}const i=mt(t,o);return`${s}(${i})`}function mt(c,t){const e=Math.pow(10,t);return Math.round(c*e)/e}function Nt(c,t=!0){if(!c||typeof c!="string")throw new Error("Empty atom label");let e=c.toUpperCase().replace(/[()[\]{}]/g,"");if(t&&(e=e.replace(/\^[a-zA-Z1-9]+$/,"").replace(/_[a-zA-Z1-9]+$/,"").replace(/_\$\d+$/,"")),e==="")throw new Error(`Label "${c}" normalizes to empty string`);return e}function ee(c,t=!0){const e=new Map;c.forEach(s=>{try{const i=Nt(s,t);e.has(i)||e.set(i,[]),e.get(i).push(s)}catch(i){console.warn(`Skipping invalid label: ${i.message}`)}});const o=new Map;for(const[s,i]of e.entries())i.length===1?o.set(s,i[0]):console.warn(`Multiple labels map to ${s}: ${i.join(", ")}. Skipping mapping.`);return o}function j(c,t,e,o=!0){const s=ee(e,o),r=c.get(t).map(n=>{const a=Nt(n,o);return s.has(a)?s.get(a):n});c.data[t]=r}function oe(c){if(!c||c===".")return".";const t=String(c).trim();if(/^\d+_\d{3}$/.test(t))return t;const e=t.match(/^-?([^\s\-_.]+)[\s-.](\d{3})$/);if(e){const o=e[1],s=e[2];return e[0].startsWith("-")?`-${o}_${s}`:`${o}_${s}`}if(/^\d{5,6}$/.test(t)){const o=t.slice(0,3),s=t.slice(-3),i=Array.from(o).map(n=>Math.abs(parseInt(n)-5)).reduce((n,a)=>n+a,0),r=Array.from(s).map(n=>Math.abs(parseInt(n)-5)).reduce((n,a)=>n+a,0);return i<r?`${parseInt(t.slice(3))}_${o}`:`${parseInt(t.slice(0,-4))}_${s}`}return c}function ft(c,t){const o=c.get(t).map(s=>oe(s));c.data[t]=o}function I(c,t){for(const e of t)if(c.headerLines.includes(e))return e;return null}function Lt(c,t=!0,e=!0,o=!0){let s;if((t||e)&&(s=c.get("_atom_site").get(["_atom_site.label","_atom_site_label"])),t){const i=c.get("_atom_site_aniso",!1);if(i){const r=I(i,["_atom_site_aniso.label","_atom_site_aniso_label"]);r&&j(i,r,s)}}if(e||o){const i=c.get("_geom_bond",!1);if(i){if(e){const n=I(i,["_geom_bond.atom_site_label_1","_geom_bond_atom_site_label_1"]);j(i,n,s);const a=I(i,["_geom_bond.atom_site_label_2","_geom_bond_atom_site_label_2"]);j(i,a,s)}if(o){const n=I(i,["_geom_bond.site_symmetry_1","_geom_bond_site_symmetry_1"]);n&&ft(i,n);const a=I(i,["_geom_bond.site_symmetry_2","_geom_bond_site_symmetry_2"]);a&&ft(i,a)}}const r=c.get("_geom_hbond",!1);if(r){if(e){const n=I(r,["_geom_hbond.atom_site_label_d","_geom_hbond_atom_site_label_D"]);j(r,n,s);const a=I(r,["_geom_hbond.atom_site_label_h","_geom_hbond_atom_site_label_H"]);a&&j(r,a,s);const l=I(r,["_geom_hbond.atom_site_label_a","_geom_hbond_atom_site_label_A"]);j(r,l,s)}if(o){const n=I(r,["_geom_hbond.site_symmetry_a","_geom_hbond_site_symmetry_A"]);n&&ft(r,n)}}}}const z=g.create(g.all),U=class U extends F{constructor(t=[],e=U.MODES.OFF){super(U.MODES,e,"AtomLabelFilter",[]),this.setFilteredLabels(t)}get requiresCameraUpdate(){return!0}_parseRangeExpression(t,e){const[o,s]=t.split(">").map(n=>n.trim());if(!o||!s)return console.warn(`Invalid range expression: ${t}`),[];if(!e.includes(o))throw new Error(`Range filtering included unknown start label: ${o}`);if(!e.includes(s))throw new Error(`Range filtering included unknown end label: ${s}`);const i=e.indexOf(o),r=e.indexOf(s);return e.slice(i,r+1)}setFilteredLabels(t){let e=[];typeof t=="string"?e=t.split(",").map(o=>o.trim()).filter(o=>o):Array.isArray(t)&&(e=t),this.filteredLabels=new Set(e)}_expandRanges(t){const e=t.atoms.map(s=>s.label),o=new Set;for(const s of this.filteredLabels)s.includes(">")&&!e.includes(s)?this._parseRangeExpression(s,e).forEach(r=>o.add(r)):o.add(s);return o}apply(t){if(this.mode===U.MODES.OFF)return t;const e=this._expandRanges(t),o=t.atoms.filter(r=>!e.has(r.label)),s=t.bonds.filter(r=>!e.has(r.atom1Label)&&!e.has(r.atom2Label)),i=t.hBonds.filter(r=>!e.has(r.donorAtomLabel)&&!e.has(r.hydrogenAtomLabel)&&!e.has(r.acceptorAtomLabel));return new R(t.cell,o,s,i,t.symmetry)}getApplicableModes(){return Object.values(U.MODES)}};L(U,"MODES",Object.freeze({ON:"on",OFF:"off"}));let rt=U;const C=class C extends F{constructor(t,e,o=C.MODES.KEEP){super(C.MODES,o,"BondGenerator",C.PREFERRED_FALLBACK_ORDER),this.elementProperties=t,this.toleranceFactor=e}getMaxBondDistance(t,e,o){var r,n;const s=(r=o[t])==null?void 0:r.radius,i=(n=o[e])==null?void 0:n.radius;if(!s||!i)throw new Error(`Missing radius for element ${s?e:t}`);return(s+i)*this.toleranceFactor}generateBonds(t,e){const o=new Set,{cell:s,atoms:i}=t,r=new Map,n=new Map;i.forEach(a=>{const l=a.position.toCartesian(s);if(r.set(a.label,[l.x,l.y,l.z]),Object.prototype.hasOwnProperty.call(e,a.atomType)&&!n.has(a.atomType))n.set(a.atomType,a.atomType);else if(!n.has(a.atomType))try{n.set(a.atomType,et(a.atomType))}catch{throw new Error(`Missing radius for element ${a.atomType}`)}});for(let a=0;a<i.length;a++){const l=i[a],d=r.get(l.label);for(let m=a+1;m<i.length;m++){const f=i[m],y=r.get(f.label);if((l.atomType==="H"||f.atomType==="H")&&t.bonds.some(K=>K.atom1Label===l.label||K.atom1Label===f.label||K.atom2Label===l.label||K.atom2Label===f.label))continue;const p=z.subtract(d,y),_=z.norm(p),P=this.getMaxBondDistance(n.get(l.atomType),n.get(f.atomType),e);_<=P&&_>1e-4&&o.add(new B(l.label,f.label,_,null,"."))}}return o}apply(t){this.ensureValidMode(t);let e;switch(this.mode){case C.MODES.KEEP:return t;case C.MODES.ADD:{const o=this.generateBonds(t,this.elementProperties);e=[...t.bonds,...o];break}case C.MODES.REPLACE:e=[...this.generateBonds(t,this.elementProperties)];break;case C.MODES.CREATE:e=[...this.generateBonds(t,this.elementProperties)];break;case C.MODES.IGNORE:e=[...t.bonds];break;default:return t}return new R(t.cell,t.atoms,e,t.hBonds,t.symmetry)}getApplicableModes(t){return t.bonds.length>0?[C.MODES.KEEP,C.MODES.ADD,C.MODES.REPLACE]:[C.MODES.CREATE,C.MODES.IGNORE]}};L(C,"MODES",Object.freeze({KEEP:"keep",ADD:"add",REPLACE:"replace",CREATE:"create",IGNORE:"ignore"})),L(C,"PREFERRED_FALLBACK_ORDER",[C.MODES.KEEP,C.MODES.ADD,C.MODES.REPLACE,C.MODES.CREATE,C.MODES.IGNORE]);let nt=C;const A=class A extends F{constructor(t=A.MODES.OFF,e=1.1){super(A.MODES,t,"IsolatedHydrogenFixer",A.PREFERRED_FALLBACK_ORDER),this.maxBondDistance=e}apply(t){if(this.ensureValidMode(t),this.mode===A.MODES.OFF)return t;const e=this.findIsolatedHydrogenAtoms(t);if(e.length===0)return t;const o=this.createBondsForIsolatedHydrogens(t,e);return new R(t.cell,t.atoms,[...t.bonds,...o],t.hBonds,t.symmetry)}findIsolatedHydrogenAtoms(t){const e=[];return t.connectedGroups.forEach(o=>{if(o.atoms.length===1&&o.atoms[0].atomType==="H"){const s=o.atoms[0],i=t.atoms.findIndex(r=>r.label===s.label);e.push({atom:s,atomIndex:i})}}),e}createBondsForIsolatedHydrogens(t,e){const o=[];return e.forEach(({atom:s,atomIndex:i})=>{const r=s.position.toCartesian(t.cell),n=[r.x,r.y,r.z];if(i>0){const l=t.atoms[i-1];if(l.atomType!=="H"&&(l.disorderGroup===s.disorderGroup||l.disorderGroup===0||s.disorderGroup===0)){const d=l.position.toCartesian(t.cell),m=[d.x,d.y,d.z],f=z.subtract(n,m),y=z.norm(f);if(y<=this.maxBondDistance){o.push(new B(l.label,s.label,y,null,"."));return}}}let a=!1;for(let l=i-1;l>=0&&!a;l--){const d=t.atoms[l];if(d.atomType==="H"||!(d.disorderGroup===s.disorderGroup||d.disorderGroup===0||s.disorderGroup===0))continue;const m=d.position.toCartesian(t.cell),f=[m.x,m.y,m.z],y=z.subtract(n,f),p=z.norm(y);p<=this.maxBondDistance&&(o.push(new B(d.label,s.label,p,null,".")),a=!0)}if(!a&&i<t.atoms.length-1)for(let l=i+1;l<t.atoms.length&&!a;l++){const d=t.atoms[l];if(d.atomType==="H"||!(d.disorderGroup===s.disorderGroup||d.disorderGroup===0||s.disorderGroup===0))continue;const m=d.position.toCartesian(t.cell),f=[m.x,m.y,m.z],y=z.subtract(n,f),p=z.norm(y);p<=this.maxBondDistance&&(o.push(new B(d.label,s.label,p,null,".")),a=!0)}}),o}getApplicableModes(t){return t.bonds.length===0?[A.MODES.OFF]:t.connectedGroups.some(o=>o.atoms.length===1&&o.atoms[0].atomType==="H")?[A.MODES.ON]:[A.MODES.OFF]}};L(A,"MODES",Object.freeze({ON:"on",OFF:"off"})),L(A,"PREFERRED_FALLBACK_ORDER",[A.MODES.ON,A.MODES.OFF]);let pt=A;const ut=g.create(g.all,{});function se(c){const t=new h.Vector3;c.forEach(l=>t.add(l)),t.divideScalar(c.length);const e=new h.Matrix3,o=new h.Vector3;c.forEach(l=>{o.copy(l).sub(t),e.elements[0]+=o.x*o.x,e.elements[1]+=o.x*o.y,e.elements[2]+=o.x*o.z,e.elements[3]+=o.y*o.x,e.elements[4]+=o.y*o.y,e.elements[5]+=o.y*o.z,e.elements[6]+=o.z*o.x,e.elements[7]+=o.z*o.y,e.elements[8]+=o.z*o.z});const{values:s,eigenvectors:i}=ut.eigs(ie(e)),r=ut.min(s);if(r<=0)return console.warn("Could not find a mean plane, expected?"),new h.Vector3(0,1,0);const n=i.filter(l=>l.value===r)[0].vector,a=new h.Vector3(...n.toArray());return a.normalize(),a}function ie(c){const t=c.elements;return ut.matrix([[t[0],t[1],t[2]],[t[3],t[4],t[5]],[t[6],t[7],t[8]]])}function re(c,t){const e=new h.Box3().setFromObject(c);if(e.isEmpty())return 10;const o=new h.Vector3;e.getSize(o);const s=t.fov*Math.PI/180,i=Math.atan(t.aspect*Math.tan(s/2)*2);return o.x/o.y<=t.aspect?o.y/2/Math.tan(s/2)+o.z/2:o.x/2/Math.tan(i/2)+o.z/2}function ne(c){const t=[],e=new h.Vector3;if(c.traverse(p=>{var _;((_=p.userData)==null?void 0:_.type)==="atom"&&(t.push(p.position.clone()),e.add(p.position))}),t.length===0)return null;e.divideScalar(t.length);const o=t.map(p=>p.sub(e)),s=se(o),i=new h.Vector3(0,0,1),r=new h.Quaternion;r.setFromUnitVectors(s,i);const n=new h.Matrix4;n.makeRotationFromQuaternion(r);const a=o.map(p=>p.clone().applyMatrix4(n));let l=0,d=0;a.forEach((p,_)=>{const P=Math.sqrt(p.x*p.x+p.y*p.y);P>l&&(l=P,d=_)});const m=new h.Vector2(a[d].x,a[d].y);m.x<0&&m.multiplyScalar(-1);const f=-Math.atan2(m.y,m.x),y=new h.Matrix4().makeRotationZ(f);return n.premultiply(y),n.premultiply(new h.Matrix4().makeRotationX(Math.PI/8)),n.premultiply(new h.Matrix4().makeRotationY(Math.PI/48)),n}function ae(c,t){c.children=c.children.filter(n=>!(n instanceof h.Light));let e=6;t.traverse(n=>{var a;((a=n.userData)==null?void 0:a.type)==="atom"&&n.position.length()>e&&(e=n.position.length())});const o=e*2,s=new h.AmbientLight(16777215,1);c.add(s);const i=new h.SpotLight(16777215,1e3,0,Math.PI*.27,.6);i.position.set(0,-.5,o*2),i.lookAt(new h.Vector3(0,0,0)),c.add(i),[{pos:[-1,-.5,1],intensity:.4},{pos:[1,-.5,1],intensity:.4},{pos:[0,-.5,1],intensity:.3}].forEach(({pos:n,intensity:a})=>{const l=new h.DirectionalLight(16777215,a);l.position.set(n[0]*o,n[1]*o,n[2]*o),l.lookAt(new h.Vector3(0,0,0)),c.add(l)})}class le{constructor(t){this.viewer=t,this.state={isDragging:!1,isPanning:!1,mouse:new h.Vector2,lastClickTime:0,clickStartTime:0,pinchStartDistance:0,lastTouchRotation:0,lastRightClickTime:0,twoFingerStartPos:new h.Vector2,initialCameraPosition:t.camera.position.clone()};const{container:e,camera:o,renderer:s,moleculeContainer:i,options:r}=t;this.container=e,this.camera=o,this.renderer=s,this.moleculeContainer=i,this.options=r,this.doubleClickDelay=300,this.raycaster=new h.Raycaster,this.raycaster.near=.1,this.raycaster.far=100,this.bindEventHandlers(),this.setupEventListeners()}bindEventHandlers(){this.boundHandlers={wheel:this.handleWheel.bind(this),mouseDown:this.handleMouseDown.bind(this),mouseMove:this.handleMouseMove.bind(this),mouseUp:this.handleMouseUp.bind(this),click:this.handleClick.bind(this),contextMenu:this.handleContextMenu.bind(this),touchStart:this.handleTouchStart.bind(this),touchMove:this.handleTouchMove.bind(this),touchEnd:this.handleTouchEnd.bind(this),resize:this.handleResize.bind(this)}}setupEventListeners(){const t=this.renderer.domElement,{wheel:e,mouseDown:o,mouseMove:s,mouseUp:i,click:r,contextMenu:n,touchStart:a,touchMove:l,touchEnd:d,resize:m}=this.boundHandlers;t.addEventListener("wheel",e,{passive:!1}),t.addEventListener("mousedown",o),t.addEventListener("mousemove",s),t.addEventListener("mouseup",i),t.addEventListener("mouseleave",i),t.addEventListener("click",r),t.addEventListener("contextmenu",n),t.addEventListener("touchstart",a,{passive:!1}),t.addEventListener("touchmove",l,{passive:!1}),t.addEventListener("touchend",d),window.addEventListener("resize",m)}clientToMouseCoordinates(t,e){const o=this.container.getBoundingClientRect();return new h.Vector2((t-o.left)/o.width*2-1,-((e-o.top)/o.height)*2+1)}updateMouseCoordinates(t,e){const o=this.clientToMouseCoordinates(t,e);this.state.mouse.x=o.x,this.state.mouse.y=o.y}handleSelection(t,e){this.updateMouseCoordinates(t.clientX,t.clientY),this.raycaster.setFromCamera(this.state.mouse,this.camera);const o=[];this.moleculeContainer.traverse(i=>{var r;(r=i.userData)!=null&&r.selectable&&o.push(i)});const s=this.raycaster.intersectObjects(o).filter(i=>{var r;return(r=i.object.userData)==null?void 0:r.selectable});s.length>0?this.viewer.selections.handle(s[0].object):e<this.doubleClickDelay&&this.viewer.selections.clear(),this.viewer.requestRender()}handleMouseClick(t,e){const o=this.options.interaction.mouseRaycast;this.raycaster.params.Line.threshold=o.lineThreshold,this.raycaster.params.Points.threshold=o.pointsThreshold,this.raycaster.params.Mesh.threshold=o.meshThreshold,this.handleSelection(t,e)}handleTouchSelect(t,e){const o=this.options.interaction.touchRaycast;this.raycaster.params.Line.threshold=o.lineThreshold,this.raycaster.params.Points.threshold=o.pointsThreshold,this.raycaster.params.Mesh.threshold=o.meshThreshold,this.handleSelection(t,e)}rotateStructure(t){const e=this.options.interaction.rotationSpeed,o=new h.Vector3(1,0,0),s=new h.Vector3(0,1,0);this.moleculeContainer.applyMatrix4(new h.Matrix4().makeRotationAxis(s,t.x*e)),this.moleculeContainer.applyMatrix4(new h.Matrix4().makeRotationAxis(o,-t.y*e)),this.viewer.requestRender()}handleZoom(t){const{minDistance:e,maxDistance:o}=this.options.camera,s=o-e,i=this.camera.position.length(),r=h.MathUtils.clamp(i+t*s,e,o),n=this.camera.position.clone().normalize();this.camera.position.copy(n.multiplyScalar(r)),this.viewer.requestRender()}resetCameraPosition(){this.camera.position.x=this.state.initialCameraPosition.x,this.camera.position.y=this.state.initialCameraPosition.y,this.camera.rotation.set(0,0,0),this.viewer.requestRender()}panCamera(t){const e=this.camera.position.z,o=this.camera.fov*Math.PI/180,s=Math.tan(o/2)*e,i=s*this.camera.aspect,r=-t.x*i,n=-t.y*s,a=new h.Vector3,l=new h.Vector3;this.camera.matrix.extractBasis(a,l,new h.Vector3),this.camera.position.addScaledVector(a,r),this.camera.position.addScaledVector(l,n),this.viewer.requestRender()}handleTouchStart(t){t.preventDefault();const e=t.touches;if(e.length===1&&!this.state.isDragging)this.state.isDragging=!0,this.state.clickStartTime=Date.now(),this.updateMouseCoordinates(e[0].clientX,e[0].clientY);else if(e.length===2){if(!this.state.isDragging){const o=e[0].clientX-e[1].clientX,s=e[0].clientY-e[1].clientY;this.state.pinchStartDistance=Math.hypot(o,s);const i=this.clientToMouseCoordinates((e[0].clientX+e[1].clientX)/2,(e[0].clientY+e[1].clientY)/2);this.state.twoFingerStartPos.copy(i)}this.state.isDragging=!1}}handleTouchMove(t){t.preventDefault();const e=t.touches;if(e.length===1&&this.state.isDragging){const o=e[0],s=this.clientToMouseCoordinates(o.clientX,o.clientY),i=new h.Vector2(s.x-this.state.mouse.x,s.y-this.state.mouse.y);this.rotateStructure(i),this.state.mouse.set(s.x,s.y)}else if(e.length===2){const o=e[0].clientX-e[1].clientX,s=e[0].clientY-e[1].clientY,i=Math.hypot(o,s);if(!this.state.pinchStartDistance){this.state.pinchStartDistance=i;const a=this.clientToMouseCoordinates((e[0].clientX+e[1].clientX)/2,(e[0].clientY+e[1].clientY)/2);this.state.twoFingerStartPos.copy(a);return}this.handleZoom((this.state.pinchStartDistance-i)*this.options.camera.pinchZoomSpeed),this.state.pinchStartDistance=i;const r=this.clientToMouseCoordinates((e[0].clientX+e[1].clientX)/2,(e[0].clientY+e[1].clientY)/2),n=r.clone().sub(this.state.twoFingerStartPos);this.panCamera(n),this.state.twoFingerStartPos.copy(r)}}handleTouchEnd(t){if(t.cancelable&&t.preventDefault(),t.touches.length===0&&t.changedTouches.length>0){if(Date.now()-this.state.clickStartTime<this.options.interaction.clickThreshold){const o=t.changedTouches[0],s=Date.now(),i={clientX:o.clientX,clientY:o.clientY};this.handleTouchSelect(i,s-this.state.lastClickTime),this.state.lastClickTime=s}this.state.isDragging=!1,this.state.pinchStartDistance=0}}handleContextMenu(t){t.preventDefault();const e=Date.now();e-this.state.lastRightClickTime<this.doubleClickDelay&&this.resetCameraPosition(),this.state.lastRightClickTime=e}handleMouseDown(t){t.button===2?this.state.isPanning=!0:this.state.isDragging=!0,this.state.clickStartTime=Date.now(),this.updateMouseCoordinates(t.clientX,t.clientY)}handleMouseMove(t){if(!this.state.isDragging&&!this.state.isPanning)return;const e=this.container.getBoundingClientRect(),o=new h.Vector2((t.clientX-e.left)/e.width*2-1,-((t.clientY-e.top)/e.height)*2+1),s=o.clone().sub(this.state.mouse);this.state.isPanning?this.panCamera(s):this.rotateStructure(s),this.state.mouse.copy(o)}handleMouseUp(){this.state.isDragging=!1,this.state.isPanning=!1}handleClick(t){if(t.button!==0||Date.now()-this.state.clickStartTime>this.options.interaction.clickThreshold||this.state.isDragging)return;const o=Date.now();this.handleMouseClick(t,o-this.state.lastClickTime),this.state.lastClickTime=o}handleWheel(t){t.preventDefault(),this.handleZoom(t.deltaY*this.options.camera.wheelZoomSpeed)}handleResize(){const t=this.container.getBoundingClientRect(),e=t.width/t.height;this.camera.aspect=e;const o=this.options.camera.fov;t.width<t.height?this.camera.fov=2*Math.atan(Math.tan(o*Math.PI/360)/e)*180/Math.PI:this.camera.fov=o,this.camera.updateProjectionMatrix(),this.renderer.setSize(t.width,t.height),this.viewer.requestRender()}dispose(){const t=this.renderer.domElement,{wheel:e,mouseDown:o,mouseMove:s,mouseUp:i,click:r,contextMenu:n,touchStart:a,touchMove:l,touchEnd:d,resize:m}=this.boundHandlers;t.removeEventListener("wheel",e),t.removeEventListener("mousedown",o),t.removeEventListener("mousemove",s),t.removeEventListener("mouseup",i),t.removeEventListener("mouseleave",i),t.removeEventListener("click",r),t.removeEventListener("contextmenu",n),t.removeEventListener("touchstart",a),t.removeEventListener("touchmove",l),t.removeEventListener("touchend",d),window.removeEventListener("resize",m)}}class ce{constructor(t){this.options=t,this.selectedObjects=new Set,this.selectionCallbacks=new Set,this.selectedData=new Set}pruneInvalidSelections(t){this.selectedObjects.clear();const e=new Set;t.traverse(o=>{var s;if((s=o.userData)!=null&&s.selectable){const i=this.getObjectData(o);i&&e.add(JSON.stringify(i))}}),this.selectedData=new Set(Array.from(this.selectedData).filter(o=>e.has(JSON.stringify({type:o.type,...this.getDataWithoutColor(o)})))),t.traverse(o=>{var s;if((s=o.userData)!=null&&s.selectable){const i=this.getObjectData(o);if(this.hasMatchingData(i)){const r=this.getColorForData(i);o.select(r,this.options),this.selectedObjects.add(o)}}}),this.notifyCallbacks()}getDataWithoutColor(t){const{color:e,...o}=t;return o}getObjectData(t){if(!t.userData)return null;switch(t.userData.type){case"atom":return{type:"atom",label:t.userData.atomData.label};case"bond":return{type:"bond",atom1:t.userData.bondData.atom1Label,atom2:t.userData.bondData.atom2Label};case"hbond":return{type:"hbond",donor:t.userData.hbondData.donorAtomLabel,hydrogen:t.userData.hbondData.hydrogenAtomLabel,acceptor:t.userData.hbondData.acceptorAtomLabel};default:return null}}hasMatchingData(t){return t?Array.from(this.selectedData).some(e=>this.matchData(e,t)):!1}getColorForData(t){const e=Array.from(this.selectedData).find(o=>this.matchData(o,t));return e?e.color:this.getNextColor()}handle(t){this.options.mode==="single"&&(this.selectedObjects.forEach(s=>{this.remove(s)}),this.selectedObjects.clear(),this.selectedData.clear());const e=this.getObjectData(t);if(!e)return null;let o;return this.hasMatchingData(e)?(o=t.selectionColor,this.remove(t),this.selectedData=new Set(Array.from(this.selectedData).filter(s=>!this.matchData(s,e)))):(o=this.getNextColor(),this.add(t,o),this.selectedData.add({...e,color:o})),this.notifyCallbacks(),o}matchData(t,e){if(t.type!==e.type)return!1;switch(t.type){case"atom":return t.label===e.label;case"bond":return t.atom1===e.atom1&&t.atom2===e.atom2||t.atom1===e.atom2&&t.atom2===e.atom1;case"hbond":return t.donor===e.donor&&t.hydrogen===e.hydrogen&&t.acceptor===e.acceptor;default:return!1}}add(t,e){t.select(e||this.getNextColor(),this.options),this.selectedObjects.add(t)}remove(t){this.selectedObjects.delete(t),t.deselect()}clear(){this.selectedObjects.forEach(t=>{this.remove(t)}),this.selectedObjects.clear(),this.selectedData.clear(),this.notifyCallbacks()}getNextColor(){const t=new Map;this.selectedData.forEach(o=>{t.set(o.color,(t.get(o.color)||0)+1)});let e=this.options.selection.markerColors.find(o=>!t.has(o));if(!e){const o=Math.min(...t.values());e=this.options.selection.markerColors.find(s=>t.get(s)===o)}return e}onChange(t){this.selectionCallbacks.add(t)}notifyCallbacks(){const t=Array.from(this.selectedObjects).map(e=>({type:e.userData.type,data:e.userData.type==="hbond"?e.userData.hbondData:e.userData.type==="bond"?e.userData.bondData:e.userData.atomData,color:e.selectionColor}));this.selectionCallbacks.forEach(e=>e(t))}setMode(t){if(t!=="single"&&t!=="multiple")throw new Error('Selection mode must be either "single" or "multiple"');if(this.options.mode=t,t==="single"&&this.selectedObjects.size>1){const e=Array.from(this.selectedObjects),o=e[e.length-1],s=this.getObjectData(o);this.clear(),s&&(this.add(o),this.selectedData.add({...s,color:o.selectionColor})),this.notifyCallbacks()}}dispose(){this.clear(),this.selectionCallbacks.clear()}}class gt{constructor(t,e={}){const o=["constant","onDemand"];if(e.renderMode&&!o.includes(e.renderMode))throw new Error(`Invalid render mode: "${e.renderMode}". Must be one of: ${o.join(", ")}`);this.container=t,this.options={camera:{...b.camera,initialPosition:new h.Vector3(...b.camera.initialPosition),...e.camera||{}},selection:{...b.selection,...e.selection||{}},interaction:{...b.interaction,...e.interaction||{}},atomDetail:e.atomDetail||b.atomDetail,atomColorRoughness:e.atomColorRoughness||b.atomColorRoughness,atomColorMetalness:e.atomColorMetalness||b.atomColorMetalness,atomADPRingWidthFactor:e.atomADPRingWidthFactor||b.atomADPRingWidthFactor,atomADPRingHeight:e.atomADPRingHeight||b.atomADPRingHeight,atomADPRingSections:e.atomADPRingSections||b.atomADPRingSections,bondRadius:e.bondRadius||b.bondRadius,bondSections:e.bondSections||b.bondSections,bondColor:e.bondColor||b.bondColor,bondColorRoughness:e.bondColorRoughness||b.bondColorRoughness,bondColorMetalness:e.bondColorMetalness||b.bondColorMetalness,bondGrowToleranceFactor:e.bondGrowToleranceFactor||b.bondGrowToleranceFactor,elementProperties:{...b.elementProperties,...e.elementProperties},hydrogenMode:e.hydrogenMode||b.hydrogenMode,disorderMode:e.disorderMode||b.disorderMode,symmetryMode:e.symmetryMode||b.symmetryMode,renderMode:e.renderMode||b.renderMode,fixCifErrors:e.fixCifErrors||b.fixCifErrors},this.state={isDragging:!1,currentCifContent:null,currentStructure:null,currentFloor:null,baseStructure:null,ortepObjects:new Map,structureCenter:new h.Vector3},this.modifiers={removeatoms:new rt,addhydrogen:new pt,missingbonds:new nt(this.options.elementProperties,this.options.bondGrowToleranceFactor),hydrogen:new ot(this.options.hydrogenMode),disorder:new st(this.options.disorderMode),symmetry:new W(this.options.symmetryMode)},this.selections=new ce(this.options),this.setupScene(),this.controls=new le(this),this.animate(),this.needsRender=!0}setupScene(){this.scene=new h.Scene,this.camera=new h.PerspectiveCamera(this.options.camera.fov,this.container.clientWidth/this.container.clientHeight,this.options.camera.near,this.options.camera.far),this.renderer=new h.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.container.appendChild(this.renderer.domElement),this.moleculeContainer=new h.Group,this.scene.add(this.moleculeContainer),this.camera.position.copy(this.options.camera.initialPosition),this.cameraTarget=new h.Vector3(0,0,0),this.camera.lookAt(this.cameraTarget)}async loadStructure(t,e=0){if(t===void 0)return console.error("Cannot load an empty text as CIF"),{success:!1,error:"Cannot load an empty text as CIF"};try{const o=new bt(t);try{this.state.baseStructure=R.fromCIF(o.getBlock(e))}catch(s){if(this.options.fixCifErrors)throw s;try{const i=Lt(o.getBlock(e));this.state.baseStructure=R.fromCIF(i)}catch{throw s}}return await this.setupNewStructure(),{success:!0}}catch(o){return console.error("Error loading structure:",o),{success:!1,error:o.message}}}async setupNewStructure(){this.selections.clear(),this.moleculeContainer.position.set(0,0,0),this.moleculeContainer.rotation.set(0,0,0),this.moleculeContainer.scale.set(1,1,1),this.moleculeContainer.updateMatrix(),this.moleculeContainer.matrixAutoUpdate=!0,this.moleculeContainer.updateMatrixWorld(!0),this.cameraTarget.set(0,0,0),this.camera.position.copy(this.options.camera.initialPosition),this.camera.lookAt(this.cameraTarget),this.state.structureCenter.set(0,0,0),this.update3DOrtep();const t=ne(this.state.currentStructure);return this.container.clientHeight>this.container.clientWidth&&t.premultiply(new h.Matrix4().makeRotationZ(Math.PI/2)),t&&(this.moleculeContainer.setRotationFromMatrix(t),this.moleculeContainer.updateMatrix()),new h.Box3().setFromObject(this.moleculeContainer).getCenter(this.state.structureCenter),this.moleculeContainer.position.sub(this.state.structureCenter),this.updateCamera(),ae(this.scene,this.state.currentStructure),this.requestRender(),{success:!0}}async updateStructure(){try{const t=this.moleculeContainer.matrix.clone();return this.update3DOrtep(),this.moleculeContainer.matrix.copy(t),this.moleculeContainer.matrixAutoUpdate=!1,this.requestRender(),{success:!0}}catch(t){return console.error("Error updating structure:",t),{success:!1,error:t.message}}}update3DOrtep(){this.removeStructure();let t=this.state.baseStructure;for(const s of Object.values(this.modifiers))t=s.apply(t);const o=new At(t,this.options).getGroup();this.moleculeContainer.add(o),this.state.currentStructure=o,this.selections.pruneInvalidSelections(this.moleculeContainer)}updateCamera(){this.controls.handleResize();const t=re(this.moleculeContainer,this.camera);this.camera.position.set(0,0,t),this.camera.rotation.set(0,0,0),this.camera.lookAt(this.cameraTarget),this.options.camera.minDistance=t*.2,this.options.camera.maxDistance=t*2}removeStructure(){this.moleculeContainer.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),this.moleculeContainer.clear()}async cycleModifierMode(t){const e=this.modifiers[t],o=e.cycleMode(this.state.baseStructure);let s;return e.requiresCameraUpdate?s=await this.setupNewStructure():s=await this.updateStructure(),{...s,mode:o}}numberModifierModes(t){if(!this.state.baseStructure)return!1;const e=this.modifiers.removeatoms.apply(this.state.baseStructure);return this.modifiers[t].getApplicableModes(e).length}animate(){(this.options.renderMode==="constant"||this.needsRender)&&(this.renderer.render(this.scene,this.camera),this.needsRender=!1),requestAnimationFrame(this.animate.bind(this))}requestRender(){this.options.renderMode==="onDemand"&&(this.needsRender=!0)}selectAtoms(t){this.selections.selectAtoms(t,this.moleculeContainer)}dispose(){this.controls.dispose(),this.scene.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(e=>e.dispose()):t.material.dispose())}),this.selections.dispose(),this.renderer.dispose(),this.renderer.domElement.parentNode&&this.renderer.domElement.parentNode.removeChild(this.renderer.domElement),this.scene=null,this.camera=null,this.renderer=null,this.state=null,this.options=null}}const de={disorder:{all:'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><path id="path4-5" style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.684508,10.729386 a 2.6075482,2.6075482 0 0 0 -2.607593,2.607593 2.6075482,2.6075482 0 0 0 1.079004,2.104776 l -2.987415,6.12935 a 2.6075482,2.6075482 0 0 0 -0.778764,-0.11938 2.6075482,2.6075482 0 0 0 -2.607592,2.6076 2.6075482,2.6075482 0 0 0 2.607592,2.60759 2.6075482,2.6075482 0 0 0 2.607593,-2.60759 2.6075482,2.6075482 0 0 0 -0.948262,-2.01125 l 3.013252,-6.18464 a 2.6075482,2.6075482 0 0 0 0.622185,0.08114 2.6075482,2.6075482 0 0 0 0.624251,-0.07648 l 3.01377,6.18308 a 2.6075482,2.6075482 0 0 0 -0.950847,2.00815 2.6075482,2.6075482 0 0 0 2.607593,2.60759 2.6075482,2.6075482 0 0 0 2.607593,-2.60759 2.6075482,2.6075482 0 0 0 -2.607593,-2.6076 2.6075482,2.6075482 0 0 0 -0.777214,0.12196 l -2.985347,-6.12727 A 2.6075482,2.6075482 0 0 0 31.2921,13.336979 2.6075482,2.6075482 0 0 0 28.684508,10.729386 Z" /><path id="path8-7" style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0;stroke-dashoffset:0.0831496" d="m 23.328762,11.972721 a 2.6075482,2.6075482 0 0 0 -2.607592,2.607594 2.6075482,2.6075482 0 0 0 2.607592,2.60759 2.6075482,2.6075482 0 0 0 0.70435,-0.0987 l 1.051099,2.16473 0.556038,-1.14205 -0.720886,-1.4733 a 2.6075482,2.6075482 0 0 0 1.016992,-2.05827 2.6075482,2.6075482 0 0 0 -2.607593,-2.607594 z" /><path id="path8-0-5" style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0;stroke-dashoffset:0.0831496" d="m 33.918297,11.972721 a 2.6075482,2.6075482 0 0 0 -2.607593,2.607594 2.6075482,2.6075482 0 0 0 1.0604,2.09083 l -0.673344,1.37666 0.556039,1.14205 1.014408,-2.08876 a 2.6075482,2.6075482 0 0 0 0.65009,0.08681 2.6075482,2.6075482 0 0 0 2.607593,-2.60759 2.6075482,2.6075482 0 0 0 -2.607593,-2.607594 z" /><path id="path9-8" style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0;stroke-dashoffset:0.0831496" d="m 30.92003,19.636335 -1.539441,3.15433 a 2.6075482,2.6075482 0 0 0 -0.696081,-0.0956 2.6075482,2.6075482 0 0 0 -0.750342,0.1142 l -1.51412,-3.10265 -0.557071,1.13998 1.187007,2.43345 a 2.6075482,2.6075482 0 0 0 -0.973067,2.02261 2.6075482,2.6075482 0 0 0 2.607593,2.60759 2.6075482,2.6075482 0 0 0 2.607592,-2.60759 2.6075482,2.6075482 0 0 0 -1.015958,-2.06447 l 1.20096,-2.46187 z" /></g></svg>',group1:'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><g id="g1" transform="translate(-0.54705812,0.13474933)"><path id="path4-5" style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 29.231566,10.594637 a 2.6075482,2.6075482 0 0 0 -2.607593,2.607593 2.6075482,2.6075482 0 0 0 1.079004,2.104776 l -2.987415,6.12935 a 2.6075482,2.6075482 0 0 0 -0.778764,-0.11938 2.6075482,2.6075482 0 0 0 -2.607592,2.6076 2.6075482,2.6075482 0 0 0 2.607592,2.60759 2.6075482,2.6075482 0 0 0 2.607593,-2.60759 2.6075482,2.6075482 0 0 0 -0.948262,-2.01125 l 3.013252,-6.18464 a 2.6075482,2.6075482 0 0 0 0.622185,0.08114 2.6075482,2.6075482 0 0 0 0.624251,-0.07648 l 3.01377,6.18308 a 2.6075482,2.6075482 0 0 0 -0.950847,2.00815 2.6075482,2.6075482 0 0 0 2.607593,2.60759 2.6075482,2.6075482 0 0 0 2.607593,-2.60759 2.6075482,2.6075482 0 0 0 -2.607593,-2.6076 2.6075482,2.6075482 0 0 0 -0.777214,0.12196 l -2.985347,-6.12727 a 2.6075482,2.6075482 0 0 0 1.075386,-2.109436 2.6075482,2.6075482 0 0 0 -2.607592,-2.607593 z" /><path id="path8-7" style="fill:#8f8f8f;fill-opacity:1;stroke:none;stroke-width:0;stroke-dashoffset:0.0831496" d="m 23.87582,11.837972 a 2.6075482,2.6075482 0 0 0 -2.607592,2.607594 2.6075482,2.6075482 0 0 0 2.607592,2.60759 2.6075482,2.6075482 0 0 0 0.70435,-0.0987 l 1.051099,2.16473 0.556038,-1.14205 -0.720886,-1.4733 a 2.6075482,2.6075482 0 0 0 1.016992,-2.05827 2.6075482,2.6075482 0 0 0 -2.607593,-2.607594 z" /><path id="path8-0-5" style="fill:#8f8f8f;fill-opacity:1;stroke:none;stroke-width:0;stroke-dashoffset:0.0831496" d="m 34.465355,11.837972 a 2.6075482,2.6075482 0 0 0 -2.607593,2.607594 2.6075482,2.6075482 0 0 0 1.0604,2.09083 l -0.673344,1.37666 0.556039,1.14205 1.014408,-2.08876 a 2.6075482,2.6075482 0 0 0 0.65009,0.08681 2.6075482,2.6075482 0 0 0 2.607593,-2.60759 2.6075482,2.6075482 0 0 0 -2.607593,-2.607594 z" /><path id="path9-8" style="fill:#8f8f8f;fill-opacity:1;stroke:none;stroke-width:0;stroke-dashoffset:0.0831496" d="m 31.467088,19.501586 -1.539441,3.15433 a 2.6075482,2.6075482 0 0 0 -0.696081,-0.0956 2.6075482,2.6075482 0 0 0 -0.750342,0.1142 l -1.51412,-3.10265 -0.557071,1.13998 1.187007,2.43345 a 2.6075482,2.6075482 0 0 0 -0.973067,2.02261 2.6075482,2.6075482 0 0 0 2.607593,2.60759 2.6075482,2.6075482 0 0 0 2.607592,-2.60759 2.6075482,2.6075482 0 0 0 -1.015958,-2.06447 l 1.20096,-2.46187 z" /></g></g></svg>',group2:'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><path id="path4-5" style="color:#000000;fill:#8f8f8f;fill-opacity:1;stroke:none;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.684508,10.729386 a 2.6075482,2.6075482 0 0 0 -2.607593,2.607593 2.6075482,2.6075482 0 0 0 1.079004,2.104776 l -2.987415,6.12935 a 2.6075482,2.6075482 0 0 0 -0.778764,-0.11938 2.6075482,2.6075482 0 0 0 -2.607592,2.6076 2.6075482,2.6075482 0 0 0 2.607592,2.60759 2.6075482,2.6075482 0 0 0 2.607593,-2.60759 2.6075482,2.6075482 0 0 0 -0.948262,-2.01125 l 3.013252,-6.18464 a 2.6075482,2.6075482 0 0 0 0.622185,0.08114 2.6075482,2.6075482 0 0 0 0.624251,-0.07648 l 3.01377,6.18308 a 2.6075482,2.6075482 0 0 0 -0.950847,2.00815 2.6075482,2.6075482 0 0 0 2.607593,2.60759 2.6075482,2.6075482 0 0 0 2.607593,-2.60759 2.6075482,2.6075482 0 0 0 -2.607593,-2.6076 2.6075482,2.6075482 0 0 0 -0.777214,0.12196 l -2.985347,-6.12727 A 2.6075482,2.6075482 0 0 0 31.2921,13.336979 2.6075482,2.6075482 0 0 0 28.684508,10.729386 Z" /><path id="path8-7" style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0;stroke-dashoffset:0.0831496" d="m 23.328762,11.972721 a 2.6075482,2.6075482 0 0 0 -2.607592,2.607594 2.6075482,2.6075482 0 0 0 2.607592,2.60759 2.6075482,2.6075482 0 0 0 0.70435,-0.0987 l 1.051099,2.16473 0.556038,-1.14205 -0.720886,-1.4733 a 2.6075482,2.6075482 0 0 0 1.016992,-2.05827 2.6075482,2.6075482 0 0 0 -2.607593,-2.607594 z" /><path id="path8-0-5" style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0;stroke-dashoffset:0.0831496" d="m 33.918297,11.972721 a 2.6075482,2.6075482 0 0 0 -2.607593,2.607594 2.6075482,2.6075482 0 0 0 1.0604,2.09083 l -0.673344,1.37666 0.556039,1.14205 1.014408,-2.08876 a 2.6075482,2.6075482 0 0 0 0.65009,0.08681 2.6075482,2.6075482 0 0 0 2.607593,-2.60759 2.6075482,2.6075482 0 0 0 -2.607593,-2.607594 z" /><path id="path9-8" style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0;stroke-dashoffset:0.0831496" d="m 30.92003,19.636335 -1.539441,3.15433 a 2.6075482,2.6075482 0 0 0 -0.696081,-0.0956 2.6075482,2.6075482 0 0 0 -0.750342,0.1142 l -1.51412,-3.10265 -0.557071,1.13998 1.187007,2.43345 a 2.6075482,2.6075482 0 0 0 -0.973067,2.02261 2.6075482,2.6075482 0 0 0 2.607593,2.60759 2.6075482,2.6075482 0 0 0 2.607592,-2.60759 2.6075482,2.6075482 0 0 0 -1.015958,-2.06447 l 1.20096,-2.46187 z" /></g></svg>'},hydrogen:{anisotropic:'<svg width="17.85038mm" height="17.850386mm" viewBox="0 0 17.85038 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-78.600695,-38.873141)"><ellipse style="fill:none;fill-opacity:1;stroke:#8f8f8f;stroke-width:1.8975;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1" id="path7-4" cx="37.167099" cy="89.280861" rx="4.8005486" ry="9.1209068" transform="matrix(0.82466981,-0.56561445,0.63703802,0.77083238,0,0)" /><path id="path17-7-9" style="color:#000000;fill:#000000;stroke:none;stroke-width:0.26484;-inkscape-stroke:none" d="m 85.424476,44.723369 v 6.149929 h 1.191773 v -2.479079 h 1.819274 v 2.479079 h 1.191771 v -6.149929 h -1.191771 v 2.479077 h -1.819274 v -2.479077 z" /></g></svg>',constant:'<svg width="17.850388mm" height="17.850386mm" viewBox="0 0 17.850388 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-58.39314,-38.873141)"><circle style="fill:none;fill-opacity:1;stroke:#8f8f8f;stroke-width:2;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1" id="path6-0" cx="67.318336" cy="47.798332" r="6.8755083" /><path id="path17-7-9" style="color:#000000;fill:#000000;stroke:none;stroke-width:0.26484;-inkscape-stroke:none" d="m 65.216925,44.723369 v 6.149929 h 1.191773 v -2.479079 h 1.819274 v 2.479079 h 1.191771 v -6.149929 h -1.191771 v 2.479077 h -1.819274 v -2.479077 z" /></g></svg>',none:'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-37.755639,-38.873141)"><g id="g2"><path style="fill:#000000;fill-opacity:1;stroke:#8f8f8f;stroke-width:2;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1" d="m 39.917575,41.035079 13.526512,13.52651" id="path5-9" /><g id="g1" style="stroke:#8f8f8f;stroke-opacity:1"><path style="fill:#a4a4a4;fill-opacity:1;stroke:#8f8f8f;stroke-width:2;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1" d="M 53.444087,41.035079 39.917575,54.561589" id="path5-1-0" /></g></g><path id="path17-7-9" style="color:#000000;fill:#000000;stroke:none;stroke-width:0.26484;-inkscape-stroke:none" d="m 44.579422,44.723369 v 6.149929 h 1.191773 v -2.479079 h 1.819274 v 2.479079 h 1.191771 v -6.149929 h -1.191771 v 2.479077 h -1.819274 v -2.479077 z" /></g></svg>'},symmetry:{"bonds-no-hbonds-no":'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><path id="path19-3" style="color:#000000;fill:#8f8f8f;stroke-width:0.999849;stroke-dashoffset:0.022;-inkscape-stroke:none;fill-opacity:1" d="m 25.466978,23.914458 v 0.898 h 0.90006 v -0.898 z m 1.80013,0 v 0.898 h 0.89852 v -0.898 z m 1.82804,0 v 0.898 h 0.90006 v -0.898 z m 1.80065,0 v 0.898 h 0.898 v -0.898 z m 1.80013,0 v 0.898 h 0.80655 v -0.898 z" /><circle style="fill:#8f8f8f;fill-opacity:1;stroke:none;stroke-width:0.564999" id="path1-7-53-4" cx="33.972233" cy="24.363457" r="2.3135188" /><path id="path17-0" style="color:#000000;fill:#8f8f8f;fill-opacity:1;stroke:none;stroke-width:0.421606;-inkscape-stroke:none" d="m 23.896828,13.771675 v 0.898 h 9.51437 v -0.898 z" /><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7-1" cx="23.335804" cy="14.220675" r="2.3135188" /><circle style="fill:#8f8f8f;fill-opacity:1;stroke:none;stroke-width:0.564999" id="path1-7-7-8" cx="33.972233" cy="14.220675" r="2.3135188" /><g id="path7-73" style="fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1" transform="matrix(1,0,0,0.99998067,-2.3e-6,-0.02721318)"><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1;-inkscape-stroke:none" d="M 28.654019,10.932651 V 27.762155" id="path11-6" /><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1;-inkscape-stroke:none" d="m 28.353516,10.933594 v 16.828125 h 0.599609 V 10.933594 Z" id="path15-4" /></g><path id="path17-7-4" style="color:#000000;fill:#000000;stroke:none;stroke-width:0.199128;-inkscape-stroke:none" d="m 21.755798,22.051454 v 4.624007 h 0.89607 v -1.863969 h 1.36787 v 1.863969 h 0.89607 v -4.624007 h -0.89607 v 1.863968 h -1.36787 v -1.863968 z" /></g></svg>',"bonds-no-hbonds-none":'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><path id="path17-0" style="color:#000000;fill:#8f8f8f;fill-opacity:1;stroke:none;stroke-width:0.421606;-inkscape-stroke:none" d="m 23.896827,18.870815 v 0.898 h 9.51437 v -0.898 z" /><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7-1" cx="23.335804" cy="19.319817" r="2.3135188" /><circle style="fill:#8f8f8f;fill-opacity:1;stroke:none;stroke-width:0.564999" id="path1-7-7-8" cx="33.972233" cy="19.319817" r="2.3135188" /><path style="fill:#000000;stroke:#000000;stroke-width:0.6;stroke-dasharray:none" d="M 28.654019,10.932651 V 27.762155" id="path7" /></g></svg>',"bonds-none-hbonds-no":'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><path id="path19" style="color:#000000;fill:#8f8f8f;stroke-width:0.999849;stroke-dashoffset:0.022;-inkscape-stroke:none;fill-opacity:1" d="m 25.466979,18.872141 v 0.898 h 0.900067 v -0.898 z m 1.800134,0 v 0.898 h 0.898517 v -0.898 z m 1.828036,0 v 0.898 h 0.900067 v -0.898 z m 1.800651,0 v 0.898 h 0.898 v -0.898 z m 1.800134,0 v 0.898 h 0.806547 v -0.898 z" /><circle style="fill:#8f8f8f;fill-opacity:1;stroke:none;stroke-width:0.564999" id="path1-7-53-2" cx="33.972233" cy="19.321142" r="2.3135188" /><path id="path17-7" style="color:#000000;fill:#000000;stroke:none;stroke-width:0.199128;-inkscape-stroke:none" d="m 21.7558,17.009137 v 4.624007 h 0.89607 v -1.863969 h 1.367875 v 1.863969 h 0.896069 v -4.624007 h -0.896069 v 1.863968 H 22.65187 v -1.863968 z" /><path style="fill:#000000;stroke:#000000;stroke-width:0.6;stroke-dasharray:none" d="M 28.654019,10.932651 V 27.762155" id="path7" /></g></svg>',"bonds-none-hbonds-none":'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><path style="fill:#000000;fill-opacity:1;stroke:#8f8f8f;stroke-width:0.895002;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1" d="m 20.701184,16.686517 5.269247,5.269247" id="path5-9" /><path style="fill:none;fill-opacity:1;stroke:#8f8f8f;stroke-width:0.895002;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1" d="m 25.970431,16.686517 -5.269247,5.269247" id="path5-1-0" /><path id="path19" style="color:#000000;fill:#8f8f8f;stroke-width:0.999849;stroke-dashoffset:0.022;-inkscape-stroke:none;fill-opacity:1" d="m 25.466979,18.872141 v 0.898 h 0.900067 v -0.898 z m 1.800134,0 v 0.898 h 0.898517 v -0.898 z m 1.828036,0 v 0.898 h 0.900067 v -0.898 z m 1.800651,0 v 0.898 h 0.898 v -0.898 z m 1.800134,0 v 0.898 h 0.806547 v -0.898 z" /><circle style="fill:#8f8f8f;fill-opacity:1;stroke:none;stroke-width:0.564999" id="path1-7-53-2" cx="33.972233" cy="19.321142" r="2.3135188" /><path id="path17-7" style="color:#000000;fill:#000000;stroke:none;stroke-width:0.199128;-inkscape-stroke:none" d="m 21.7558,17.009137 v 4.624007 h 0.89607 v -1.863969 h 1.367875 v 1.863969 h 0.896069 v -4.624007 h -0.896069 v 1.863968 H 22.65187 v -1.863968 z" /><path style="fill:#000000;stroke:#000000;stroke-width:0.6;stroke-dasharray:none" d="M 28.654019,10.932651 V 27.762155" id="path7" /></g></svg>',"bonds-none-hbonds-yes":'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><path id="path19" style="color:#000000;fill:#000000;stroke-width:0.999849;stroke-dashoffset:0.022;-inkscape-stroke:none;fill-opacity:1" d="m 25.466978,18.844554 v 0.898 h 0.900067 v -0.898 z m 1.800134,0 v 0.898 h 0.898517 v -0.898 z m 1.828036,0 v 0.898 h 0.900067 v -0.898 z m 1.800651,0 v 0.898 h 0.898 v -0.898 z m 1.800134,0 v 0.898 h 0.806547 v -0.898 z" /><circle style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.564999" id="path1-7-53-2" cx="33.972233" cy="19.293554" r="2.3135188" /><path id="path17-7" style="color:#000000;fill:#000000;stroke:none;stroke-width:0.199128;-inkscape-stroke:none" d="m 21.755799,16.98155 v 4.624007 h 0.89607 v -1.863969 h 1.367875 v 1.863969 h 0.896069 V 16.98155 h -0.896069 v 1.863968 H 22.651869 V 16.98155 Z" /><path style="fill:#000000;stroke:#000000;stroke-width:0.600002;stroke-dasharray:none" d="m 28.654019,20.03939 v 7.695178" id="path7-6" /><path style="fill:#000000;stroke:#000000;stroke-width:0.600002;stroke-dasharray:none" d="m 28.654018,10.905064 v 7.643502" id="path7-6-2" /></g></svg>',"bonds-yes-hbonds-no":'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><path id="path19" style="color:#000000;fill:#8f8f8f;stroke-width:0.999849;stroke-dashoffset:0.022;-inkscape-stroke:none;fill-opacity:1" d="m 25.466978,23.942207 v 0.898 h 0.900067 v -0.898 z m 1.800134,0 v 0.898 h 0.898517 v -0.898 z m 1.828036,0 v 0.898 h 0.900067 v -0.898 z m 1.800651,0 v 0.898 h 0.898 v -0.898 z m 1.800134,0 v 0.898 h 0.806547 v -0.898 z" /><circle style="fill:#8f8f8f;stroke:none;stroke-width:0.564999;fill-opacity:1" id="path1-7-53" cx="33.972233" cy="24.391207" r="2.3135188" /><path id="path17" style="color:#000000;fill:#000000;stroke:none;stroke-width:0.421606;-inkscape-stroke:none" d="m 23.896835,13.799425 v 0.898 h 9.514368 v -0.898 z" /><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7" cx="23.335806" cy="14.248425" r="2.3135188" /><circle style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.564999" id="path1-7-7" cx="33.972233" cy="14.248425" r="2.3135188" /><g id="path7" style="fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1" transform="matrix(1,0,0,0.75508504,0,6.799367)"><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1;-inkscape-stroke:none" d="M 28.654019,10.932651 V 27.762155" id="path11" /><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1;-inkscape-stroke:none" d="m 28.353516,10.933594 v 16.828125 h 0.599609 V 10.933594 Z" id="path15" /></g><g id="path7-2" style="fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1" transform="matrix(1,0,0,0.15009676,0,9.2916955)"><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1;-inkscape-stroke:none" d="M 28.654019,10.932651 V 27.762155" id="path11-3" /><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1;-inkscape-stroke:none" d="m 28.353516,10.933594 v 16.828125 h 0.599609 V 10.933594 Z" id="path15-3" /></g><path id="path17-7" style="color:#000000;fill:#000000;stroke:none;stroke-width:0.199128;-inkscape-stroke:none" d="m 21.755799,22.079203 v 4.624007 h 0.89607 v -1.863969 h 1.367875 v 1.863969 h 0.896069 v -4.624007 h -0.896069 v 1.863968 h -1.367875 v -1.863968 z" /></g></svg>',"bonds-yes-hbonds-none":'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><g id="g1" transform="translate(20.608042,9.8427536)"><path id="path17-4" style="color:#000000;fill:#000000;stroke:none;stroke-width:0.4;-inkscape-stroke:none" d="m 3.245596,9.0762805 v 0.800985 h 9.601481 v -0.800985 z" /><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7-8" cx="2.7277639" cy="9.4770622" r="2.3135188" /><circle style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.564999" id="path1-7-7-2" cx="13.364189" cy="9.4770622" r="2.3135188" /></g><g id="g2" transform="translate(-1.2072753e-7,-0.02758705)"><g id="path7-7-3" style="fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1" transform="matrix(1,0,0,0.45417979,6.985e-4,15.153145)"><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1;-inkscape-stroke:none" d="M 28.654019,10.932651 V 27.762155" id="path11-9-2" /><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1;-inkscape-stroke:none" d="m 28.353516,10.933594 v 16.828125 h 0.599609 V 10.933594 Z" id="path15-6-5" /></g><g id="path7-7-3-7" style="fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1" transform="matrix(1,0,0,0.45140061,6.985e-4,5.9976457)"><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1;-inkscape-stroke:none" d="M 28.654019,10.932651 V 27.762155" id="path11-9-2-1" /><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1;-inkscape-stroke:none" d="m 28.353516,10.933594 v 16.828125 h 0.599609 V 10.933594 Z" id="path15-6-5-6" /></g></g></g></svg>',"bonds-yes-hbonds-yes":'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><path id="path19" style="color:#000000;fill:#000000;fill-opacity:1;stroke-width:0.999849;stroke-dashoffset:0.022;-inkscape-stroke:none" d="m 25.466978,23.91462 v 0.898 h 0.900067 v -0.898 z m 1.800134,0 v 0.898 h 0.898517 v -0.898 z m 1.828036,0 v 0.898 h 0.900067 v -0.898 z m 1.800651,0 v 0.898 h 0.898 v -0.898 z m 1.800134,0 v 0.898 h 0.806547 v -0.898 z" /><circle style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.564999" id="path1-7-53-8" cx="33.972233" cy="24.363619" r="2.3135188" /><path id="path17" style="color:#000000;fill:#000000;stroke:none;stroke-width:0.421606;-inkscape-stroke:none" d="m 23.896835,13.771838 v 0.898 h 9.514368 v -0.898 z" /><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7-59" cx="23.335806" cy="14.220837" r="2.3135188" /><circle style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.564999" id="path1-7-7-5" cx="33.972233" cy="14.220837" r="2.3135188" /><g id="path7-2" style="fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1" transform="matrix(1,0,0,0.15009676,0,9.2641086)"><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1;-inkscape-stroke:none" d="M 28.654019,10.932651 V 27.762155" id="path11-3" /><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1;-inkscape-stroke:none" d="m 28.353516,10.933594 v 16.828125 h 0.599609 V 10.933594 Z" id="path15-3" /></g><path id="path17-7" style="color:#000000;fill:#000000;stroke:none;stroke-width:0.199128;-inkscape-stroke:none" d="m 21.755799,22.051616 v 4.624007 h 0.89607 v -1.863969 h 1.367875 v 1.863969 h 0.896069 v -4.624007 h -0.896069 v 1.863968 h -1.367875 v -1.863968 z" /><g id="path7-9" style="fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1" transform="matrix(1,0,0,0.51054368,0,9.4452649)"><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1;-inkscape-stroke:none" d="M 28.654019,10.932651 V 27.762155" id="path11" /><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1;-inkscape-stroke:none" d="m 28.353516,10.933594 v 16.828125 h 0.599609 V 10.933594 Z" id="path15" /></g><g id="path7-9-3" style="fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1" transform="matrix(1,0,0,0.15604158,0,23.402517)"><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1;-inkscape-stroke:none" d="M 28.654019,10.932651 V 27.762155" id="path11-7" /><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:none;stroke-opacity:1;-inkscape-stroke:none" d="m 28.353516,10.933594 v 16.828125 h 0.599609 V 10.933594 Z" id="path15-9" /></g></g></svg>'},upload:'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1"><marker style="overflow:visible" id="ArrowWide" refX="0" refY="0" orient="auto-start-reverse" arrow" markerWidth="1" markerHeight="1" viewBox="0 0 1 1" preserveAspectRatio="xMidYMid"><path style="fill:none;stroke:context-stroke;stroke-width:1;stroke-linecap:butt" d="M 3,-3 0,0 3,3" transform="rotate(180,0.125,0)" id="path1" /></marker></defs><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><text xml:space="preserve" style="font-size:7.05556px;fill:#e6e6e6;stroke:none;stroke-width:0.5;stroke-linecap:round;stroke-dasharray:none" x="22.242813" y="28.151989" id="text2"><tspan id="tspan2" style="font-size:7.05556px;fill:#1a1a1a;stroke-width:0.5;stroke-linecap:round;stroke-dasharray:none" x="22.242813" y="28.151989">CIF</tspan></text><path style="fill:none;stroke:#000000;stroke-width:0.68;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1" d="m 20.714121,18.107197 v 3.07807 h 15.879794 v -3.07807" id="path2" /><path style="fill:none;stroke:#000000;stroke-width:0.68;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1;marker-end:url(#ArrowWide)" d="M 28.654018,19.170064 V 11.045456" id="path3" /></g></svg>'},he=`
  cifview-widget {
    display: flex;
    flex-direction: column;
    font-family: system-ui, -apple-system, sans-serif;
    height: 100%;
    position: relative;
    background: #fafafa;
    border-radius: 8px;
    overflow: hidden;
  }
  
  cifview-widget .crystal-container {
    flex: 1;
    min-height: 0;
    position: relative;
  }
  
  cifview-widget .crystal-caption {
    padding: 12px 16px;
    background: #ffffff;
    border-top: 1px solid #eaeaea;
    color: #333;
    font-size: 14px;
    line-height: 1.5;
  }

  cifview-widget .button-container {
    position: absolute;
    top: 16px;
    right: 16px;
    display: flex;
    gap: 8px;
    z-index: 1000;
  }

  cifview-widget .control-button {
    width: 40px;
    height: 40px;
    border: none;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.9);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  cifview-widget .control-button:hover {
    background: #ffffff;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }

  cifview-widget .control-button svg {
    width: 24px;
    height: 24px;
  }
`;class Tt extends HTMLElement{static get observedAttributes(){return["caption","src","data","icons","filtered-atoms","options","hydrogen-mode","disorder-mode","symmetry-mode"]}constructor(){if(super(),!document.getElementById("cifview-styles")){const t=document.createElement("style");t.id="cifview-styles",t.textContent=he,document.head.appendChild(t)}this.viewer=null,this.baseCaption="",this.selections=[],this.customIcons=null,this.userOptions={}}get icons(){return{...de,...this.customIcons}}async connectedCallback(){this.baseCaption=this.getAttribute("caption")||"",this.parseOptions(),this.parseInitialModes();const t=document.createElement("div");t.className="crystal-container",this.appendChild(t);const e=document.createElement("div");e.className="button-container",t.appendChild(e),this.buttonContainer=e;const o=document.createElement("div");o.className="crystal-caption",o.innerHTML=this.baseCaption,this.appendChild(o),this.captionElement=o,this.viewer=new gt(t,this.userOptions),this.viewer.selections.onChange(r=>{this.selections=r,this.updateCaption()}),this.customIcons=this.parseCustomIcons(),await this.updateFilteredAtoms();const s=this.getAttribute("src"),i=this.getAttribute("data");s?await this.loadFromUrl(s):i&&await this.loadFromString(i)}parseOptions(){const t=this.getAttribute("options");if(t)try{const e=JSON.parse(t);this.userOptions=this.mergeOptions(e)}catch(e){console.warn("Failed to parse options:",e)}}mergeOptions(t){const e={...b};return Object.keys(t).forEach(o=>{o==="elementProperties"?(e.elementProperties={...e.elementProperties},Object.keys(t.elementProperties||{}).forEach(s=>{e.elementProperties[s]={...e.elementProperties[s]||{},...t.elementProperties[s]}})):typeof t[o]=="object"&&t[o]!==null?e[o]={...e[o]||{},...t[o]}:e[o]=t[o]}),e}parseInitialModes(){const t=this.getAttribute("hydrogen-mode"),e=this.getAttribute("disorder-mode"),o=this.getAttribute("symmetry-mode");t&&(this.userOptions.hydrogenMode=t),e&&(this.userOptions.disorderMode=e),o&&(this.userOptions.symmetryMode=o)}clearButtons(){if(this.buttonContainer)for(;this.buttonContainer.firstChild;)this.buttonContainer.removeChild(this.buttonContainer.firstChild)}setupButtons(){!this.viewer||!this.viewer.state.baseStructure||(this.clearButtons(),this.viewer.numberModifierModes("hydrogen")>1&&this.addButton(this.buttonContainer,"hydrogen","Toggle Hydrogen Display"),this.viewer.numberModifierModes("disorder")>2&&this.addButton(this.buttonContainer,"disorder","Toggle Disorder Display"),this.viewer.numberModifierModes("symmetry")>1&&this.addButton(this.buttonContainer,"symmetry","Toggle Symmetry Display"))}parseCustomIcons(){try{let t;try{t=JSON.parse(this.getAttribute("icons"))}catch{throw new Error("Failed to parse custom icon definition. Needs to be valid JSON.")}if(!t)return null;const e=Object.getOwnPropertyNames(t),o=Object.getOwnPropertyNames(this.viewer.modifiers),s=e.filter(n=>!o.includes(n));if(s.length>0)throw new Error(`One or more invalid categories for custom icons: ${s.join(", ")}. Valid categories: ${o.join(", ")}`);const i={},r=[];for(const n of e){i[n]={};const a=Object.values(this.viewer.modifiers[n].MODES);Object.getOwnPropertyNames(t[e]).forEach(d=>{a.includes(d)?i[n][d]=t[n][d]:r.push([n,d])})}if(r.length>0){const n=r.map(([a,l])=>`${a}: ${l}`).join(" ,");throw new Error(`The following custom icons do not map to a valid mode: ${n}`)}return i}catch(t){return console.warn("Failed to parse custom icons:",t),null}}async updateFilteredAtoms(){const t=this.getAttribute("filtered-atoms");this.viewer.modifiers.removeatoms.setFilteredLabels(t||""),t&&t.trim()?this.viewer.modifiers.removeatoms.mode="on":this.viewer.modifiers.removeatoms.mode="off",this.setupButtons()}addButton(t,e,o){const s=document.createElement("button");s.className=`control-button ${e}-button`;const i=this.viewer.modifiers[e].mode;s.innerHTML=this.icons[e][i],s.title=o;const r=s.querySelector("svg");r&&(r.setAttribute("alt",o),r.setAttribute("role","img"),r.setAttribute("aria-label",o)),t.appendChild(s),s.addEventListener("click",async()=>{const n=await this.viewer.cycleModifierMode(e);n.success&&(s.innerHTML=this.icons[e][n.mode])})}async attributeChangedCallback(t,e,o){if(this.viewer)switch(t){case"caption":this.baseCaption=o,this.updateCaption();break;case"src":o&&await this.loadFromUrl(o);break;case"data":o&&await this.loadFromString(o);break;case"icons":this.customIcons=this.parseCustomIcons();break;case"filtered-atoms":await this.updateFilteredAtoms(),await this.viewer.updateStructure();break;case"options":if(this.parseOptions(),this.viewer){const s=this.querySelector(".crystal-container"),i=this.viewer.state.currentCifContent;this.viewer.dispose(),this.viewer=new gt(s,this.userOptions),this.viewer.selections.onChange(r=>{this.selections=r,this.updateCaption()}),i&&(await this.viewer.loadStructure(i),this.setupButtons())}break;case"hydrogen-mode":this.viewer.modifiers.hydrogen&&(this.viewer.modifiers.hydrogen.mode=o,await this.viewer.updateStructure(),this.setupButtons());break;case"disorder-mode":this.viewer.modifiers.disorder&&(this.viewer.modifiers.disorder.mode=o,await this.viewer.updateStructure(),this.setupButtons());break;case"symmetry-mode":this.viewer.modifiers.symmetry&&(this.viewer.modifiers.symmetry.mode=o,await this.viewer.setupNewStructure(),this.setupButtons());break}}async loadFromUrl(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load CIF file: ${e.status} ${e.statusText}`);const o=e.headers.get("content-type");if(o&&o.includes("text/html"))throw new Error("Received no or invalid content for src.");const s=await e.text();if(s.includes("<!DOCTYPE html>")||s.includes("<html>"))throw new Error("Received no or invalid content for src.");const i=await this.viewer.loadStructure(s);if(i.success)this.setupButtons();else throw new Error(i.error||"Unknown Error")}catch(e){this.createErrorDiv(e)}}async loadFromString(t){try{await this.viewer.loadStructure(t),this.setupButtons()}catch(e){this.createErrorDiv(e)}}createErrorDiv(t){if(console.error("Error loading structure:",t),this.baseCaption=`Error loading structure: ${t.message}`,this.updateCaption(),this.viewer){const e=this.querySelector(".crystal-container");if(e){for(;e.firstChild;)e.firstChild.remove();const o=document.createElement("div");o.style.display="flex",o.style.justifyContent="center",o.style.alignItems="center",o.style.height="100%",o.style.padding="20px",o.style.textAlign="center",o.style.color="#d32f2f",o.innerHTML=`<div>
                    <h3>Error Loading Structure</h3>
                    <p>${t.message}</p>
                    <p>Please check that the file exists and is a valid CIF file.</p>
                </div>`,e.appendChild(o)}}}updateCaption(){let t=this.baseCaption;if(this.selections.length>0){t.endsWith(".")||(t+="."),t+=" Selected Atoms and Bonds: ";const e=this.selections.map(o=>{const s="#"+o.color.toString(16).padStart(6,"0");let i="";if(o.type==="atom")i=`${o.data.label} (${o.data.atomType})`;else if(o.type==="bond"){const r=Ot(o.data.bondLength,o.data.bondLengthSU);i=`${o.data.atom1Label}-${o.data.atom2Label}: ${r} Å`}else o.type==="hbond"&&(i=`${o.data.donorAtomLabel}→${o.data.acceptorAtomLabel}`);return`<span style="color:${s}">${i}</span>`}).join(", ");t+=e+"."}this.captionElement.innerHTML=t,this.viewer.controls.handleResize()}disconnectedCallback(){this.viewer&&this.viewer.dispose()}}if(typeof window<"u"&&window.customElements)try{window.customElements.define("cifview-widget",Tt)}catch(c){c.message.includes("already been defined")||console.warn("Failed to register cifview-widget:",c)}u.AtomLabelFilter=rt,u.BondGenerator=nt,u.CIF=bt,u.CifViewWidget=Tt,u.CrystalStructure=R,u.CrystalViewer=gt,u.DisorderFilter=st,u.HydrogenFilter=ot,u.ORTEP3JsStructure=At,u.SymmetryGrower=W,u.formatValueEsd=Ot,u.tryToFixCifBlock=Lt,Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});
