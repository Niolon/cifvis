(function(p,g){typeof exports=="object"&&typeof module<"u"?g(exports,require("mathjs"),require("three")):typeof define=="function"&&define.amd?define(["exports","mathjs","three"],g):(p=typeof globalThis<"u"?globalThis:p||self,g(p.CifVis={},p.math,p.THREE))})(this,function(p,g,S){"use strict";var de=Object.defineProperty;var Rt=p=>{throw TypeError(p)};var he=(p,g,S)=>g in p?de(p,g,{enumerable:!0,configurable:!0,writable:!0,value:S}):p[g]=S;var R=(p,g,S)=>he(p,typeof g!="symbol"?g+"":g,S),Pt=(p,g,S)=>g.has(p)||Rt("Cannot "+S);var A=(p,g,S)=>(Pt(p,g,"read from private field"),S?S.call(p):g.get(p)),Bt=(p,g,S)=>g.has(p)?Rt("Cannot add the same private member more than once"):g instanceof WeakSet?g.add(p):g.set(p,S),It=(p,g,S,X)=>(Pt(p,g,"write to private field"),X?X.call(p,S):g.set(p,S),S);var x;function X(l){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(l){for(const e in l)if(e!=="default"){const o=Object.getOwnPropertyDescriptor(l,e);Object.defineProperty(t,e,o.get?o:{enumerable:!0,get:()=>l[e]})}}return t.default=l,Object.freeze(t)}const d=X(S);function it(l,t=!0){const e=/^([+-]?)(\d+\.?\d*|\.\d+)[eE]([+-]?\d+)\((\d+)\)$/,o=l.match(e);if(t&&o){const[,n,c,h,m]=o,f=n==="-"?-1:1,y=parseFloat(c),u=parseInt(h),_=c.includes(".")?c.split(".")[1].length:0,L=Number(f*y*Math.pow(10,u)),W=u-_,Tt=Number(parseInt(m)*Math.pow(10,W));return _-u>=0&&_-u<=100?{value:Number(L.toFixed(_-u)),su:Number(Tt.toFixed(_-u))}:{value:L,su:Tt}}const s=/^([+-]?)(\d+\.?\d*|\.\d+)[eE]([+-]?\d+)$/,r=l.match(s);if(r){const[,n,c,h]=r,m=n==="-"?-1:1,f=c.includes(".")?c.split(".")[1].length:0,y=parseInt(h),u=Number(m*parseFloat(c)*Math.pow(10,y));return f-y>=0&&f-y<=100?{value:Number(u.toFixed(f-y)),su:NaN}:{value:u,su:NaN}}const i=/^([+-]?)(\d+\.?\d*|\.\d+)\((\d+)\)$/,a=l.match(i);if(t&&a){const[,n,c,h]=a,m=n==="-"?-1:1;if(c.includes(".")){const f=c.split(".")[1].length,y=Number((m*parseFloat(c)).toFixed(f)),u=Number((Math.pow(10,-f)*parseFloat(h)).toFixed(f));return{value:y,su:u}}else{const f=m*parseInt(c),y=parseInt(h);return{value:f,su:y}}}return isNaN(l)?/^".*"$/.test(l)||/^'.*'$/.test(l)?{value:l.slice(1,-1).replace(/\\([^\\])/g,"$1"),su:NaN}:{value:l.replace(/\\([^\\])/g,"$1"),su:NaN}:{value:l.includes(".")?parseFloat(l):parseInt(l),su:NaN}}function ut(l,t){const e=[l[t].slice(1)],o=l.slice(t+1),s=o.findIndex(n=>n.startsWith(";")),r=e.concat(o.slice(0,s)),i=r.findIndex(n=>n.trim()!==""),a=r.findLastIndex(n=>n.trim!=="");return{value:r.slice(i,a+1).join(`
`),endIndex:t+s+1}}const zt=["_space_group_symop_ssg","_space_group_symop","_symmetry_equiv","_geom_bond","_geom_hbond","_geom_angle","_geom_torsion","_diffrn_refln","_refln","_atom_site_fourier_wave_vector","_atom_site_moment_fourier_param","_atom_site_moment_special_func","_atom_site_moment","_atom_site_rotation","_atom_site_displace_Fourier","_atom_site_displace_special_func","_atom_site_occ_Fourier","_atom_site_occ_special_func","_atom_site_phason","_atom_site_rot_Fourier_param","_atom_site_rot_Fourier","_atom_site_rot_special_func","_atom_site_U_Fourier","_atom_site_anharm_gc_c","_atom_site_anharm_gc_d","_atom_site_aniso","_atom_site"];class Z{constructor(t,e,o,s,r=null){this.splitSU=s,this.headerLines=t,this.dataLines=e,this.endIndex=o,this.headers=null,this.data=null,this.name=null,r?this.name=r:this.name=this.findCommonStart()}static fromLines(t,e){let o=1;for(;o<t.length&&t[o].trim().startsWith("_");)o++;const s=t.slice(1,o).map(c=>c.trim());let r=o,i=!1;for(;r<t.length&&(!t[r].trim().startsWith("_")&&!t[r].trim().startsWith("loop_")||i);)t[r].startsWith(";")&&(i=!i),r++;const a=t.slice(o,r),n=r;return new Z(s,a,n,e)}parse(){if(this.data!==null)return;this.headers=[...this.headerLines],this.data={};const t=this.dataLines.reduce((o,s,r)=>{if(s=s.trim(),!s.length)return o;if(s.startsWith(";")){const a=ut(this.dataLines,r);o.push({value:a.value,su:NaN});for(let n=r;n<a.endIndex+1;n++)this.dataLines[n]="";return o}const i=Array.from(s.matchAll(/'([^']*(?:'\S[^']*)*)'|"([^"]*(?:"\S[^"]*)*)"|\S+/g));return o.concat(i.map(a=>it(a[1]||a[2]||a[0],this.splitSU)))},[]),e=this.headers.length;if(t.length%e!==0){const o=t.map(({value:s,su:r})=>`{value: ${s}, su: ${r}}`).join(", ");throw new Error(`Loop ${this.name}: Cannot distribute ${t.length} values evenly into ${e} columns
entries are: ${o}`)}else if(t.length===0)throw new Error(`Loop ${this.name} has no data values.`);for(let o=0;o<e;o++){const s=this.headers[o],r=t.slice(o).filter((a,n)=>n%e===0);r.some(a=>!isNaN(a.su))?(this.data[s]=r.map(a=>a.value),this.data[s+"_su"]=r.map(a=>a.su),this.headers.push(s+"_su")):this.data[s]=r.map(a=>a.value)}}findCommonStart(t=!0){if(t){for(const i of zt)if(this.headerLines.filter(n=>n.toLowerCase().startsWith(i.toLowerCase())).length>=this.headerLines.length/2)return i}const e=this.headerLines.map(i=>i.split("."));if(e[0].length>1){const i=e[0][0];if(this.headerLines.filter(n=>n.split(".")[0]===i).length>=this.headerLines.length/2)return i}const o=this.headerLines.map(i=>i.split(/[_.]/).filter(a=>a)),s=Math.min(...o.map(i=>i.length));let r="";for(let i=0;i<s;i++){const a=o[0][i],n=o.filter(c=>c[i]===a).length;if(this.headerLines.length===2)if(n===2)r+="_"+a;else break;else if(n>=this.headerLines.length/2)r+="_"+a;else break}return r}get(t,e=null){this.parse();const o=Array.isArray(t)?t:[t];for(const s of o){const r=this.data[s];if(r!==void 0)return r}if(e!==null)return e;throw new Error(`None of the keys [${o.join(", ")}] found in CIF loop ${this.name}`)}getIndex(t,e,o=null){this.parse();const s=Array.isArray(t)?t:[t];if(!s.some(i=>this.headers.includes(i))){if(o!==null)return o;throw new Error(`None of the keys [${s.join(", ")}] found in CIF loop ${this.name}`)}const r=this.get(s);if(e<r.length)return r[e];throw new Error(`Tried to look up value of index ${e} in ${this.name}, but length is only ${r.length}`)}getHeaders(){return this.headers||this.parse(),this.headers}getName(){return this.name}getEndIndex(){return this.endIndex}}function j(l){return l&&typeof l.getHeaders=="function"}function at(l){return l.getHeaders()[0].split("_").filter(e=>e.length>0)}function Ft(l,t,e){const o=j(l)?l:t,s=e.split("_").filter(a=>a.length>0),r=at(o),i="_"+s.join("_")+"_"+r[s.length];return j(l)?[i,e]:[e,i]}function Ht(l,t){const e=l.findCommonStart(!1),o=t.findCommonStart(!1);return e.length!==o.length?[e,o]:null}function $t(l,t,e){const o=e.split("_").filter(i=>i.length>0),s=at(l),r=at(t);return s.length>=r.length?[e+"_"+s[o.length],e]:[e,e+"_"+r[o.length]]}function Vt(l,t,e){let o;!j(l)||!j(t)?o=Ft(l,t,e):o=Ht(l,t)||$t(l,t,e);const s=[l,t];return s.forEach((r,i)=>{j(r)&&(r.name=o[i])}),{newNames:o,newEntries:s}}class gt{constructor(t,e=!0){this.splitSU=e,this.rawCifBlocks=this.splitCifBlocks(`

`+t),this.blocks=Array(this.rawCifBlocks.length).fill(null)}splitCifBlocks(t){const e=[],o=t.replaceAll(`\r
`,`
`).split(/\r?\ndata_/).slice(1);let s=0;for(;s<o.length;){let r=o[s];const i=/\n;/g,a=r.match(i);let n=a?a.length:0;for(;n%2===1&&s+1<o.length;){s++,r+=`
data_`+o[s];const c=r.match(i);n=c?c.length:0}e.push(r),s++}return e}getBlock(t=0){return this.blocks[t]||(this.blocks[t]=new yt(this.rawCifBlocks[t],this.splitSU)),this.blocks[t]}getAllBlocks(){for(let t=0;t<this.blocks.length;t++)this.blocks[t]||(this.blocks[t]=new yt(this.rawCifBlocks[t],this.splitSU));return this.blocks}}class yt{constructor(t,e=!0){this.rawText=t,this.splitSU=e,this.data=null,this.dataBlockName=null}parse(){if(this.data!==null)return;this.data={};const t=this.rawText.split(`
`).filter(o=>!o.trim().startsWith("#")).map(o=>{const s=/ #(?=(?:[^"]*"[^"]*")*[^"]*$)(?=(?:[^']*'[^']*')*[^']*$)/;return o.split(s)[0]});this.dataBlockName=t[0];let e=1;for(;e<t.length;){if(e+1<t.length&&t[e+1].startsWith(";")){const r=ut(t,e+1);this.data[t[e]]=r.value,e=r.endIndex+1;continue}if(t[e].trim().startsWith("loop_")){const r=Z.fromLines(t.slice(e),this.splitSU);if(!Object.prototype.hasOwnProperty.call(this.data,r.getName()))this.data[r.getName()]=r;else{const i=Vt(this.data[r.getName()],r,r.getName());this.data[i.newNames[0]]=i.newEntries[0],this.data[i.newNames[1]]=i.newEntries[1]}e+=r.getEndIndex();continue}const o=t[e].trim();if(o.length===0){e++;continue}const s=o.match(/^(_\S+)\s+(.*)$/);if(s){const r=s[1],i=it(s[2],this.splitSU);this.data[r]=i.value,isNaN(i.su)||(this.data[r+"_su"]=i.su)}else if(o.startsWith("_")&&!t[e+1].startsWith("_")){const r=o,i=it(t[e+1].trim(),this.splitSU);this.data[r]=i.value,isNaN(i.su)||(this.data[r+"_su"]=i.su),e++}else throw new Error("Could not parse line "+String(e)+": "+t[e]);e++}}get dataBlockName(){return this._dataBlockName||this.parse(),this._dataBlockName}set dataBlockName(t){this._dataBlockName=t}get(t,e=null){this.parse();const o=Array.isArray(t)?t:[t];for(const s of o){const r=this.data[s];if(r!==void 0)return r}if(e!==null)return e;throw new Error(`None of the keys [${o.join(", ")}] found in CIF block`)}}const C=g.create(g.all,{});function B(l){const t=C.unit(l.alpha,"deg").toNumber("rad"),e=C.unit(l.beta,"deg").toNumber("rad"),o=C.unit(l.gamma,"deg").toNumber("rad"),s=Math.cos(t),r=Math.cos(e),i=Math.cos(o),a=Math.sin(o),n=Math.sqrt(1-s*s-r*r-i*i+2*s*r*i);return C.matrix([[l.a,l.b*i,l.c*r],[0,l.b*a,l.c*(s-r*i)/a],[0,0,l.c*n/a]])}function _t(l){return C.matrix([[l[0],l[3],l[4]],[l[3],l[1],l[5]],[l[4],l[5],l[2]]])}function Ut(l){const t=C.matrix(l);return[t.get([0,0]),t.get([1,1]),t.get([2,2]),t.get([0,1]),t.get([0,2]),t.get([1,2])]}function Gt(l,t){const e=C.matrix(l),o=C.transpose(C.inv(e)),s=C.diag(C.matrix(C.transpose(o).toArray().map(n=>C.norm(n)))),r=_t(t),i=C.multiply(C.multiply(s,r),C.transpose(s)),a=C.multiply(C.multiply(e,i),C.transpose(e));return Ut(a)}const bt=g.create(g.all),pt=class pt{constructor(t,e,o){Bt(this,x);if(new.target===pt)throw new TypeError("BasePosition is an abstract class and cannot be instantiated directly, you probably want CartPosition");It(this,x,[Number(t),Number(e),Number(o)]),Object.defineProperties(this,{0:{get:()=>A(this,x)[0]},1:{get:()=>A(this,x)[1]},2:{get:()=>A(this,x)[2]},length:{value:3},[Symbol.iterator]:{value:function*(){yield A(this,x)[0],yield A(this,x)[1],yield A(this,x)[2]}}})}get x(){return A(this,x)[0]}get y(){return A(this,x)[1]}get z(){return A(this,x)[2]}set x(t){A(this,x)[0]=t}set y(t){A(this,x)[1]=t}set z(t){A(this,x)[2]=t}toCartesian(t){throw new Error("toCartesian must be implemented by subclass")}};x=new WeakMap;let J=pt;class wt extends J{constructor(t,e,o){super(t,e,o)}toCartesian(t){const e=bt.multiply(t.fractToCartMatrix,bt.matrix([this.x,this.y,this.z]));return new kt(...e.toArray())}}class kt extends J{constructor(t,e,o){super(t,e,o)}toCartesian(t){return this}}class qt{static fromCIF(t,e){let o=!1;const s=t.get("_atom_site"),r=[".","?"];if(String(s.getIndex(["_atom_site.calc_flag","_atom_site_calc_flag"],e,"")).toLowerCase()==="dum")throw new Error("Dummy atom: calc_flag is dum");try{const a=s.getIndex(["_atom_site.fract_x","_atom_site_fract_x"],e),n=s.getIndex(["_atom_site.fract_y","_atom_site_fract_y"],e),c=s.getIndex(["_atom_site.fract_z","_atom_site_fract_z"],e);if(!r.includes(a)&&!r.includes(n)&&!r.includes(c))return new wt(a,n,c);o=!0}catch{}try{const a=s.getIndex(["_atom_site.Cartn_x","_atom_site.cartn_x","_atom_site_Cartn_x"],e),n=s.getIndex(["_atom_site.Cartn_y","_atom_site.cartn_y","_atom_site_Cartn_y"],e),c=s.getIndex(["_atom_site.Cartn_z","_atom_site.cartn_z","_atom_site_Cartn_z"],e);if(!r.includes(a)&&!r.includes(n)&&!r.includes(c))return new kt(a,n,c);o=!0}catch{}throw o?new Error("Dummy atom: Invalid position"):new Error("Invalid position: No valid fractional or Cartesian coordinates found")}}const N=g.create(g.all,{});class I{constructor(t){this.uiso=t}static fromBiso(t){return new I(t/(8*Math.PI*Math.PI))}}class z{constructor(t,e,o,s,r,i){this.u11=t,this.u22=e,this.u33=o,this.u12=s,this.u13=r,this.u23=i}static fromBani(t,e,o,s,r,i){const a=1/(8*Math.PI*Math.PI);return new z(t*a,e*a,o*a,s*a,r*a,i*a)}getUCart(t){return Gt(t.fractToCartMatrix,[this.u11,this.u22,this.u33,this.u12,this.u13,this.u23])}getEllipsoidMatrix(t){const e=_t(this.getUCart(t)),{eigenvectors:o}=N.eigs(e),s=N.transpose(N.matrix(o.map(c=>c.vector))),r=N.matrix(o.map(c=>c.value>0?c.value:NaN)),i=N.det(s),a=N.diag(r.map(Math.sqrt));let n;if(N.abs(i-1)>1e-10){const c=N.multiply(s,1/i);n=N.multiply(c,a)}else n=N.multiply(s,a);return N.matrix(n)}}class D{static fromCIF(t,e){const o=t.get("_atom_site"),s=o.getIndex(["_atom_site.label","_atom_site_label"],e),r=o.getIndex(["_atom_site.adp_type","_atom_site_adp_type","_atom_site.thermal_displace_type","_atom_site_thermal_displace_type"],e,!1);if(r)return D.createFromExplicitType(t,e,s,r);if(D.isInAnisoLoop(t,s)){const c=D.createUani(t,s);if(c!==null)return c;const h=D.createBani(t,s);if(h!==null)return h}const a=D.createUiso(t,e);if(a!==null)return a;const n=D.createBiso(t,e);return n!==null?n:null}static createFromExplicitType(t,e,o,s){switch(s.toLowerCase()){case"uani":return D.createUani(t,o);case"aniso":return D.createUani(t,o);case"bani":return D.createBani(t,o);case"uiso":return D.createUiso(t,e);case"iso":return D.createUiso(t,e);case"biso":return D.createBiso(t,e);default:return null}}static isInAnisoLoop(t,e){try{return t.get("_atom_site_aniso").get(["_atom_site_aniso.label","_atom_site_aniso_label"]).includes(e)}catch{return!1}}static createUani(t,e){let o;try{o=t.get("_atom_site_aniso")}catch{throw new Error(`Atom ${e} had ADP type UAni, but no atom_site_aniso loop was found`)}const r=o.get(["_atom_site_aniso.label","_atom_site_aniso_label"]).indexOf(e);if(r===-1)throw new Error(`Atom ${e} has ADP type Uani, but was not found in atom_site_aniso.label`);const i=o.getIndex(["_atom_site_aniso.u_11","_atom_site_aniso_U_11"],r,NaN),a=o.getIndex(["_atom_site_aniso.u_22","_atom_site_aniso_U_22"],r,NaN),n=o.getIndex(["_atom_site_aniso.u_33","_atom_site_aniso_U_33"],r,NaN),c=o.getIndex(["_atom_site_aniso.u_12","_atom_site_aniso_U_12"],r,NaN),h=o.getIndex(["_atom_site_aniso.u_13","_atom_site_aniso_U_13"],r,NaN),m=o.getIndex(["_atom_site_aniso.u_23","_atom_site_aniso_U_23"],r,NaN);return[i,a,n,c,h,m].some(isNaN)?null:new z(i,a,n,c,h,m)}static createBani(t,e){let o;try{o=t.get("_atom_site_aniso")}catch{throw new Error(`Atom ${e} had ADP type BAni, but no atom_site_aniso loop was found`)}const r=o.get(["_atom_site_aniso.label","_atom_site_aniso_label"]).indexOf(e);if(r===-1)throw new Error(`Atom ${e} has ADP type Bani, but was not found in atom_site_aniso.label`);const i=o.getIndex(["_atom_site_aniso.b_11","_atom_site_aniso_B_11"],r,NaN),a=o.getIndex(["_atom_site_aniso.b_22","_atom_site_aniso_B_22"],r,NaN),n=o.getIndex(["_atom_site_aniso.b_33","_atom_site_aniso_B_33"],r,NaN),c=o.getIndex(["_atom_site_aniso.b_12","_atom_site_aniso_B_12"],r,NaN),h=o.getIndex(["_atom_site_aniso.b_13","_atom_site_aniso_B_13"],r,NaN),m=o.getIndex(["_atom_site_aniso.b_23","_atom_site_aniso_B_23"],r,NaN);return[i,a,n,c,h,m].some(isNaN)?null:z.fromBani(i,a,n,c,h,m)}static createUiso(t,e){try{const s=t.get("_atom_site").getIndex(["_atom_site.u_iso_or_equiv","_atom_site_U_iso_or_equiv"],e,NaN);return isNaN(s)?null:new I(s)}catch{return null}}static createBiso(t,e){try{const s=t.get("_atom_site").getIndex(["_atom_site.b_iso_or_equiv","_atom_site_B_iso_or_equiv"],e,NaN);return isNaN(s)?null:I.fromBiso(s)}catch{return null}}}const E=g.create(g.all);function Ct(l){if(Math.abs(l)<.0021)return"";const t=[2,3,4,6],e=l<0?"-":"",o=Math.abs(l);if(Math.abs(o-Math.round(o))<.0021)return e+Math.round(o);for(const s of t){const r=o*s,i=Math.round(r);if(Math.abs(r-i)<.0021)return i===s?e+"1":e+i+"/"+s}return e+o.toString()}class F{constructor(t){const{matrix:e,vector:o}=this.parseSymmetryInstruction(t);this.rotMatrix=e,this.transVector=o}parseSymmetryInstruction(t){const e=Array(3).fill().map(()=>Array(3).fill(0)),o=Array(3).fill(0),s=t.split(",").map(r=>r.trim().toUpperCase());if(s.length!==3)throw new Error("Symmetry operation must have exactly three components");return s.forEach((r,i)=>{const a=/([+-]?\d*\.?\d*(?:\/\d+)?)\*?([XYZ])/g;let n;for(;(n=a.exec(r))!==null;){let m=n[1];const f=n[2];if(!m||m==="+")m="1";else if(m==="-")m="-1";else if(m.includes("/")){const[u,_]=m.split("/");m=parseFloat(u)/parseFloat(_)}m=parseFloat(m);const y=f==="X"?0:f==="Y"?1:2;e[i][y]=m}const h=r.replace(/[+-]?\d*\.?\d*(?:\/\d+)?\*?[XYZ]/g,"").match(/[+-]?\d*\.?\d+(?:\/\d+)?/g)||[];for(const m of h)if(m.includes("/")){const[f,y]=m.split("/");o[i]+=parseFloat(f)/parseFloat(y)}else o[i]+=parseFloat(m)}),{matrix:e,vector:o}}static fromCIF(t,e){const s=t.get(["_space_group_symop","_symmetry_equiv","_space_group_symop.operation_xyz","_space_group_symop_operation_xyz","_symmetry_equiv.pos_as_xyz","_symmetry_equiv_pos_as_xyz"]).getIndex(["_space_group_symop.operation_xyz","_space_group_symop_operation_xyz","_symmetry_equiv.pos_as_xyz","_symmetry_equiv_pos_as_xyz"],e);return new F(s)}applyToPoint(t){const e=E.add(E.multiply(this.rotMatrix,t),this.transVector);return Array.isArray(e)?e:e.toArray()}applyToAtom(t){const e=new wt(...E.add(E.multiply(this.rotMatrix,[t.position.x,t.position.y,t.position.z]),this.transVector));let o=null;if(t.adp&&t.adp instanceof z){const s=[[t.adp.u11,t.adp.u12,t.adp.u13],[t.adp.u12,t.adp.u22,t.adp.u23],[t.adp.u13,t.adp.u23,t.adp.u33]],r=this.rotMatrix,i=E.transpose(r),a=E.multiply(E.multiply(r,s),i);o=new z(a[0][0],a[1][1],a[2][2],a[0][1],a[0][2],a[1][2])}else t.adp&&t.adp instanceof I&&(o=new I(t.adp.uiso));return new K(t.label,t.atomType,e,o,t.disorderGroup)}applyToAtoms(t){return t.map(e=>this.applyToAtom(e))}copy(){const t=new F("x,y,z");return t.rotMatrix=E.clone(this.rotMatrix),t.transVector=E.clone(this.transVector),t}toSymmetryString(t=null){const e=["x","y","z"],o=[],s=t?E.add(this.transVector,t):this.transVector;for(let r=0;r<3;r++){let i="";const a=[];for(let n=0;n<3;n++){const c=this.rotMatrix[r][n];if(Math.abs(c)>1e-10)if(Math.abs(Math.abs(c)-1)<1e-10)a.push(c>0?e[n]:`-${e[n]}`);else{const h=Ct(Math.abs(c));a.push(c>0?`${h}${e[n]}`:`-${h}${e[n]}`)}}if(i=a.join("+"),i===""&&(i="0"),Math.abs(s[r])>1e-10){const n=Ct(Math.abs(s[r])),c=s[r]<0?`-${n}`:n;i==="0"?i=c:i.startsWith("-")?i=`${c}${i}`:i=`${c}+${i}`}o.push(i)}return o.join(",")}}class U{constructor(t,e,o,s=null){var r;this.spaceGroupName=t,this.spaceGroupNumber=e,this.symmetryOperations=o,this.operationIds=s||new Map(o.map((i,a)=>[(a+1).toString(),a])),this.identitySymOpId=(r=Array.from(this.operationIds.entries()).find(([i,a])=>{const n=this.symmetryOperations[a];return E.equal(n.rotMatrix,E.identity(3))&&E.equal(n.transVector,E.zeros(3))}))==null?void 0:r[0]}generateEquivalentPositions(t){return this.symmetryOperations.map(e=>e.applyToPoint(t))}parsePositionCode(t){let e,o;try{const[i,a]=t.split("_");o=i,e=a.split("").map(n=>parseInt(n)-5)}catch{o=t.toString(),e=[0,0,0]}const s=this.operationIds.get(o);if(s===void 0)throw new Error(`Invalid symmetry operation ID in string ${t}: ${o}, expecting string format "<symOpId>_abc". ID entry in present symOp loop?`);return{symOp:this.symmetryOperations[s],transVector:e}}applySymmetry(t,e){const{symOp:o,transVector:s}=this.parsePositionCode(t);if(Array.isArray(e)){const i=o.applyToAtoms(e);return i.forEach(a=>{a.position.x+=s[0],a.position.y+=s[1],a.position.z+=s[2]}),i}const r=o.applyToAtom(e);return r.position.x+=s[0],r.position.y+=s[1],r.position.z+=s[2],r}static fromCIF(t){const e=t.get(["_space_group.name_h-m_alt","_space_group.name_H-M_full","_symmetry_space_group_name_H-M","_space_group_name_H-M_alt"],"Unknown"),o=t.get(["_space_group.it_number","_space_group.IT_number","_symmetry_Int_Tables_number","_space_group_IT_number"],0),s=t.get(["_space_group_symop","_symmetry_equiv","_symmetry_equiv_pos","_space_group_symop.operation_xyz","_space_group_symop_operation_xyz","_symmetry_equiv.pos_as_xyz","_symmetry_equiv_pos_as_xyz"],!1);if(s&&!(s instanceof Z))return new U(e,o,[new F(s)]);if(s||console.warn(Object.keys(t).filter(r=>r.includes("sym"))),s){const r=s.get(["_space_group_symop.operation_xyz","_space_group_symop_operation_xyz","_symmetry_equiv.pos_as_xyz","_symmetry_equiv_pos_as_xyz"]);let i=null;try{const n=s.get(["_space_group_symop.id","_space_group_symop_id","_symmetry_equiv.id","_symmetry_equiv_pos_site_id"]);i=new Map(n.map((c,h)=>[c.toString(),h]))}catch{}const a=r.map(n=>new F(n));return new U(e,o,a,i)}else return console.warn("No symmetry operations found in CIF block, will use P1"),new U("Unknown",0,[new F("x,y,z")])}}class H{constructor(t,e,o=null,s=null,r=null){this.atom1Label=t,this.atom2Label=e,this.bondLength=o,this.bondLengthSU=s,this.atom2SiteSymmetry=r}static fromCIF(t,e){const o=t.get("_geom_bond");let s=o.getIndex(["_geom_bond.site_symmetry_2","_geom_bond_site_symmetry_2"],e,".");const r=o.getIndex(["_geom_bond.site_symmetry_1","_geom_bond_site_symmetry_1"],e,!1);return r&&r===s&&(s="."),new H(o.getIndex(["_geom_bond.atom_site_label_1","_geom_bond_atom_site_label_1"],e),o.getIndex(["_geom_bond.atom_site_label_2","_geom_bond_atom_site_label_2"],e),o.getIndex(["_geom_bond.distance","_geom_bond_distance"],e),o.getIndex(["_geom_bond.distance_su","_geom_bond_distance_su"],e,NaN),s!=="?"?s:".")}}class G{constructor(t,e,o,s,r,i,a,n,c,h,m,f){this.donorAtomLabel=t,this.hydrogenAtomLabel=e,this.acceptorAtomLabel=o,this.donorHydrogenDistance=s,this.donorHydrogenDistanceSU=r,this.acceptorHydrogenDistance=i,this.acceptorHydrogenDistanceSU=a,this.donorAcceptorDistance=n,this.donorAcceptorDistanceSU=c,this.hBondAngle=h,this.hBondAngleSU=m,this.acceptorAtomSymmetry=f}static fromCIF(t,e){const o=t.get("_geom_hbond"),s=o.getIndex(["_geom_hbond.site_symmetry_a","_geom_hbond_site_symmetry_A"],e,".");return new G(o.getIndex(["_geom_hbond.atom_site_label_d","_geom_hbond_atom_site_label_D"],e),o.getIndex(["_geom_hbond.atom_site_label_h","_geom_hbond_atom_site_label_H"],e),o.getIndex(["_geom_hbond.atom_site_label_a","_geom_hbond_atom_site_label_A"],e),o.getIndex(["_geom_hbond.distance_dh","_geom_hbond_distance_DH"],e,NaN),o.getIndex(["_geom_hbond.distance_dh_su","_geom_hbond_distance_DH_su"],e,NaN),o.getIndex(["_geom_hbond.distance_ha","_geom_hbond_distance_HA"],e,NaN),o.getIndex(["_geom_hbond.distance_ha_su","_geom_hbond_distance_HA_su"],e,NaN),o.getIndex(["_geom_hbond.distance_da","_geom_hbond_distance_DA"],e,NaN),o.getIndex(["_geom_hbond.distance_da_su","_geom_hbond_distance_DA_su"],e,NaN),o.getIndex(["_geom_hbond.angle_dha","_geom_hbond_angle_DHA"],e,NaN),o.getIndex(["_geom_hbond.angle_dha_su","_geom_hbond_angle_DHA_su"],e,NaN),s!=="?"?s:".")}}class vt{constructor(){this.atomLabelErrors=[],this.symmetryErrors=[]}addAtomLabelError(t){this.atomLabelErrors.push(t)}addSymmetryError(t){this.symmetryErrors.push(t)}isValid(){return this.atomLabelErrors.length+this.symmetryErrors.length===0}report(t,e){let o="";return this.atomLabelErrors.length!==0&&(o+=`Unknown atom label(s). Known labels are 
`,o+=t.map(s=>s.label).join(", "),o+=`
`,o+=this.atomLabelErrors.join(`
`)),this.symmetryErrors.length!==0&&(o.length!==0&&(o+=`
`),o+="Unknown symmetry ID(s) or String format. Expected format is <id>_abc. ",o+=`Known IDs are:
`,o+=Array.from(e.operationIds.keys()).join(", "),o+=`
`,o+=this.symmetryErrors.join(`
`)),o}}class O{static createBonds(t,e){try{const o=t.get("_geom_bond"),s=o.get(["_geom_bond.atom_site_label_1","_geom_bond_atom_site_label_1"]).length,r=[];for(let i=0;i<s;i++){const a=o.getIndex(["_geom_bond.atom_site_label_1","_geom_bond_atom_site_label_1"],i),n=o.getIndex(["_geom_bond.atom_site_label_2","_geom_bond_atom_site_label_2"],i);O.isValidBondPair(a,n,e)&&r.push(H.fromCIF(t,i))}return r}catch{return[]}}static createHBonds(t,e){const o=t.get("_geom_hbond",!1);if(!o)return[];const s=o.get(["_geom_hbond.atom_site_label_d","_geom_hbond_atom_site_label_D"]).length,r=[];for(let i=0;i<s;i++){const a=o.getIndex(["_geom_hbond.atom_site_label_d","_geom_hbond_atom_site_label_D"],i,"?"),n=o.getIndex(["_geom_hbond.atom_site_label_h","_geom_hbond_atom_site_label_H"],i,"?"),c=o.getIndex(["_geom_hbond.atom_site_label_a","_geom_hbond_atom_site_label_A"],i,"?");O.isValidHBondTriplet(a,n,c,e)&&r.push(G.fromCIF(t,i))}return r}static validateBonds(t,e,o){const s=new vt,r=new Set(e.map(i=>i.label));for(const i of t){const a=[];if(r.has(i.atom1Label)||a.push(i.atom1Label),r.has(i.atom2Label)||a.push(i.atom2Label),a.length>0&&s.addAtomLabelError(`Non-existent atoms in bond: ${i.atom1Label} - ${i.atom2Label}, non-existent atom(s): ${a.join(", ")}`),i.atom2SiteSymmetry&&i.atom2SiteSymmetry!==".")try{o.parsePositionCode(i.atom2SiteSymmetry)}catch{s.addSymmetryError(`Invalid symmetry in bond: ${i.atom1Label} - ${i.atom2Label}, invalid symmetry operation: ${i.atom2SiteSymmetry}`)}}return s}static validateHBonds(t,e,o){const s=new vt,r=new Set(e.map(i=>i.label));for(const i of t){const a=[];if(r.has(i.donorAtomLabel)||a.push(i.donorAtomLabel),r.has(i.hydrogenAtomLabel)||a.push(i.hydrogenAtomLabel),r.has(i.acceptorAtomLabel)||a.push(i.acceptorAtomLabel),a.length>0&&s.addAtomLabelError(`Non-existent atoms in H-bond: ${i.donorAtomLabel} - ${i.hydrogenAtomLabel} - ${i.acceptorAtomLabel}, non-existent atom(s): ${a.join(", ")}`),i.acceptorAtomSymmetry&&i.acceptorAtomSymmetry!==".")try{o.parsePositionCode(i.acceptorAtomSymmetry)}catch{s.addSymmetryError(`Invalid symmetry in H-bond: ${i.donorAtomLabel} - ${i.hydrogenAtomLabel} - ${i.acceptorAtomLabel}, invalid symmetry operation: ${i.acceptorAtomSymmetry}`)}}return s}static isValidLabel(t){return/^(Cg|Cnt|CG|CNT)/.test(t)}static isValidBondPair(t,e,o){const s=O.isValidLabel(t),r=O.isValidLabel(e);return t==="?"||e==="?"?!1:(!s||o.has(t))&&(!r||o.has(e))}static isValidHBondTriplet(t,e,o,s){const r=O.isValidLabel(t),i=O.isValidLabel(e),a=O.isValidLabel(o);return t==="?"||e==="?"||o==="?"?!1:(!r||s.has(t))&&(!i||s.has(e))&&(!a||s.has(o))}}function Q(l){if(!l||typeof l!="string")throw new Error(`Invalid atom label: ${l}`);const t=l.toUpperCase(),e=["HE","LI","BE","NE","NA","MG","AL","SI","CL","AR","CA","SC","TI","CR","MN","FE","CO","NI","CU","ZN","GA","GE","AS","SE","BR","KR","RB","SR","ZR","NB","MO","TC","RU","RH","PD","AG","CD","IN","SN","SB","TE","XE","CS","BA","LA","CE","PR","ND","PM","SM","EU","GD","TB","DY","HO","ER","TM","YB","LU","HF","TA","RE","OS","IR","PT","AU","HG","TL","PB","BI","PO","AT","RN","FR","RA","AC","TH","PA","NP","PU","AM","CM"],o=new RegExp(`^(${e.join("|")})`),s=t.match(o);if(s)return St(s[1]);const r=t.match(/^(H|B|C|N|O|F|P|S|K|V|Y|I|W|U|D)/);if(r)return St(r[1]);throw new Error(`Could not infer element type from atom label: ${l}`)}function St(l){return l.length===1?l:l[0]+l[1].toLowerCase()}class T{constructor(t,e,o=[],s=[],r=null){this.cell=t,this.atoms=e,this.bonds=o,this.hBonds=s,this.recalculateConnectedGroups(),this.symmetry=r||new U("None",0,[new F("x,y,z")])}static fromCIF(t){const e=nt.fromCIF(t),s=t.get("_atom_site").get(["_atom_site.label","_atom_site_label"]),r=Array.from({length:s.length},(f,y)=>{try{return K.fromCIF(t,y)}catch(u){if(u.message.includes("Dummy atom"))return null;throw u}}).filter(f=>f!==null);if(r.length===0)throw new Error("The cif file contains no valid atoms.");const i=new Set(r.map(f=>f.label)),a=O.createBonds(t,i),n=O.createHBonds(t,i),c=U.fromCIF(t),h=O.validateBonds(a,r,c),m=O.validateHBonds(n,r,c);if(!h.isValid()||!m.isValid()){const f=`There were errors in the bond or H-bond creation
`,y=h.report(r,c),u=m.report(r,c);throw y.length!==0&&u.length!==0?new Error(f+y+`
`+u):new Error(f+y+u)}return new T(e,r,a,n,c)}getAtomByLabel(t){for(const o of this.atoms)if(o.label===t)return o;const e=this.atoms.map(o=>o.label).join(", ");throw new Error(`Could not find atom with label: ${t}, available are: ${e}`)}recalculateConnectedGroups(){const t=new Map,e=[],o=r=>{if(t.has(r.label))return t.get(r.label);const i={atoms:new Set,bonds:new Set,hBonds:new Set};return e.push(i),i};for(const r of this.bonds){const i=this.getAtomByLabel(r.atom1Label),a=this.getAtomByLabel(r.atom2Label);if(r.atom2SiteSymmetry!=="."&&r.atom2SiteSymmetry!==null)continue;const n=t.get(i.label),c=t.get(a.label),h=n||c;if(h){if(h.atoms.add(i),h.atoms.add(a),h.bonds.add(r),t.set(i.label,h),t.set(a.label,h),n&&c&&n!==c){for(const m of c.atoms)n.atoms.add(m),t.set(m.label,n);for(const m of c.bonds)n.bonds.add(m);e.splice(e.indexOf(c),1)}}else{const m=o(i);m.atoms.add(i),m.atoms.add(a),m.bonds.add(r),t.set(i.label,m),t.set(a.label,m)}}for(const r of this.hBonds){const i=this.getAtomByLabel(r.donorAtomLabel),a=this.getAtomByLabel(r.acceptorAtomLabel);if(r.acceptorAtomSymmetry!=="."&&r.acceptorAtomSymmetry!==null)continue;o(i).hBonds.add(r),t.has(a.label)&&o(a).hBonds.add(r)}this.atoms.filter(r=>!e.some(i=>i.atoms.has(r))).forEach(r=>{const i={atoms:new Set([r]),bonds:new Set,hBonds:new Set};e.push(i)}),this.connectedGroups=e.map(r=>({atoms:Array.from(r.atoms),bonds:Array.from(r.bonds),hBonds:Array.from(r.hBonds)}))}}class nt{constructor(t,e,o,s,r,i){this._a=t,this._b=e,this._c=o,this._alpha=s,this._beta=r,this._gamma=i,this.fractToCartMatrix=B(this)}static fromCIF(t){const e=[t.get(["_cell.length_a","_cell_length_a"],-9999.9),t.get(["_cell.length_b","_cell_length_b"],-9999.9),t.get(["_cell.length_c","_cell_length_c"],-9999.9),t.get(["_cell.angle_alpha","_cell_angle_alpha"],-9999.9),t.get(["_cell.angle_beta","_cell_angle_beta"],-9999),t.get(["_cell.angle_gamma","_cell_angle_gamma"],-9999.9)];if(e.some(o=>o<0)){const o=["a","b","c","alpha","beta","gamma"],s=[];e.forEach((i,a)=>{i<0&&s.push(o[a])});const r=s.join(", ");throw new Error(`Unit cell parameter entries missing in CIF or negative for cell parameters: ${r}`)}return new nt(...e)}get a(){return this._a}set a(t){if(t<=0)throw new Error("Cell parameter 'a' must be positive");this._a=t,this.fractToCartMatrix=B(this)}get b(){return this._b}set b(t){if(t<=0)throw new Error("Cell parameter 'b' must be positive");this._b=t,this.fractToCartMatrix=B(this)}get c(){return this._c}set c(t){if(t<=0)throw new Error("Cell parameter 'c' must be positive");this._c=t,this.fractToCartMatrix=B(this)}get alpha(){return this._alpha}set alpha(t){if(t<=0||t>=180)throw new Error("Angle alpha must be between 0 and 180 degrees");this._alpha=t,this.fractToCartMatrix=B(this)}get beta(){return this._beta}set beta(t){if(t<=0||t>=180)throw new Error("Angle beta must be between 0 and 180 degrees");this._beta=t,this.fractToCartMatrix=B(this)}get gamma(){return this._gamma}set gamma(t){if(t<=0||t>=180)throw new Error("Angle gamma must be between 0 and 180 degrees");this._gamma=t,this.fractToCartMatrix=B(this)}}class K{constructor(t,e,o,s=null,r=0){this.label=String(t),this.atomType=e,this.position=o,this.adp=s,this.disorderGroup=r}static fromCIF(t,e=null,o=null){const s=t.get("_atom_site"),r=s.get(["_atom_site.label","_atom_site_label"]);let i=e;if(e===null&&o)i=r.indexOf(o);else if(e===null)throw new Error("either atomIndex or atomLabel need to be provided");const a=r[i],n=[".","?"];if(n.includes(a))throw new Error("Dummy atom: Invalid label");if(String(s.getIndex(["_atom_site.calc_flag","_atom_site_calc_flag"],i,"")).toLowerCase()==="dum")throw new Error("Dummy atom: calc_flag is dum");let h=s.getIndex(["_atom_site.type_symbol","_atom_site_type_symbol"],i,!1);if(h||(h=Q(a)),n.includes(h))throw new Error("Dummy atom: Invalid atom type");const m=qt.fromCIF(t,i),f=D.fromCIF(t,i),y=s.getIndex(["_atom_site.disorder_group","_atom_site_disorder_group"],i,".");return new K(a,h,m,f,y==="."?0:y)}}const w={camera:{minDistance:1,maxDistance:100,wheelZoomSpeed:8e-4,pinchZoomSpeed:.001,initialPosition:[0,0,10],fov:45,near:.1,far:1e3},selection:{mode:"multiple",markerMult:1.3,bondMarkerMult:1.7,markerSegments:32,highlightEmissive:11184810,markerColors:[2062260,16744206,2924588,14034728,9725885,9197131,14907330,8355711,12369186,1556175]},interaction:{rotationSpeed:5,clickThreshold:200,mouseRaycast:{lineThreshold:.5,pointsThreshold:.5,meshThreshold:.1},touchRaycast:{lineThreshold:2,pointsThreshold:2,meshThreshold:.2}},renderMode:"onDemand",hydrogenMode:"none",disorderMode:"all",symmetryMode:"bonds-no-hbonds-no",bondGrowToleranceFactor:1.2,fixCifErrors:!1,atomDetail:3,atomColorRoughness:.3,atomColorMetalness:.5,atomADPRingWidthFactor:1,atomADPRingHeight:.06,atomADPRingSections:18,atomADPInnerSections:7,atomConstantRadiusMultiplier:.25,bondRadius:.05,bondSections:15,bondColor:"#666666",bondColorRoughness:.3,bondColorMetalness:.1,hbondRadius:.04,hbondColor:"#AAAAAA",hbondColorRoughness:.3,hbondColorMetalness:.1,hbondDashSegmentLength:.3,hbondDashFraction:.6,elementProperties:{H:{radius:.31,atomColor:"#ffffff",ringColor:"#000000"},D:{radius:.31,atomColor:"#ffffff",ringColor:"#000000"},He:{radius:.28,atomColor:"#d9ffff",ringColor:"#000000"},Li:{radius:1.28,atomColor:"#cc80ff",ringColor:"#000000"},Be:{radius:.96,atomColor:"#c2ff00",ringColor:"#000000"},B:{radius:.85,atomColor:"#ffb5b5",ringColor:"#000000"},C:{radius:.76,atomColor:"#000000",ringColor:"#ffffff"},N:{radius:.71,atomColor:"#3050f8",ringColor:"#ffffff"},O:{radius:.66,atomColor:"#ff0d0d",ringColor:"#ffffff"},F:{radius:.57,atomColor:"#90e050",ringColor:"#000000"},Ne:{radius:.58,atomColor:"#b3e3f5",ringColor:"#000000"},Na:{radius:1.66,atomColor:"#ab5cf2",ringColor:"#ffffff"},Mg:{radius:1.41,atomColor:"#8aff00",ringColor:"#000000"},Al:{radius:1.21,atomColor:"#bfa6a6",ringColor:"#000000"},Si:{radius:1.11,atomColor:"#f0c8a0",ringColor:"#000000"},P:{radius:1.07,atomColor:"#ff8000",ringColor:"#000000"},S:{radius:1.05,atomColor:"#ffff30",ringColor:"#000000"},Cl:{radius:1.02,atomColor:"#1ff01f",ringColor:"#000000"},Ar:{radius:1.06,atomColor:"#80d1e3",ringColor:"#000000"},K:{radius:2.03,atomColor:"#8f40d4",ringColor:"#ffffff"},Ca:{radius:1.76,atomColor:"#3dff00",ringColor:"#000000"},Sc:{radius:1.7,atomColor:"#e6e6e6",ringColor:"#000000"},Ti:{radius:1.6,atomColor:"#bfc2c7",ringColor:"#000000"},V:{radius:1.53,atomColor:"#a6a6ab",ringColor:"#000000"},Cr:{radius:1.39,atomColor:"#8a99c7",ringColor:"#000000"},Mn:{radius:1.39,atomColor:"#9c7ac7",ringColor:"#000000"},Fe:{radius:1.32,atomColor:"#e06633",ringColor:"#ffffff"},Co:{radius:1.26,atomColor:"#f090a0",ringColor:"#000000"},Ni:{radius:1.24,atomColor:"#50d050",ringColor:"#000000"},Cu:{radius:1.32,atomColor:"#c88033",ringColor:"#000000"},Zn:{radius:1.22,atomColor:"#7d80b0",ringColor:"#000000"},Ga:{radius:1.22,atomColor:"#c28f8f",ringColor:"#000000"},Ge:{radius:1.2,atomColor:"#668f8f",ringColor:"#000000"},As:{radius:1.19,atomColor:"#bd80e3",ringColor:"#000000"},Se:{radius:1.2,atomColor:"#ffa100",ringColor:"#000000"},Br:{radius:1.2,atomColor:"#a62929",ringColor:"#ffffff"},Kr:{radius:1.16,atomColor:"#5cb8d1",ringColor:"#000000"},Rb:{radius:2.2,atomColor:"#702eb0",ringColor:"#ffffff"},Sr:{radius:1.95,atomColor:"#00ff00",ringColor:"#000000"},Y:{radius:1.9,atomColor:"#94ffff",ringColor:"#000000"},Zr:{radius:1.75,atomColor:"#94e0e0",ringColor:"#000000"},Nb:{radius:1.64,atomColor:"#73c2c9",ringColor:"#000000"},Mo:{radius:1.54,atomColor:"#54b5b5",ringColor:"#000000"},Tc:{radius:1.47,atomColor:"#3b9e9e",ringColor:"#000000"},Ru:{radius:1.46,atomColor:"#248f8f",ringColor:"#000000"},Rh:{radius:1.42,atomColor:"#0a7d8c",ringColor:"#000000"},Pd:{radius:1.39,atomColor:"#006985",ringColor:"#ffffff"},Ag:{radius:1.45,atomColor:"#c0c0c0",ringColor:"#000000"},Cd:{radius:1.44,atomColor:"#ffd98f",ringColor:"#000000"},In:{radius:1.42,atomColor:"#a67573",ringColor:"#000000"},Sn:{radius:1.39,atomColor:"#668080",ringColor:"#000000"},Sb:{radius:1.39,atomColor:"#9e63b5",ringColor:"#ffffff"},Te:{radius:1.38,atomColor:"#d47a00",ringColor:"#000000"},I:{radius:1.39,atomColor:"#940094",ringColor:"#ffffff"},Xe:{radius:1.4,atomColor:"#429eb0",ringColor:"#000000"},Cs:{radius:2.44,atomColor:"#57178f",ringColor:"#ffffff"},Ba:{radius:2.15,atomColor:"#00c900",ringColor:"#000000"},La:{radius:2.07,atomColor:"#70d4ff",ringColor:"#000000"},Ce:{radius:2.04,atomColor:"#ffffc7",ringColor:"#000000"},Pr:{radius:2.03,atomColor:"#d9ffc7",ringColor:"#000000"},Nd:{radius:2.01,atomColor:"#c7ffc7",ringColor:"#000000"},Pm:{radius:1.99,atomColor:"#a3ffc7",ringColor:"#000000"},Sm:{radius:1.98,atomColor:"#8fffc7",ringColor:"#000000"},Eu:{radius:1.98,atomColor:"#61ffc7",ringColor:"#000000"},Gd:{radius:1.96,atomColor:"#45ffc7",ringColor:"#000000"},Tb:{radius:1.94,atomColor:"#30ffc7",ringColor:"#000000"},Dy:{radius:1.92,atomColor:"#1fffc7",ringColor:"#000000"},Ho:{radius:1.92,atomColor:"#00ff9c",ringColor:"#000000"},Er:{radius:1.89,atomColor:"#00e675",ringColor:"#000000"},Tm:{radius:1.9,atomColor:"#00d452",ringColor:"#000000"},Yb:{radius:1.87,atomColor:"#00bf38",ringColor:"#000000"},Lu:{radius:1.87,atomColor:"#00ab24",ringColor:"#000000"},Hf:{radius:1.75,atomColor:"#4dc2ff",ringColor:"#000000"},Ta:{radius:1.7,atomColor:"#4da6ff",ringColor:"#000000"},W:{radius:1.62,atomColor:"#2194d6",ringColor:"#000000"},Re:{radius:1.51,atomColor:"#267dab",ringColor:"#000000"},Os:{radius:1.44,atomColor:"#266696",ringColor:"#ffffff"},Ir:{radius:1.41,atomColor:"#175487",ringColor:"#ffffff"},Pt:{radius:1.36,atomColor:"#d0d0e0",ringColor:"#000000"},Au:{radius:1.36,atomColor:"#ffd123",ringColor:"#000000"},Hg:{radius:1.32,atomColor:"#b8b8d0",ringColor:"#000000"},Tl:{radius:1.45,atomColor:"#a6544d",ringColor:"#ffffff"},Pb:{radius:1.46,atomColor:"#575961",ringColor:"#ffffff"},Bi:{radius:1.48,atomColor:"#9e4fb5",ringColor:"#ffffff"},Po:{radius:1.4,atomColor:"#ab5c00",ringColor:"#ffffff"},At:{radius:1.5,atomColor:"#754f45",ringColor:"#ffffff"},Rn:{radius:1.5,atomColor:"#428296",ringColor:"#000000"},Fr:{radius:2.6,atomColor:"#420066",ringColor:"#ffffff"},Ra:{radius:2.21,atomColor:"#007d00",ringColor:"#000000"},Ac:{radius:2.15,atomColor:"#70abfa",ringColor:"#000000"},Th:{radius:2.06,atomColor:"#00baff",ringColor:"#000000"},Pa:{radius:2,atomColor:"#00a1ff",ringColor:"#000000"},U:{radius:1.96,atomColor:"#008fff",ringColor:"#000000"},Np:{radius:1.9,atomColor:"#0080ff",ringColor:"#000000"},Pu:{radius:1.87,atomColor:"#006bff",ringColor:"#ffffff"},Am:{radius:1.8,atomColor:"#545cf2",ringColor:"#ffffff"},Cm:{radius:1.69,atomColor:"#785ce3",ringColor:"#ffffff"},Bk:{radius:1.65,atomColor:"#8a4fe3",ringColor:"#ffffff"},Cf:{radius:1.81,atomColor:"#a136d4",ringColor:"#ffffff"}}},Mt=g.create(g.all);class ${constructor(t,e,o,s=[]){if(new.target===$)throw new TypeError("Cannot instantiate BaseFilter directly");this.MODES=Object.freeze(t),this.PREFERRED_FALLBACK_ORDER=Object.freeze(s),this.filterName=o,this._mode=null,this.mode=e}get requiresCameraUpdate(){return!1}get mode(){return this._mode}set mode(t){const e=t.toLowerCase().replace(/_/g,"-"),o=Object.values(this.MODES);if(!o.includes(e))throw new Error(`Invalid ${this.filterName} mode: "${t}". Valid modes are: ${o.join(", ")}`);this._mode=e}ensureValidMode(t){const e=this.getApplicableModes(t);e.includes(this.mode)||(this.mode=this.PREFERRED_FALLBACK_ORDER.find(o=>e.includes(o))||e[0])}apply(t){throw new Error('Method "apply" must be implemented by subclass')}getApplicableModes(t){throw new Error('Method "getApplicableModes" must be implemented by subclass')}cycleMode(t){const e=this.getApplicableModes(t);this.ensureValidMode(t);const o=e.indexOf(this._mode);return this._mode=e[(o+1)%e.length],this._mode}}const M=class M extends ${constructor(t=M.MODES.NONE){super(M.MODES,t,"HydrogenFilter",M.PREFERRED_FALLBACK_ORDER)}apply(t){this.ensureValidMode(t);const e=t.atoms.filter(r=>r.atomType!=="H"||this.mode!==M.MODES.NONE).map(r=>new K(r.label,r.atomType,r.position,r.atomType==="H"&&this.mode===M.MODES.CONSTANT?null:r.adp,r.disorderGroup)),o=t.bonds.filter(r=>{if(this.mode===M.MODES.NONE){const i=t.getAtomByLabel(r.atom1Label),a=t.getAtomByLabel(r.atom2Label);return!(i.atomType==="H"||a.atomType==="H")}return!0}),s=this.mode===M.MODES.NONE?[]:t.hBonds;return new T(t.cell,e,o,s,t.symmetry)}getApplicableModes(t){const e=[M.MODES.NONE];return t.atoms.some(r=>r.atomType==="H")&&(e.push(M.MODES.CONSTANT),t.atoms.some(r=>{var i;return r.atomType==="H"&&((i=r.adp)==null?void 0:i.constructor.name)==="UAnisoADP"})&&e.push(M.MODES.ANISOTROPIC)),e}};R(M,"MODES",Object.freeze({NONE:"none",CONSTANT:"constant",ANISOTROPIC:"anisotropic"})),R(M,"PREFERRED_FALLBACK_ORDER",[M.MODES.ANISOTROPIC,M.MODES.CONSTANT,M.MODES.NONE]);let tt=M;const v=class v extends ${constructor(t=v.MODES.ALL){super(v.MODES,t,"DisorderFilter",v.PREFERRED_FALLBACK_ORDER)}apply(t){this.ensureValidMode(t);const e=t.atoms.filter(r=>!(this.mode===v.MODES.GROUP1&&r.disorderGroup>1||this.mode===v.MODES.GROUP2&&r.disorderGroup===1)),o=t.bonds.filter(r=>{const i=t.getAtomByLabel(r.atom1Label),a=t.getAtomByLabel(r.atom2Label);return!(this.mode===v.MODES.GROUP1&&(i.disorderGroup>1||a.disorderGroup>1)||this.mode===v.MODES.GROUP2&&(i.disorderGroup===1||a.disorderGroup===1))}),s=t.hBonds.filter(r=>{const i=t.getAtomByLabel(r.donorAtomLabel),a=t.getAtomByLabel(r.hydrogenAtomLabel),n=t.getAtomByLabel(r.acceptorAtomLabel);return!(this.mode===v.MODES.GROUP1&&(i.disorderGroup>1||a.disorderGroup>1||n.disorderGroup>1)||this.mode===v.MODES.GROUP2&&(i.disorderGroup===1||a.disorderGroup===1||n.disorderGroup===1))});return new T(t.cell,e,o,s,t.symmetry)}getApplicableModes(t){const e=[v.MODES.ALL];return t.atoms.some(s=>s.disorderGroup>0)&&(t.atoms.some(s=>s.disorderGroup===1)&&e.push(v.MODES.GROUP1),t.atoms.some(s=>s.disorderGroup>1)&&e.push(v.MODES.GROUP2)),e}};R(v,"MODES",Object.freeze({ALL:"all",GROUP1:"group1",GROUP2:"group2"})),R(v,"PREFERRED_FALLBACK_ORDER",[v.MODES.ALL,v.MODES.GROUP1,v.MODES.GROUP2]);let et=v;const b=class b extends ${constructor(t=b.MODES.BONDS_NO_HBONDS_NO){super(b.MODES,t,"SymmetryGrower",b.PREFERRED_FALLBACK_ORDER)}get requiresCameraUpdate(){return!0}static combineSymOpLabel(t,e){return!e||e==="."?t:`${t}@${e}`}findGrowableAtoms(t){const e=t.bonds.filter(({atom2SiteSymmetry:s})=>s&&s!==".").map(({atom2Label:s,atom2SiteSymmetry:r})=>[s,r]),o=t.hBonds.filter(({acceptorAtomSymmetry:s})=>s&&s!==".").map(({acceptorAtomLabel:s,acceptorAtomSymmetry:r})=>[s,r]);return{bondAtoms:e,hBondAtoms:o}}growAtomArray(t,e,o){for(const[s,r]of e){const i=b.combineSymOpLabel(s,r);if(o.labels.has(i))continue;const a=t.connectedGroups.find(c=>c.atoms.some(h=>h.label===s));if(!a)throw new Error(`Atom ${s} is not in any group. Typo or structure.recalculateConnectedGroups()?`);t.symmetry.applySymmetry(r,a.atoms).forEach(c=>{c.label=b.combineSymOpLabel(c.label,r),o.labels.add(c.label),o.atoms.add(c)}),a.bonds.filter(({atom2SiteSymmetry:c})=>c===".").forEach(c=>{o.bonds.add(new H(b.combineSymOpLabel(c.atom1Label,r),b.combineSymOpLabel(c.atom2Label,r),c.bondLength,c.bondLengthSU,"."))}),a.hBonds.filter(({acceptorAtomSymmetry:c})=>c===".").forEach(c=>{o.hBonds.add(new G(b.combineSymOpLabel(c.donorAtomLabel,r),b.combineSymOpLabel(c.hydrogenAtomLabel,r),b.combineSymOpLabel(c.acceptorAtomLabel,r),c.donorHydrogenDistance,c.donorHydrogenDistanceSU,c.acceptorHydrogenDistance,c.acceptorHydrogenDistanceSU,c.donorAcceptorDistance,c.donorAcceptorDistanceSU,c.hBondAngle,c.hBondAngleSU,"."))})}return o}apply(t){this.ensureValidMode(t);const e=this.findGrowableAtoms(t),o={atoms:new Set(t.atoms),bonds:new Set(t.bonds),hBonds:new Set(t.hBonds),labels:new Set(t.atoms.map(({label:i})=>i))};this.mode.startsWith("bonds-yes")&&this.growAtomArray(t,e.bondAtoms,o),this.mode.includes("hbonds-yes")&&this.growAtomArray(t,e.hBondAtoms,o);const s=Array.from(o.atoms);for(const i of t.bonds){if(i.atom2SiteSymmetry===".")continue;const a=b.combineSymOpLabel(i.atom2Label,i.atom2SiteSymmetry);s.some(n=>n.label===a)&&o.bonds.add(new H(i.atom1Label,a,i.bondLength,i.bondLengthSU,"."))}for(const i of t.hBonds){if(i.acceptorAtomSymmetry===".")continue;const a=b.combineSymOpLabel(i.acceptorAtomLabel,i.acceptorAtomSymmetry);s.some(n=>n.label===a)&&o.hBonds.add(new G(i.donorAtomLabel,i.hydrogenAtomLabel,a,i.donorHydrogenDistance,i.donorHydrogenDistanceSU,i.acceptorHydrogenDistance,i.acceptorHydrogenDistanceSU,i.donorAcceptorDistance,i.donorAcceptorDistanceSU,i.hBondAngle,i.hBondAngleSU,"."))}const r=Array.from(o.hBonds).filter(({acceptorAtomLabel:i,hydrogenAtomLabel:a,donorAtomLabel:n})=>{const c=o.labels.has(i),h=o.labels.has(a),m=o.labels.has(n);return c&&h&&m});return new T(t.cell,s,Array.from(o.bonds),r,t.symmetry)}getApplicableModes(t){const e=this.findGrowableAtoms(t),o=e.bondAtoms.length>0,s=e.hBondAtoms.length>0;return!o&&!s?[b.MODES.BONDS_NONE_HBONDS_NONE]:o?s?[b.MODES.BONDS_YES_HBONDS_YES,b.MODES.BONDS_YES_HBONDS_NO,b.MODES.BONDS_NO_HBONDS_YES,b.MODES.BONDS_NO_HBONDS_NO]:[b.MODES.BONDS_YES_HBONDS_NONE,b.MODES.BONDS_NO_HBONDS_NONE]:[b.MODES.BONDS_NONE_HBONDS_YES,b.MODES.BONDS_NONE_HBONDS_NO]}};R(b,"MODES",Object.freeze({BONDS_YES_HBONDS_YES:"bonds-yes-hbonds-yes",BONDS_YES_HBONDS_NO:"bonds-yes-hbonds-no",BONDS_YES_HBONDS_NONE:"bonds-yes-hbonds-none",BONDS_NO_HBONDS_YES:"bonds-no-hbonds-yes",BONDS_NO_HBONDS_NO:"bonds-no-hbonds-no",BONDS_NO_HBONDS_NONE:"bonds-no-hbonds-none",BONDS_NONE_HBONDS_YES:"bonds-none-hbonds-yes",BONDS_NONE_HBONDS_NO:"bonds-none-hbonds-no",BONDS_NONE_HBONDS_NONE:"bonds-none-hbonds-none"})),R(b,"PREFERRED_FALLBACK_ORDER",[b.MODES.BONDS_NO_HBONDS_NO,b.MODES.BONDS_NO_HBONDS_NONE,b.MODES.BONDS_NONE_HBONDS_NO]);let q=b;const V=class V extends ${constructor(t=[],e=V.MODES.OFF){super(V.MODES,e,"AtomLabelFilter",[]),this.filteredLabels=new Set(t)}get requiresCameraUpdate(){return!0}setFilteredLabels(t){this.filteredLabels=new Set(t)}apply(t){if(this.mode===V.MODES.OFF)return t;const e=t.atoms.filter(r=>!this.filteredLabels.has(r.label)),o=t.bonds.filter(r=>!this.filteredLabels.has(r.atom1Label)&&!this.filteredLabels.has(r.atom2Label)),s=t.hBonds.filter(r=>!this.filteredLabels.has(r.donorAtomLabel)&&!this.filteredLabels.has(r.hydrogenAtomLabel)&&!this.filteredLabels.has(r.acceptorAtomLabel));return new T(t.cell,e,o,s,t.symmetry)}getApplicableModes(){return Object.values(V.MODES)}};R(V,"MODES",Object.freeze({ON:"on",OFF:"off"}));let ot=V;const k=class k extends ${constructor(t,e,o=k.MODES.KEEP){super(k.MODES,o,"BondGenerator",k.PREFERRED_FALLBACK_ORDER),this.elementProperties=t,this.toleranceFactor=e}getMaxBondDistance(t,e,o){var i,a;const s=(i=o[t])==null?void 0:i.radius,r=(a=o[e])==null?void 0:a.radius;if(!s||!r)throw new Error(`Missing radius for element ${s?e:t}`);return(s+r)*this.toleranceFactor}generateBonds(t,e){const o=new Set,{cell:s,atoms:r}=t,i=new Map,a=new Map;r.forEach(n=>{const c=n.position.toCartesian(s);if(i.set(n.label,[c.x,c.y,c.z]),Object.prototype.hasOwnProperty.call(e,n.atomType)&&!a.has(n.atomType))a.set(n.atomType,n.atomType);else if(!a.has(n.atomType))try{a.set(n.atomType,Q(n.atomType))}catch{throw new Error(`Missing radius for element ${n.atomType}`)}});for(let n=0;n<r.length;n++){const c=r[n],h=i.get(c.label);for(let m=n+1;m<r.length;m++){const f=r[m],y=i.get(f.label);if((c.atomType==="H"||f.atomType==="H")&&t.bonds.some(W=>W.atom1Label===c.label||W.atom1Label===f.label||W.atom2Label===c.label||W.atom2Label===f.label))continue;const u=Mt.subtract(h,y),_=Mt.norm(u),L=this.getMaxBondDistance(a.get(c.atomType),a.get(f.atomType),e);_<=L&&_>1e-4&&o.add(new H(c.label,f.label,_,null,"."))}}return o}apply(t){this.ensureValidMode(t);let e;switch(this.mode){case k.MODES.KEEP:return t;case k.MODES.ADD:{const o=this.generateBonds(t,this.elementProperties);e=[...t.bonds,...o];break}case k.MODES.REPLACE:e=[...this.generateBonds(t,this.elementProperties)];break;case k.MODES.CREATE:e=[...this.generateBonds(t,this.elementProperties)];break;case k.MODES.IGNORE:e=[...t.bonds];break;default:return t}return new T(t.cell,t.atoms,e,t.hBonds,t.symmetry)}getApplicableModes(t){return t.bonds.length>0?[k.MODES.KEEP,k.MODES.ADD,k.MODES.REPLACE]:[k.MODES.CREATE,k.MODES.IGNORE]}};R(k,"MODES",Object.freeze({KEEP:"keep",ADD:"add",REPLACE:"replace",CREATE:"create",IGNORE:"ignore"})),R(k,"PREFERRED_FALLBACK_ORDER",[k.MODES.KEEP,k.MODES.ADD,k.MODES.REPLACE,k.MODES.CREATE,k.MODES.IGNORE]);let st=k;function Yt(l){const t={position:0,rotation:0,scale:0,matrix:0};function e(o){const s=o.position,r=o.rotation,i=o.scale,a=o.matrix.elements;[s.x,s.y,s.z].some(isNaN)&&(console.log("pos"),console.log(s),console.log(o.userData),t.position++),[r.x,r.y,r.z].some(isNaN)&&(t.rotation++,console.log("rot"),console.log(r),console.log(o.userData)),[i.x,i.y,i.z].some(isNaN)&&(console.log("scale"),console.log(i),console.log(o.userData),t.scale++),a.some(isNaN)&&(t.matrix++,console.log("matrix"),console.log(a),console.log(o.userData));for(const n of o.children)e(n)}return e(l),t}function Wt(l,t){const o=l.getEllipsoidMatrix(t).toArray();return new d.Matrix4(o[0][0],o[0][1],o[0][2],0,o[1][0],o[1][1],o[1][2],0,o[2][0],o[2][1],o[2][2],0,0,0,0,1)}function xt(l,t){const e=t.clone().sub(l),o=e.length();if(o===0)throw new Error("Error in ORTEP Bond Creation. Trying to create a zero length bond.");const s=e.divideScalar(o),r=new d.Vector3(0,1,0),i=new d.Vector3().crossVectors(s,r),a=-Math.acos(s.dot(r));return new d.Matrix4().makeScale(1,o,1).premultiply(new d.Matrix4().makeRotationAxis(i.normalize(),a)).setPosition(l.clone().add(t).multiplyScalar(.5))}class jt{constructor(t={}){const e=t||{};this.options={...w,...e,elementProperties:{...w.elementProperties,...e.elementProperties||{}}},this.scaling=1.5384,this.geometries={},this.materials={},this.elementMaterials={},this.initializeGeometries(),this.initializeMaterials()}initializeGeometries(){this.geometries.atom=new d.IcosahedronGeometry(this.scaling,this.options.atomDetail),this.geometries.adpRing=this.createADPHalfTorus(),this.geometries.bond=new d.CylinderGeometry(this.options.bondRadius,this.options.bondRadius,.98,this.options.bondSections,1,!0),this.geometries.hbond=new d.CylinderGeometry(this.options.hbondRadius,this.options.hbondRadius,.98,this.options.bondSections,1,!0)}initializeMaterials(){this.materials.bond=new d.MeshStandardMaterial({color:this.options.bondColor,roughness:this.options.bondColorRoughness,metalness:this.options.bondColorMetalness}),this.materials.hbond=new d.MeshStandardMaterial({color:this.options.hbondColor,roughness:this.options.hbondColorRoughness,metalness:this.options.hbondColorMetalness})}validateElementType(t){if(!this.options.elementProperties[t])throw new Error(`Unknown element type: ${t}. Please ensure element properties are defined.Pass the type settings as custom options, ifthey are element from periodic table`)}getAtomMaterials(t){let e=t;this.options.elementProperties[e]||(e=Q(t)),this.validateElementType(e);const o=`${e}_materials`;if(!this.elementMaterials[o]){const s=this.options.elementProperties[e],r=new d.MeshStandardMaterial({color:s.atomColor,roughness:this.options.atomColorRoughness,metalness:this.options.atomColorMetalness}),i=new d.MeshStandardMaterial({color:s.ringColor,roughness:this.options.atomColorRoughness,metalness:this.options.atomColorMetalness});this.elementMaterials[o]=[r,i]}return this.elementMaterials[o]}createADPHalfTorus(){const t=new d.TorusGeometry(this.scaling*this.options.atomADPRingWidthFactor,this.options.atomADPRingHeight,this.options.atomADPInnerSections,this.options.atomADPRingSections),e=t.attributes.position.array,o=t.index.array,s=[],r=[],i=new Set;for(let h=0;h<o.length;h+=3){const m=o[h]*3,f=o[h+1]*3,y=o[h+2]*3,u=[m,f,y].map(_=>({index:_/3,distance:Math.sqrt(e[_]*e[_]+e[_+1]*e[_+1]+e[_+2]*e[_+2])}));u.some(_=>_.distance>=this.scaling)&&u.forEach(_=>i.add(o[h+_.index%3]))}const a=new Map;let n=0;i.forEach(h=>{const m=h*3;s.push(e[m],e[m+1],e[m+2]),a.set(h,n++)});for(let h=0;h<o.length;h+=3)i.has(o[h])&&i.has(o[h+1])&&i.has(o[h+2])&&r.push(a.get(o[h]),a.get(o[h+1]),a.get(o[h+2]));const c=new d.BufferGeometry;return c.setAttribute("position",new d.Float32BufferAttribute(s,3)),c.setIndex(r),c.computeVertexNormals(),c.rotateX(.5*Math.PI),t.dispose(),c}dispose(){Object.values(this.geometries).forEach(t=>t.dispose()),Object.values(this.materials).forEach(t=>t.dispose()),Object.values(this.elementMaterials).forEach(([t,e])=>{t.dispose(),e.dispose()})}}class Dt{constructor(t,e={}){const o=e||{},s={...w.elementProperties};o.elementProperties&&Object.entries(o.elementProperties).forEach(([r,i])=>{s[r]={...s[r],...i}}),this.options={...w,...o,elementProperties:s},this.crystalStructure=t,this.cache=new jt(this.options),this.createStructure()}createStructure(){this.atoms3D=[],this.bonds3D=[],this.hBonds3D=[];const t=this.crystalStructure.atoms.map(s=>s.label);for(const s of this.crystalStructure.atoms){const[r,i]=this.cache.getAtomMaterials(s.atomType);s.adp instanceof z?this.atoms3D.push(new Kt(s,this.crystalStructure.cell,this.cache.geometries.atom,r,this.cache.geometries.adpRing,i)):s.adp instanceof I?this.atoms3D.push(new Xt(s,this.crystalStructure.cell,this.cache.geometries.atom,r)):this.atoms3D.push(new Zt(s,this.crystalStructure.cell,this.cache.geometries.atom,r,this.options))}const e=this.crystalStructure.bonds.map(s=>new H(s.atom1Label,q.combineSymOpLabel(s.atom2Label,s.atom2SiteSymmetry),s.bondLength,s.bondLengthSU,".")).filter(s=>t.includes(s.atom2Label));for(const s of e)try{this.bonds3D.push(new Jt(s,this.crystalStructure,this.cache.geometries.bond,this.cache.materials.bond))}catch(r){if(r.message!=="Error in ORTEP Bond Creation. Trying to create a zero length bond.")throw r}const o=this.crystalStructure.hBonds.map(s=>new G(s.donorAtomLabel,s.hydrogenAtomLabel,q.combineSymOpLabel(s.acceptorAtomLabel,s.acceptorAtomSymmetry),s.donorHydrogenDistance,s.donorHydrogenDistanceSU,s.acceptorHydrogenDistance,s.acceptorHydrogenDistanceSU,s.donorAcceptorDistance,s.donorAcceptorDistanceSU,s.hBondAngle,s.hBondAngleSU,".")).filter(s=>t.includes(s.acceptorAtomLabel));for(const s of o)try{this.hBonds3D.push(new Qt(s,this.crystalStructure,this.cache.geometries.hbond,this.cache.materials.hbond,this.options.hbondDashSegmentLength,this.options.hbondDashFraction))}catch(r){if(r.message!=="Error in ORTEP Bond Creation. Trying to create a zero length bond.")throw r}}getGroup(){const t=new d.Group;for(const e of this.atoms3D)t.add(e);for(const e of this.bonds3D)t.add(e);for(const e of this.hBonds3D)t.add(e);return Yt(t),t}dispose(){this.cache.dispose()}}class rt extends d.Mesh{constructor(t,e){if(new.target===rt)throw new TypeError("ORTEPObject is an abstract class and cannot be instantiated directly.");super(t,e),this._selectionColor=null,this.marker=null}get selectionColor(){return this._selectionColor}createSelectionMaterial(t){return new d.MeshBasicMaterial({color:t,transparent:!0,opacity:.9,side:d.BackSide})}select(t,e){var r;this._selectionColor=t;const o=this.material.clone();(r=o.emissive)==null||r.setHex(e.selection.highlightEmissive),this.originalMaterial=this.material,this.material=o;const s=this.createSelectionMarker(t,e);this.add(s),this.marker=s}deselect(){this._selectionColor=null,this.removeSelectionMarker()}createSelectionMarker(t,e){throw new Error("createSelectionMarker needs to be implemented in a subclass")}removeSelectionMarker(){var t,e;this.marker&&(this.remove(this.marker),(t=this.marker.geometry)==null||t.dispose(),(e=this.marker.material)==null||e.dispose(),this.marker=null),this.originalMaterial&&(this.material.dispose(),this.material=this.originalMaterial,this.originalMaterial=null)}dispose(){var t,e;this.deselect(),(t=this.geometry)==null||t.dispose(),(e=this.material)==null||e.dispose()}}class lt extends rt{constructor(t,e,o,s){super(o,s);const r=new d.Vector3(...t.position.toCartesian(e));this.position.copy(r),this.userData={type:"atom",atomData:t,selectable:!0}}createSelectionMarker(t,e){const o=new d.Mesh(this.geometry,this.createSelectionMaterial(t));return o.scale.multiplyScalar(e.selection.markerMult),o.userData.selectable=!1,o}}class Kt extends lt{constructor(t,e,o,s,r,i){if(super(t,e,o,s),[t.adp.u11,t.adp.u3,t.adp.u33].some(n=>n<=0))this.geometry=new d.TetrahedronGeometry(.8);else{const n=Wt(t.adp,e);if(n.toArray().includes(NaN))this.geometry=new d.TetrahedronGeometry(.8);else{for(const c of this.adpRingMatrices){const h=new d.Mesh(r,i);h.applyMatrix4(c),h.userData.selectable=!1,this.add(h)}this.applyMatrix4(n)}}const a=new d.Vector3(...t.position.toCartesian(e));this.position.copy(a),this.userData={type:"atom",atomData:t,selectable:!0}}get adpRingMatrices(){return[new d.Matrix4().set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),new d.Matrix4().set(1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1),new d.Matrix4().set(0,-1,0,0,1,0,0,0,0,0,1,0,0,0,0,1)]}}class Xt extends lt{constructor(t,e,o,s){if(super(t,e,o,s),!t.adp||!("uiso"in t.adp))throw new Error("Atom must have isotropic displacement parameters (UIsoADP)");t.adp.uiso<=0?this.geometry=new d.TetrahedronGeometry(1):this.scale.multiplyScalar(Math.sqrt(t.adp.uiso))}}class Zt extends lt{constructor(t,e,o,s,r){super(t,e,o,s);let i=t.atomType;try{r.elementProperties[i]||(i=Q(t.atomType))}catch{throw new Error(`Element properties not found for atom type: '${t.atomType}'`)}this.scale.multiplyScalar(r.atomConstantRadiusMultiplier*r.elementProperties[i].radius)}}class Jt extends rt{constructor(t,e,o,s){super(o,s);const r=e.getAtomByLabel(t.atom1Label),i=e.getAtomByLabel(t.atom2Label),a=new d.Vector3(...r.position.toCartesian(e.cell)),n=new d.Vector3(...i.position.toCartesian(e.cell)),c=xt(a,n);this.applyMatrix4(c),this.userData={type:"bond",bondData:t,selectable:!0}}createSelectionMarker(t,e){const o=new d.Mesh(this.geometry,this.createSelectionMaterial(t));return o.scale.x*=e.selection.bondMarkerMult,o.scale.z*=e.selection.bondMarkerMult,o.userData.selectable=!1,o}}class ct extends d.Group{constructor(){if(new.target===ct)throw new TypeError("ORTEPGroupObject is an abstract class and cannot be instantiated directly.");super(),this._selectionColor=null,this.marker=null}get selectionColor(){return this._selectionColor}add(...t){return t.forEach(e=>{if(e instanceof d.Mesh){const o=e.raycast;e.raycast=(s,r)=>{const i=[];if(o.call(e,s,i),i.length>0){const a=i[0];r.push({distance:a.distance,point:a.point,object:this,face:a.face,faceIndex:a.faceIndex,uv:a.uv})}}}}),super.add(...t)}createSelectionMaterial(t){return new d.MeshBasicMaterial({color:t,transparent:!0,opacity:.9,side:d.BackSide})}select(t,e){this._selectionColor=t,this.traverse(s=>{var r;if(s instanceof d.Mesh){const i=s.material.clone();(r=i.emissive)==null||r.setHex(e.selection.highlightEmissive),s.originalMaterial=s.material,s.material=i}});const o=this.createSelectionMarker(t,e);this.add(o),this.marker=o}deselect(){this._selectionColor=null,this.marker&&(this.remove(this.marker),this.marker.traverse(t=>{var e,o;t instanceof d.Mesh&&((e=t.geometry)==null||e.dispose(),(o=t.material)==null||o.dispose())}),this.marker=null),this.traverse(t=>{t instanceof d.Mesh&&t.originalMaterial&&(t.material.dispose(),t.material=t.originalMaterial,t.originalMaterial=null)})}createSelectionMarker(t,e){throw new Error("createSelectionMarker needs to be implemented in a subclass")}dispose(){this.marker&&this.deselect(),this.traverse(t=>{var e,o;t instanceof d.Mesh&&((e=t.geometry)==null||e.dispose(),(o=t.material)==null||o.dispose())}),this.clear()}}class Qt extends ct{constructor(t,e,o,s,r,i){super(),this.userData={type:"hbond",hbondData:t,selectable:!0};const a=e.getAtomByLabel(t.hydrogenAtomLabel),n=e.getAtomByLabel(t.acceptorAtomLabel),c=new d.Vector3(...a.position.toCartesian(e.cell)),h=new d.Vector3(...n.position.toCartesian(e.cell));this.createDashedBondSegments(c,h,o,s,r,i)}createDashedBondSegments(t,e,o,s,r,i){const a=t.distanceTo(e),n=Math.max(1,Math.floor(a/r)),h=a/n*i;for(let m=0;m<n;m++){const f=m/n,y=f+h/a,u=new d.Vector3().lerpVectors(t,e,f),_=new d.Vector3().lerpVectors(t,e,y),L=new d.Mesh(o,s.clone());L.applyMatrix4(xt(u,_)),L.userData=this.userData,this.add(L)}}createSelectionMarker(t,e){const o=new d.Group,s=this.createSelectionMaterial(t);return this.children.forEach(r=>{const i=new d.Mesh(r.geometry,s);i.applyMatrix4(r.matrix),i.scale.x*=e.selection.bondMarkerMult,i.scale.y*=.8*e.selection.bondMarkerMult,i.scale.z*=e.selection.bondMarkerMult,i.userData.selectable=!1,o.add(i)}),o}}function Et(l,t,e=4){if(!isFinite(1/t))return dt(l,e).toFixed(e);let o=Math.floor(Math.log10(t));t*Math.pow(10,-o)<2&&(o-=1);const s=dt(l,-o);if(o<0){const i=Math.round(t/Math.pow(10,o));return`${s.toFixed(-o)}(${i})`}const r=dt(t,o);return`${s}(${r})`}function dt(l,t){const e=Math.pow(10,t);return Math.round(l*e)/e}function At(l,t=!0){if(!l||typeof l!="string")throw new Error("Empty atom label");let e=l.toUpperCase().replace(/[()[\]{}]/g,"");if(t&&(e=e.replace(/\^[a-zA-Z1-9]+$/,"").replace(/_[a-zA-Z1-9]+$/,"").replace(/_\$\d+$/,"")),e==="")throw new Error(`Label "${l}" normalizes to empty string`);return e}function te(l,t=!0){const e=new Map;l.forEach(s=>{try{const r=At(s,t);e.has(r)||e.set(r,[]),e.get(r).push(s)}catch(r){console.warn(`Skipping invalid label: ${r.message}`)}});const o=new Map;for(const[s,r]of e.entries())r.length===1?o.set(s,r[0]):console.warn(`Multiple labels map to ${s}: ${r.join(", ")}. Skipping mapping.`);return o}function Y(l,t,e,o=!0){const s=te(e,o),i=l.get(t).map(a=>{const n=At(a,o);return s.has(n)?s.get(n):a});l.data[t]=i}function ee(l){if(!l||l===".")return".";const t=String(l).trim();if(/^\d+_\d{3}$/.test(t))return t;const e=t.match(/^-?([^\s\-_.]+)[\s-.](\d{3})$/);if(e){const o=e[1],s=e[2];return e[0].startsWith("-")?`-${o}_${s}`:`${o}_${s}`}if(/^\d{5,6}$/.test(t)){const o=t.slice(0,3),s=t.slice(-3),r=Array.from(o).map(a=>Math.abs(parseInt(a)-5)).reduce((a,n)=>a+n,0),i=Array.from(s).map(a=>Math.abs(parseInt(a)-5)).reduce((a,n)=>a+n,0);return r<i?`${parseInt(t.slice(3))}_${o}`:`${parseInt(t.slice(0,-4))}_${s}`}return l}function ht(l,t){const o=l.get(t).map(s=>ee(s));l.data[t]=o}function P(l,t){for(const e of t)if(l.headerLines.includes(e))return e;return null}function Ot(l,t=!0,e=!0,o=!0){let s;if((t||e)&&(s=l.get("_atom_site").get(["_atom_site.label","_atom_site_label"])),t){const r=l.get("_atom_site_aniso",!1);if(r){const i=P(r,["_atom_site_aniso.label","_atom_site_aniso_label"]);i&&Y(r,i,s)}}if(e||o){const r=l.get("_geom_bond",!1);if(r){if(e){const a=P(r,["_geom_bond.atom_site_label_1","_geom_bond_atom_site_label_1"]);Y(r,a,s);const n=P(r,["_geom_bond.atom_site_label_2","_geom_bond_atom_site_label_2"]);Y(r,n,s)}if(o){const a=P(r,["_geom_bond.site_symmetry_1","_geom_bond_site_symmetry_1"]);a&&ht(r,a);const n=P(r,["_geom_bond.site_symmetry_2","_geom_bond_site_symmetry_2"]);n&&ht(r,n)}}const i=l.get("_geom_hbond",!1);if(i){if(e){const a=P(i,["_geom_hbond.atom_site_label_d","_geom_hbond_atom_site_label_D"]);Y(i,a,s);const n=P(i,["_geom_hbond.atom_site_label_h","_geom_hbond_atom_site_label_H"]);n&&Y(i,n,s);const c=P(i,["_geom_hbond.atom_site_label_a","_geom_hbond_atom_site_label_A"]);Y(i,c,s)}if(o){const a=P(i,["_geom_hbond.site_symmetry_a","_geom_hbond_site_symmetry_A"]);a&&ht(i,a)}}}}const mt=g.create(g.all,{});function oe(l){const t=new d.Vector3;l.forEach(c=>t.add(c)),t.divideScalar(l.length);const e=new d.Matrix3,o=new d.Vector3;l.forEach(c=>{o.copy(c).sub(t),e.elements[0]+=o.x*o.x,e.elements[1]+=o.x*o.y,e.elements[2]+=o.x*o.z,e.elements[3]+=o.y*o.x,e.elements[4]+=o.y*o.y,e.elements[5]+=o.y*o.z,e.elements[6]+=o.z*o.x,e.elements[7]+=o.z*o.y,e.elements[8]+=o.z*o.z});const{values:s,eigenvectors:r}=mt.eigs(se(e)),i=mt.min(s);if(i<=0)return console.warn("Could not find a mean plane, expected?"),new d.Vector3(0,1,0);const a=r.filter(c=>c.value===i)[0].vector,n=new d.Vector3(...a.toArray());return n.normalize(),n}function se(l){const t=l.elements;return mt.matrix([[t[0],t[1],t[2]],[t[3],t[4],t[5]],[t[6],t[7],t[8]]])}function Nt(l,t=50){const e=[],o=new d.Vector3;if(l.traverse(i=>{var a;((a=i.userData)==null?void 0:a.type)==="atom"&&(e.push(i.position.clone()),o.add(i.position))}),e.length===0)return 10;o.divideScalar(e.length);const s=e.map(i=>i.sub(o));return Math.max(...s.map(i=>i.length()))/Math.sin(t/2*Math.PI/180)}function re(l){const t=[],e=new d.Vector3;if(l.traverse(u=>{var _;((_=u.userData)==null?void 0:_.type)==="atom"&&(t.push(u.position.clone()),e.add(u.position))}),t.length===0)return null;e.divideScalar(t.length);const o=t.map(u=>u.sub(e)),s=oe(o),r=new d.Vector3(0,0,1),i=new d.Quaternion;i.setFromUnitVectors(s,r);const a=new d.Matrix4;a.makeRotationFromQuaternion(i);const n=o.map(u=>u.clone().applyMatrix4(a));let c=0,h=0;n.forEach((u,_)=>{const L=Math.sqrt(u.x*u.x+u.y*u.y);L>c&&(c=L,h=_)});const m=new d.Vector2(n[h].x,n[h].y);m.x<0&&m.multiplyScalar(-1);const f=-Math.atan2(m.y,m.x),y=new d.Matrix4().makeRotationZ(f);return a.premultiply(y),a.premultiply(new d.Matrix4().makeRotationX(Math.PI/4)),a.premultiply(new d.Matrix4().makeRotationY(.2)),a}function ie(l,t){l.children=l.children.filter(i=>!(i instanceof d.Light));const e=Math.max(Nt(t),6)*1.5,o=new d.AmbientLight(16777215,1);l.add(o);const s=new d.SpotLight(16777215,1e3,0,Math.PI*.27,.6);s.position.set(0,-.5,e*2),s.lookAt(new d.Vector3(0,0,0)),l.add(s),[{pos:[-1,-.5,1],intensity:.4},{pos:[1,-.5,1],intensity:.4},{pos:[0,-.5,1],intensity:.3}].forEach(({pos:i,intensity:a})=>{const n=new d.DirectionalLight(16777215,a);n.position.set(i[0]*e,i[1]*e,i[2]*e),n.lookAt(new d.Vector3(0,0,0)),l.add(n)})}class ae{constructor(t){this.viewer=t,this.state={isDragging:!1,isPanning:!1,mouse:new d.Vector2,lastClickTime:0,clickStartTime:0,pinchStartDistance:0,lastTouchRotation:0,lastRightClickTime:0,twoFingerStartPos:new d.Vector2,initialCameraPosition:t.camera.position.clone()};const{container:e,camera:o,renderer:s,moleculeContainer:r,options:i}=t;this.container=e,this.camera=o,this.renderer=s,this.moleculeContainer=r,this.options=i,this.doubleClickDelay=300,this.raycaster=new d.Raycaster,this.raycaster.near=.1,this.raycaster.far=100,this.bindEventHandlers(),this.setupEventListeners()}bindEventHandlers(){this.boundHandlers={wheel:this.handleWheel.bind(this),mouseDown:this.handleMouseDown.bind(this),mouseMove:this.handleMouseMove.bind(this),mouseUp:this.handleMouseUp.bind(this),click:this.handleClick.bind(this),contextMenu:this.handleContextMenu.bind(this),touchStart:this.handleTouchStart.bind(this),touchMove:this.handleTouchMove.bind(this),touchEnd:this.handleTouchEnd.bind(this),resize:this.handleResize.bind(this)}}setupEventListeners(){const t=this.renderer.domElement,{wheel:e,mouseDown:o,mouseMove:s,mouseUp:r,click:i,contextMenu:a,touchStart:n,touchMove:c,touchEnd:h,resize:m}=this.boundHandlers;t.addEventListener("wheel",e,{passive:!1}),t.addEventListener("mousedown",o),t.addEventListener("mousemove",s),t.addEventListener("mouseup",r),t.addEventListener("mouseleave",r),t.addEventListener("click",i),t.addEventListener("contextmenu",a),t.addEventListener("touchstart",n,{passive:!1}),t.addEventListener("touchmove",c,{passive:!1}),t.addEventListener("touchend",h),window.addEventListener("resize",m)}clientToMouseCoordinates(t,e){const o=this.container.getBoundingClientRect();return new d.Vector2((t-o.left)/o.width*2-1,-((e-o.top)/o.height)*2+1)}updateMouseCoordinates(t,e){const o=this.clientToMouseCoordinates(t,e);this.state.mouse.x=o.x,this.state.mouse.y=o.y}handleSelection(t,e){this.updateMouseCoordinates(t.clientX,t.clientY),this.raycaster.setFromCamera(this.state.mouse,this.camera);const o=[];this.moleculeContainer.traverse(r=>{var i;(i=r.userData)!=null&&i.selectable&&o.push(r)});const s=this.raycaster.intersectObjects(o).filter(r=>{var i;return(i=r.object.userData)==null?void 0:i.selectable});s.length>0?this.viewer.selections.handle(s[0].object):e<this.doubleClickDelay&&this.viewer.selections.clear(),this.viewer.requestRender()}handleMouseClick(t,e){const o=this.options.interaction.mouseRaycast;this.raycaster.params.Line.threshold=o.lineThreshold,this.raycaster.params.Points.threshold=o.pointsThreshold,this.raycaster.params.Mesh.threshold=o.meshThreshold,this.handleSelection(t,e)}handleTouchSelect(t,e){const o=this.options.interaction.touchRaycast;this.raycaster.params.Line.threshold=o.lineThreshold,this.raycaster.params.Points.threshold=o.pointsThreshold,this.raycaster.params.Mesh.threshold=o.meshThreshold,this.handleSelection(t,e)}rotateStructure(t){const e=this.options.interaction.rotationSpeed,o=new d.Vector3(1,0,0),s=new d.Vector3(0,1,0);this.moleculeContainer.applyMatrix4(new d.Matrix4().makeRotationAxis(s,t.x*e)),this.moleculeContainer.applyMatrix4(new d.Matrix4().makeRotationAxis(o,-t.y*e)),this.viewer.requestRender()}handleZoom(t){const{minDistance:e,maxDistance:o}=this.options.camera,s=o-e,r=this.camera.position.length(),i=d.MathUtils.clamp(r+t*s,e,o),a=this.camera.position.clone().normalize();this.camera.position.copy(a.multiplyScalar(i)),this.viewer.requestRender()}resetCameraPosition(){this.camera.position.x=this.state.initialCameraPosition.x,this.camera.position.y=this.state.initialCameraPosition.y,this.camera.rotation.set(0,0,0),this.viewer.requestRender()}panCamera(t){const e=this.camera.position.z,o=this.camera.fov*Math.PI/180,s=Math.tan(o/2)*e,r=s*this.camera.aspect,i=-t.x*r,a=-t.y*s,n=new d.Vector3,c=new d.Vector3;this.camera.matrix.extractBasis(n,c,new d.Vector3),this.camera.position.addScaledVector(n,i),this.camera.position.addScaledVector(c,a),this.viewer.requestRender()}handleTouchStart(t){t.preventDefault();const e=t.touches;if(e.length===1&&!this.state.isDragging)this.state.isDragging=!0,this.state.clickStartTime=Date.now(),this.updateMouseCoordinates(e[0].clientX,e[0].clientY);else if(e.length===2){if(!this.state.isDragging){const o=e[0].clientX-e[1].clientX,s=e[0].clientY-e[1].clientY;this.state.pinchStartDistance=Math.hypot(o,s);const r=this.clientToMouseCoordinates((e[0].clientX+e[1].clientX)/2,(e[0].clientY+e[1].clientY)/2);this.state.twoFingerStartPos.copy(r)}this.state.isDragging=!1}}handleTouchMove(t){t.preventDefault();const e=t.touches;if(e.length===1&&this.state.isDragging){const o=e[0],s=this.clientToMouseCoordinates(o.clientX,o.clientY),r=new d.Vector2(s.x-this.state.mouse.x,s.y-this.state.mouse.y);this.rotateStructure(r),this.state.mouse.set(s.x,s.y)}else if(e.length===2){const o=e[0].clientX-e[1].clientX,s=e[0].clientY-e[1].clientY,r=Math.hypot(o,s);if(!this.state.pinchStartDistance){this.state.pinchStartDistance=r;const n=this.clientToMouseCoordinates((e[0].clientX+e[1].clientX)/2,(e[0].clientY+e[1].clientY)/2);this.state.twoFingerStartPos.copy(n);return}this.handleZoom((this.state.pinchStartDistance-r)*this.options.camera.pinchZoomSpeed),this.state.pinchStartDistance=r;const i=this.clientToMouseCoordinates((e[0].clientX+e[1].clientX)/2,(e[0].clientY+e[1].clientY)/2),a=i.clone().sub(this.state.twoFingerStartPos);this.panCamera(a),this.state.twoFingerStartPos.copy(i)}}handleTouchEnd(t){if(t.cancelable&&t.preventDefault(),t.touches.length===0&&t.changedTouches.length>0){if(Date.now()-this.state.clickStartTime<this.options.interaction.clickThreshold){const o=t.changedTouches[0],s=Date.now(),r={clientX:o.clientX,clientY:o.clientY};this.handleTouchSelect(r,s-this.state.lastClickTime),this.state.lastClickTime=s}this.state.isDragging=!1,this.state.pinchStartDistance=0}}handleContextMenu(t){t.preventDefault();const e=Date.now();e-this.state.lastRightClickTime<this.doubleClickDelay&&this.resetCameraPosition(),this.state.lastRightClickTime=e}handleMouseDown(t){t.button===2?this.state.isPanning=!0:this.state.isDragging=!0,this.state.clickStartTime=Date.now(),this.updateMouseCoordinates(t.clientX,t.clientY)}handleMouseMove(t){if(!this.state.isDragging&&!this.state.isPanning)return;const e=this.container.getBoundingClientRect(),o=new d.Vector2((t.clientX-e.left)/e.width*2-1,-((t.clientY-e.top)/e.height)*2+1),s=o.clone().sub(this.state.mouse);this.state.isPanning?this.panCamera(s):this.rotateStructure(s),this.state.mouse.copy(o)}handleMouseUp(){this.state.isDragging=!1,this.state.isPanning=!1}handleClick(t){if(t.button!==0||Date.now()-this.state.clickStartTime>this.options.interaction.clickThreshold||this.state.isDragging)return;const o=Date.now();this.handleMouseClick(t,o-this.state.lastClickTime),this.state.lastClickTime=o}handleWheel(t){t.preventDefault(),this.handleZoom(t.deltaY*this.options.camera.wheelZoomSpeed)}handleResize(){const t=this.container.getBoundingClientRect(),e=t.width/t.height;this.camera.aspect=e;const o=this.options.camera.fov;t.width<t.height?this.camera.fov=2*Math.atan(Math.tan(o*Math.PI/360)/e)*180/Math.PI:this.camera.fov=o,this.camera.updateProjectionMatrix(),this.renderer.setSize(t.width,t.height),this.viewer.requestRender()}dispose(){const t=this.renderer.domElement,{wheel:e,mouseDown:o,mouseMove:s,mouseUp:r,click:i,contextMenu:a,touchStart:n,touchMove:c,touchEnd:h,resize:m}=this.boundHandlers;t.removeEventListener("wheel",e),t.removeEventListener("mousedown",o),t.removeEventListener("mousemove",s),t.removeEventListener("mouseup",r),t.removeEventListener("mouseleave",r),t.removeEventListener("click",i),t.removeEventListener("contextmenu",a),t.removeEventListener("touchstart",n),t.removeEventListener("touchmove",c),t.removeEventListener("touchend",h),window.removeEventListener("resize",m)}}class ne{constructor(t){this.options=t,this.selectedObjects=new Set,this.selectionCallbacks=new Set,this.selectedData=new Set}pruneInvalidSelections(t){this.selectedObjects.clear();const e=new Set;t.traverse(o=>{var s;if((s=o.userData)!=null&&s.selectable){const r=this.getObjectData(o);r&&e.add(JSON.stringify(r))}}),this.selectedData=new Set(Array.from(this.selectedData).filter(o=>e.has(JSON.stringify({type:o.type,...this.getDataWithoutColor(o)})))),t.traverse(o=>{var s;if((s=o.userData)!=null&&s.selectable){const r=this.getObjectData(o);if(this.hasMatchingData(r)){const i=this.getColorForData(r);o.select(i,this.options),this.selectedObjects.add(o)}}}),this.notifyCallbacks()}getDataWithoutColor(t){const{color:e,...o}=t;return o}getObjectData(t){if(!t.userData)return null;switch(t.userData.type){case"atom":return{type:"atom",label:t.userData.atomData.label};case"bond":return{type:"bond",atom1:t.userData.bondData.atom1Label,atom2:t.userData.bondData.atom2Label};case"hbond":return{type:"hbond",donor:t.userData.hbondData.donorAtomLabel,hydrogen:t.userData.hbondData.hydrogenAtomLabel,acceptor:t.userData.hbondData.acceptorAtomLabel};default:return null}}hasMatchingData(t){return t?Array.from(this.selectedData).some(e=>this.matchData(e,t)):!1}getColorForData(t){const e=Array.from(this.selectedData).find(o=>this.matchData(o,t));return e?e.color:this.getNextColor()}handle(t){this.options.mode==="single"&&(this.selectedObjects.forEach(s=>{this.remove(s)}),this.selectedObjects.clear(),this.selectedData.clear());const e=this.getObjectData(t);if(!e)return null;let o;return this.hasMatchingData(e)?(o=t.selectionColor,this.remove(t),this.selectedData=new Set(Array.from(this.selectedData).filter(s=>!this.matchData(s,e)))):(o=this.getNextColor(),this.add(t,o),this.selectedData.add({...e,color:o})),this.notifyCallbacks(),o}matchData(t,e){if(t.type!==e.type)return!1;switch(t.type){case"atom":return t.label===e.label;case"bond":return t.atom1===e.atom1&&t.atom2===e.atom2||t.atom1===e.atom2&&t.atom2===e.atom1;case"hbond":return t.donor===e.donor&&t.hydrogen===e.hydrogen&&t.acceptor===e.acceptor;default:return!1}}add(t,e){t.select(e||this.getNextColor(),this.options),this.selectedObjects.add(t)}remove(t){this.selectedObjects.delete(t),t.deselect()}clear(){this.selectedObjects.forEach(t=>{this.remove(t)}),this.selectedObjects.clear(),this.selectedData.clear(),this.notifyCallbacks()}getNextColor(){const t=new Map;this.selectedData.forEach(o=>{t.set(o.color,(t.get(o.color)||0)+1)});let e=this.options.selection.markerColors.find(o=>!t.has(o));if(!e){const o=Math.min(...t.values());e=this.options.selection.markerColors.find(s=>t.get(s)===o)}return e}onChange(t){this.selectionCallbacks.add(t)}notifyCallbacks(){const t=Array.from(this.selectedObjects).map(e=>({type:e.userData.type,data:e.userData.type==="hbond"?e.userData.hbondData:e.userData.type==="bond"?e.userData.bondData:e.userData.atomData,color:e.selectionColor}));this.selectionCallbacks.forEach(e=>e(t))}setMode(t){if(t!=="single"&&t!=="multiple")throw new Error('Selection mode must be either "single" or "multiple"');if(this.options.mode=t,t==="single"&&this.selectedObjects.size>1){const e=Array.from(this.selectedObjects),o=e[e.length-1],s=this.getObjectData(o);this.clear(),s&&(this.add(o),this.selectedData.add({...s,color:o.selectionColor})),this.notifyCallbacks()}}dispose(){this.clear(),this.selectionCallbacks.clear()}}class ft{constructor(t,e={}){const o=["constant","onDemand"];if(e.renderMode&&!o.includes(e.renderMode))throw new Error(`Invalid render mode: "${e.renderMode}". Must be one of: ${o.join(", ")}`);this.container=t,this.options={camera:{...w.camera,initialPosition:new d.Vector3(...w.camera.initialPosition),...e.camera||{}},selection:{...w.selection,...e.selection||{}},interaction:{...w.interaction,...e.interaction||{}},atomDetail:e.atomDetail||w.atomDetail,atomColorRoughness:e.atomColorRoughness||w.atomColorRoughness,atomColorMetalness:e.atomColorMetalness||w.atomColorMetalness,atomADPRingWidthFactor:e.atomADPRingWidthFactor||w.atomADPRingWidthFactor,atomADPRingHeight:e.atomADPRingHeight||w.atomADPRingHeight,atomADPRingSections:e.atomADPRingSections||w.atomADPRingSections,bondRadius:e.bondRadius||w.bondRadius,bondSections:e.bondSections||w.bondSections,bondColor:e.bondColor||w.bondColor,bondColorRoughness:e.bondColorRoughness||w.bondColorRoughness,bondColorMetalness:e.bondColorMetalness||w.bondColorMetalness,bondGrowToleranceFactor:e.bondGrowToleranceFactor||w.bondGrowToleranceFactor,elementProperties:{...w.elementProperties,...e.elementProperties},hydrogenMode:e.hydrogenMode||w.hydrogenMode,disorderMode:e.disorderMode||w.disorderMode,symmetryMode:e.symmetryMode||w.symmetryMode,renderMode:e.renderMode||w.renderMode,fixCifErrors:e.fixCifErrors||w.fixCifErrors},this.state={isDragging:!1,currentCifContent:null,currentStructure:null,currentFloor:null,baseStructure:null,ortepObjects:new Map,structureCenter:new d.Vector3},this.modifiers={removeatoms:new ot,missingbonds:new st(this.options.elementProperties,this.options.bondGrowToleranceFactor),hydrogen:new tt(this.options.hydrogenMode),disorder:new et(this.options.disorderMode),symmetry:new q(this.options.symmetryMode)},this.selections=new ne(this.options),this.setupScene(),this.controls=new ae(this),this.animate(),this.needsRender=!0}setupScene(){this.scene=new d.Scene,this.camera=new d.PerspectiveCamera(this.options.camera.fov,this.container.clientWidth/this.container.clientHeight,this.options.camera.near,this.options.camera.far),this.renderer=new d.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.container.appendChild(this.renderer.domElement),this.moleculeContainer=new d.Group,this.scene.add(this.moleculeContainer),this.camera.position.copy(this.options.camera.initialPosition),this.cameraTarget=new d.Vector3(0,0,0),this.camera.lookAt(this.cameraTarget)}async loadStructure(t,e=0){try{const o=new gt(t);try{this.state.baseStructure=T.fromCIF(o.getBlock(e))}catch(s){if(this.options.fixCifErrors)throw s;try{const r=Ot(o.getBlock(e));this.state.baseStructure=T.fromCIF(r)}catch{throw s}}return await this.setupNewStructure(),{success:!0}}catch(o){return console.error("Error loading structure:",o),{success:!1,error:o.message}}}async setupNewStructure(){this.selections.clear(),this.moleculeContainer.position.set(0,0,0),this.moleculeContainer.rotation.set(0,0,0),this.moleculeContainer.scale.set(1,1,1),this.moleculeContainer.updateMatrix(),this.moleculeContainer.matrixAutoUpdate=!0,this.moleculeContainer.updateMatrixWorld(!0),this.cameraTarget.set(0,0,0),this.camera.position.copy(this.options.camera.initialPosition),this.camera.lookAt(this.cameraTarget),this.state.structureCenter.set(0,0,0),this.update3DOrtep(),new d.Box3().setFromObject(this.state.currentStructure).getCenter(this.state.structureCenter),this.state.currentStructure.children.forEach(o=>{o.position.sub(this.state.structureCenter)});const e=re(this.state.currentStructure);return this.container.clientHeight>this.container.clientWidth&&e.premultiply(new d.Matrix4().makeRotationZ(Math.PI/2)),e&&(this.moleculeContainer.setRotationFromMatrix(e),this.moleculeContainer.updateMatrix()),this.updateCamera(),ie(this.scene,this.state.currentStructure),this.requestRender(),{success:!0}}async updateStructure(){try{const t=this.moleculeContainer.matrix.clone();return this.update3DOrtep(),this.state.currentStructure.children.forEach(e=>{e.position.sub(this.state.structureCenter)}),this.moleculeContainer.matrix.copy(t),this.moleculeContainer.matrixAutoUpdate=!1,this.requestRender(),{success:!0}}catch(t){return console.error("Error updating structure:",t),{success:!1,error:t.message}}}update3DOrtep(){this.removeStructure();let t=this.state.baseStructure;for(const s of Object.values(this.modifiers))t=s.apply(t);const o=new Dt(t,this.options).getGroup();this.moleculeContainer.add(o),this.state.currentStructure=o,this.selections.pruneInvalidSelections(this.moleculeContainer)}updateCamera(){const t=Nt(this.state.currentStructure,this.camera.fov);this.camera.position.set(0,0,t),this.camera.rotation.set(0,0,0),this.camera.lookAt(this.cameraTarget),this.options.camera.minDistance=t*.2,this.options.camera.maxDistance=t*2}removeStructure(){this.moleculeContainer.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),this.moleculeContainer.clear()}async cycleModifierMode(t){const e=this.modifiers[t],o=e.cycleMode(this.state.baseStructure);let s;return e.requiresCameraUpdate?s=await this.setupNewStructure():s=await this.updateStructure(),{...s,mode:o}}numberModifierModes(t){return this.state.baseStructure?this.modifiers[t].getApplicableModes(this.state.baseStructure).length:!1}animate(){(this.options.renderMode==="constant"||this.needsRender)&&(this.renderer.render(this.scene,this.camera),this.needsRender=!1),requestAnimationFrame(this.animate.bind(this))}requestRender(){this.options.renderMode==="onDemand"&&(this.needsRender=!0)}selectAtoms(t){this.selections.selectAtoms(t,this.moleculeContainer)}dispose(){this.controls.dispose(),this.scene.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(e=>e.dispose()):t.material.dispose())}),this.selections.dispose(),this.renderer.dispose(),this.renderer.domElement.parentNode&&this.renderer.domElement.parentNode.removeChild(this.renderer.domElement),this.scene=null,this.camera=null,this.renderer=null,this.state=null,this.options=null}}const le={disorder:{all:'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><g id="g8" transform="translate(0,-0.09016496)"><g id="g7" transform="translate(0,0.52916667)"><g id="path2-16" transform="rotate(180,28.623599,19.40998)" style="stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1"><path style="color:#000000;fill:#000000;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.707504,13.775784 -5.401798,11.08337" id="path3-6" /><path style="color:#000000;fill:#000000;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.257812,13.556641 -5.402343,11.083984 0.90039,0.4375 5.400391,-11.083984 z" id="path4-1" /></g><g id="path2-1-2" transform="rotate(180,28.623599,19.40998)" style="stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1"><path style="color:#000000;fill:#000000;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.600535,13.775784 5.401798,11.08337" id="path5-7" /><path style="color:#000000;fill:#000000;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 29.050781,13.556641 -0.90039,0.4375 5.402343,11.083984 0.898438,-0.4375 z" id="path6-5" /></g><circle style="fill:#000000;stroke:#000000;stroke-width:0.564999" id="path1-9" cx="-28.593182" cy="-24.863596" r="2.3135188" transform="scale(-1)" /><circle style="fill:#000000;stroke:#000000;stroke-width:0.564999" id="path1-2-3" cx="-33.888008" cy="-14.141389" r="2.3135188" transform="scale(-1)" /><circle style="fill:#000000;stroke:#000000;stroke-width:0.564999" id="path1-7-9" cx="-23.298351" cy="-14.141389" r="2.3135188" transform="scale(-1)" /></g><g id="g6" transform="translate(0,-0.52916663)"><g id="path2" style="stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1"><path style="color:#000000;fill:#000000;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.707504,13.775784 -5.401798,11.08337" id="path3" /><path style="color:#000000;fill:#000000;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.257812,13.556641 -5.402343,11.083984 0.90039,0.4375 5.400391,-11.083984 z" id="path4" /></g><circle style="fill:#000000;stroke:#000000;stroke-width:0.564999" id="path1-2" cx="23.35919" cy="24.678572" r="2.3135188" /><g id="path2-1" style="stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1"><path style="color:#000000;fill:#000000;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.600535,13.775784 5.401798,11.08337" id="path5" /><path style="color:#000000;fill:#000000;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 29.050781,13.556641 -0.90039,0.4375 5.402343,11.083984 0.898438,-0.4375 z" id="path6" /></g><circle style="fill:#000000;stroke:#000000;stroke-width:0.564999" id="path1" cx="28.654018" cy="13.956366" r="2.3135188" /><circle style="fill:#000000;stroke:#000000;stroke-width:0.564999" id="path1-7" cx="33.948849" cy="24.678572" r="2.3135188" /></g></g></g></svg>',group1:'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><g id="path2-16" transform="rotate(180,28.623599,19.629481)" style="fill:#a4a4a4;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1"><path style="color:#000000;fill:#a4a4a4;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.707504,13.775784 -5.401798,11.08337" id="path3-6" /><path style="color:#000000;fill:#a4a4a4;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.257812,13.556641 -5.402343,11.083984 0.90039,0.4375 5.400391,-11.083984 z" id="path4-1" /></g><g id="path2-1-2" transform="rotate(180,28.623599,19.629481)" style="fill:#a4a4a4;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1"><path style="color:#000000;fill:#a4a4a4;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.600535,13.775784 5.401798,11.08337" id="path5-7" /><path style="color:#000000;fill:#a4a4a4;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 29.050781,13.556641 -0.90039,0.4375 5.402343,11.083984 0.898438,-0.4375 z" id="path6-5" /></g><circle style="fill:#a4a4a4;fill-opacity:1;stroke:#a4a4a4;stroke-width:0.564999;stroke-opacity:1" id="path1-9" cx="-28.593182" cy="-25.302597" r="2.3135188" transform="scale(-1)" /><circle style="fill:#a4a4a4;fill-opacity:1;stroke:#a4a4a4;stroke-width:0.564999;stroke-opacity:1" id="path1-2-3" cx="-33.888008" cy="-14.580391" r="2.3135188" transform="scale(-1)" /><circle style="fill:#a4a4a4;fill-opacity:1;stroke:#a4a4a4;stroke-width:0.564999;stroke-opacity:1" id="path1-7-9" cx="-23.298351" cy="-14.580391" r="2.3135188" transform="scale(-1)" /><g id="g6" transform="translate(0,-0.61933159)"><g id="path2" style="stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1"><path style="color:#000000;fill:#000000;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.707504,13.775784 -5.401798,11.08337" id="path3" /><path style="color:#000000;fill:#000000;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.257812,13.556641 -5.402343,11.083984 0.90039,0.4375 5.400391,-11.083984 z" id="path4" /></g><circle style="fill:#000000;stroke:#000000;stroke-width:0.564999" id="path1-2" cx="23.35919" cy="24.678572" r="2.3135188" /><g id="path2-1" style="stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1"><path style="color:#000000;fill:#000000;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.600535,13.775784 5.401798,11.08337" id="path5" /><path style="color:#000000;fill:#000000;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 29.050781,13.556641 -0.90039,0.4375 5.402343,11.083984 0.898438,-0.4375 z" id="path6" /></g><circle style="fill:#000000;stroke:#000000;stroke-width:0.564999" id="path1" cx="28.654018" cy="13.956366" r="2.3135188" /><circle style="fill:#000000;stroke:#000000;stroke-width:0.564999" id="path1-7" cx="33.948849" cy="24.678572" r="2.3135188" /></g></g></svg>',group2:'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><g id="path2-16" transform="rotate(180,28.623599,19.629481)" style="fill:#000000;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1"><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.707504,13.775784 -5.401798,11.08337" id="path3-6" /><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.257812,13.556641 -5.402343,11.083984 0.90039,0.4375 5.400391,-11.083984 z" id="path4-1" /></g><g id="path2-1-2" transform="rotate(180,28.623599,19.629481)" style="fill:#000000;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1"><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.600535,13.775784 5.401798,11.08337" id="path5-7" /><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 29.050781,13.556641 -0.90039,0.4375 5.402343,11.083984 0.898438,-0.4375 z" id="path6-5" /></g><circle style="fill:#000000;fill-opacity:1;stroke:#000000;stroke-width:0.564999;stroke-opacity:1" id="path1-9" cx="-28.593182" cy="-25.302597" r="2.3135188" transform="scale(-1)" /><circle style="fill:#000000;fill-opacity:1;stroke:#000000;stroke-width:0.564999;stroke-opacity:1" id="path1-2-3" cx="-33.888008" cy="-14.580391" r="2.3135188" transform="scale(-1)" /><circle style="fill:#000000;fill-opacity:1;stroke:#000000;stroke-width:0.564999;stroke-opacity:1" id="path1-7-9" cx="-23.298351" cy="-14.580391" r="2.3135188" transform="scale(-1)" /><g id="path2" style="fill:#a4a4a4;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" transform="translate(0,-0.61933159)"><path style="color:#000000;fill:#a4a4a4;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.707504,13.775784 -5.401798,11.08337" id="path3" /><path style="color:#000000;fill:#a4a4a4;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.257812,13.556641 -5.402343,11.083984 0.90039,0.4375 5.400391,-11.083984 z" id="path4" /></g><circle style="fill:#a4a4a4;fill-opacity:1;stroke:#a4a4a4;stroke-width:0.564999;stroke-opacity:1" id="path1-2" cx="23.35919" cy="24.05924" r="2.3135188" /><g id="path2-1" style="fill:#a4a4a4;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" transform="translate(0,-0.61933159)"><path style="color:#000000;fill:#a4a4a4;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 28.600535,13.775784 5.401798,11.08337" id="path5" /><path style="color:#000000;fill:#a4a4a4;fill-opacity:1;stroke:#ffffff;stroke-width:0.2;stroke-dasharray:none;stroke-opacity:1" d="m 29.050781,13.556641 -0.90039,0.4375 5.402343,11.083984 0.898438,-0.4375 z" id="path6" /></g><circle style="fill:#a4a4a4;fill-opacity:1;stroke:#a4a4a4;stroke-width:0.564999;stroke-opacity:1" id="path1" cx="28.654018" cy="13.337034" r="2.3135188" /><circle style="fill:#a4a4a4;fill-opacity:1;stroke:#a4a4a4;stroke-width:0.564999;stroke-opacity:1" id="path1-7" cx="33.948849" cy="24.05924" r="2.3135188" /></g></svg>'},hydrogen:{anisotropic:'<svg width="17.85038mm" height="17.850386mm" viewBox="0 0 17.85038 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-78.600695,-38.873141)"><text xml:space="preserve" style="font-size:8.46667px;fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.677999;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1" x="84.344688" y="50.876183" id="text3-1-5-9"><tspan id="tspan3-4-4-0" style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.678;stroke-opacity:1" x="84.344688" y="50.876183">H</tspan></text><ellipse style="fill:none;fill-opacity:1;stroke:#000000;stroke-width:0.816;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1" id="path7-4" cx="41.174881" cy="90.830009" rx="4.9952669" ry="9.7379656" transform="rotate(-36.975178)" /></g></svg>',constant:'<svg width="17.850388mm" height="17.850386mm" viewBox="0 0 17.850388 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-58.39314,-38.873141)"><text xml:space="preserve" style="font-size:8.46667px;fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.677999;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1" x="64.137131" y="50.876183" id="text3-1-8"><tspan id="tspan3-4-1" style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.678;stroke-opacity:1" x="64.137131" y="50.876183">H</tspan></text><circle style="fill:none;fill-opacity:1;stroke:#000000;stroke-width:0.816;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1" id="path6-0" cx="67.318336" cy="47.798332" r="6.8755083" /></g></svg>',none:'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-37.755639,-38.873141)"><text xml:space="preserve" style="font-size:8.46667px;fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.677999;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1" x="43.499626" y="50.876183" id="text3-6" ><tspan id="tspan3-5" style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.678;stroke-opacity:1" x="43.499626" y="50.876183">H</tspan></text><path style="fill:#000000;fill-opacity:1;stroke:#000000;stroke-width:0.816;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1" d="m 39.917575,41.035079 13.526512,13.52651" id="path5-9" /><path style="fill:#000000;fill-opacity:1;stroke:#000000;stroke-width:0.816;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1" d="M 53.444087,41.035079 39.917575,54.561589" id="path5-1-0" /></g></svg>'},symmetry:{"bonds-no-hbonds-no":'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><rect style="fill:#ffffff;fill-opacity:1;stroke:#ffffff;stroke-width:0.355503;stroke-dasharray:none;stroke-dashoffset:0.0831496;stroke-opacity:1" id="rect25" width="1.3572845" height="1.1344972" x="27.961069" y="23.823376" /><g id="path8" style="stroke-width:0.4;stroke-dasharray:none;stroke:#ffffff;stroke-opacity:1;fill:#808080;fill-opacity:1"><path style="color:#000000;fill:#808080;stroke-width:0.4;stroke-dasharray:none;stroke:#ffffff;stroke-opacity:1;fill-opacity:1" d="m 23.654019,14.248425 h 10" id="path23" /><path style="color:#000000;fill:#808080;stroke-width:0.4;stroke-dasharray:none;stroke:#ffffff;stroke-opacity:1;fill-opacity:1" d="m 23.654297,13.648438 v 1.199218 h 10 v -1.199218 z" id="path22" /></g><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7" cx="23.335806" cy="14.248425" r="2.3135188" /><circle style="fill:#808080;stroke:none;stroke-width:0.564999;fill-opacity:1" id="path1-7-7" cx="33.972233" cy="14.248425" r="2.3135188" /><path style="color:#000000;fill:#000000;stroke-width:0.3;stroke-dasharray:none;stroke-dashoffset:0.108" d="m 23.654019,24.391204 h 10" id="path25" /><path style="color:#000000;fill:#808080;stroke:#ffffff;stroke-width:0.3;stroke-dasharray:none;stroke-dashoffset:0.022;stroke-opacity:1;fill-opacity:1" d="m 23.625124,23.791016 v 1.199218 h 1.091797 v -1.199218 z m 1.691406,0 v 1.199218 h 1.201172 v -1.199218 z m 1.800781,0 v 1.199218 h 1.199219 v -1.199218 z m 1.828001,0 v 1.199218 h 1.201172 v -1.199218 z m 1.800782,0 v 1.199218 h 1.199218 v -1.199218 z m 1.800781,0 v 1.199218 h 1.107422 v -1.199218 z" id="path24" /><circle style="fill:#808080;stroke:none;stroke-width:0.564999;fill-opacity:1" id="path1-7-53" cx="33.972233" cy="24.391207" r="2.3135188" /><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7-5" cx="23.335806" cy="24.391207" r="2.3135188" /><path style="fill:#000000;stroke:#000000;stroke-width:0.6;stroke-dasharray:none" d="M 28.654019,10.932651 V 27.762155" id="path7" /></g></svg>',"bonds-no-hbonds-none":'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><g id="path8" style="fill:#808080;fill-opacity:1;stroke:#ffffff;stroke-width:0.4;stroke-dasharray:none;stroke-opacity:1" transform="translate(0,5.0717688)"><path style="color:#000000;fill:#808080;fill-opacity:1;stroke:#ffffff;stroke-width:0.4;stroke-dasharray:none;stroke-opacity:1" d="m 23.654019,14.248425 h 10" id="path23" /><path style="color:#000000;fill:#808080;fill-opacity:1;stroke:#ffffff;stroke-width:0.4;stroke-dasharray:none;stroke-opacity:1" d="m 23.654297,13.648438 v 1.199218 h 10 v -1.199218 z" id="path22" /></g><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7" cx="23.335806" cy="19.319817" r="2.3135188" /><circle style="fill:#808080;fill-opacity:1;stroke:none;stroke-width:0.564999" id="path1-7-7" cx="33.972233" cy="19.319817" r="2.3135188" /><path style="fill:#000000;stroke:#000000;stroke-width:0.6;stroke-dasharray:none" d="M 28.654019,10.932651 V 27.762155" id="path7" /></g></svg>',"bonds-no-hbonds-yes":'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><rect style="fill:#000000;fill-opacity:1;stroke:#ffffff;stroke-width:0.355503;stroke-dasharray:none;stroke-dashoffset:0.0831496;stroke-opacity:1" id="rect25" width="1.3572845" height="1.1344972" x="27.961069" y="23.823376" /><g id="path8" style="stroke-width:0.4;stroke-dasharray:none;stroke:#ffffff;stroke-opacity:1;fill:#808080;fill-opacity:1"><path style="color:#000000;fill:#808080;stroke-width:0.4;stroke-dasharray:none;stroke:#ffffff;stroke-opacity:1;fill-opacity:1" d="m 23.654019,14.248425 h 10" id="path23" /><path style="color:#000000;fill:#808080;stroke-width:0.4;stroke-dasharray:none;stroke:#ffffff;stroke-opacity:1;fill-opacity:1" d="m 23.654297,13.648438 v 1.199218 h 10 v -1.199218 z" id="path22" /></g><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7" cx="23.335806" cy="14.248425" r="2.3135188" /><circle style="fill:#808080;stroke:none;stroke-width:0.564999;fill-opacity:1" id="path1-7-7" cx="33.972233" cy="14.248425" r="2.3135188" /><path style="color:#000000;fill:#000000;stroke-width:0.3;stroke-dasharray:none;stroke-dashoffset:0.108;fill-opacity:1" d="m 23.654019,24.391204 h 10" id="path25" /><path style="color:#000000;fill:#000000;stroke:#ffffff;stroke-width:0.3;stroke-dasharray:none;stroke-dashoffset:0.022;stroke-opacity:1;fill-opacity:1" d="m 23.625124,23.791016 v 1.199218 h 1.091797 v -1.199218 z m 1.691406,0 v 1.199218 h 1.201172 v -1.199218 z m 1.800781,0 v 1.199218 h 1.199219 v -1.199218 z m 1.828001,0 v 1.199218 h 1.201172 v -1.199218 z m 1.800782,0 v 1.199218 h 1.199218 v -1.199218 z m 1.800781,0 v 1.199218 h 1.107422 v -1.199218 z" id="path24" /><circle style="fill:#000000;stroke:none;stroke-width:0.564999;fill-opacity:1" id="path1-7-53" cx="33.972233" cy="24.391207" r="2.3135188" /><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7-5" cx="23.335806" cy="24.391207" r="2.3135188" /><path style="fill:#000000;stroke:#000000;stroke-width:0.6;stroke-dasharray:none" d="M 28.654019,10.932651 V 27.762155" id="path7" /></g></svg>',"bonds-none-hbonds-no":'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><rect style="fill:#ffffff;fill-opacity:1;stroke:#ffffff;stroke-width:0.355503;stroke-dasharray:none;stroke-dashoffset:0.0831496;stroke-opacity:1" id="rect25" width="1.3572845" height="1.1344972" x="27.961069" y="18.752567" /><path style="color:#000000;fill:#000000;stroke-width:0.3;stroke-dasharray:none;stroke-dashoffset:0.108" d="m 23.654019,19.319816 h 10" id="path25" /><path style="color:#000000;fill:#808080;fill-opacity:1;stroke:#ffffff;stroke-width:0.3;stroke-dasharray:none;stroke-dashoffset:0.022;stroke-opacity:1" d="m 23.625124,18.720207 v 1.199218 h 1.091797 v -1.199218 z m 1.691406,0 v 1.199218 h 1.201172 v -1.199218 z m 1.800781,0 v 1.199218 h 1.199219 v -1.199218 z m 1.828001,0 v 1.199218 h 1.201172 v -1.199218 z m 1.800782,0 v 1.199218 h 1.199218 v -1.199218 z m 1.800781,0 v 1.199218 h 1.107422 v -1.199218 z" id="path24" /><circle style="fill:#808080;fill-opacity:1;stroke:none;stroke-width:0.564999" id="path1-7-53" cx="33.972233" cy="19.319817" r="2.3135188" /><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7-5" cx="23.335806" cy="19.319817" r="2.3135188" /><path style="fill:#000000;stroke:#000000;stroke-width:0.6;stroke-dasharray:none" d="M 28.654019,10.932651 V 27.762155" id="path7" /></g></svg>',"bonds-none-hbonds-yes":'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><path style="fill:#000000;stroke:#000000;stroke-width:0.6;stroke-dasharray:none" d="M 28.654019,10.932651 V 27.762155" id="path7" /><rect style="fill:#ffffff;fill-opacity:1;stroke:#ffffff;stroke-width:0.355503;stroke-dasharray:none;stroke-dashoffset:0.0831496;stroke-opacity:1" id="rect25" width="1.3572845" height="1.1344972" x="27.961069" y="18.752567" /><path style="color:#000000;fill:#000000;stroke-width:0.3;stroke-dasharray:none;stroke-dashoffset:0.108" d="m 23.654019,19.319816 h 10" id="path25" /><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:#ffffff;stroke-width:0.3;stroke-dasharray:none;stroke-dashoffset:0.022;stroke-opacity:1" d="m 23.625124,18.720207 v 1.199218 h 1.091797 v -1.199218 z m 1.691406,0 v 1.199218 h 1.201172 v -1.199218 z m 1.800781,0 v 1.199218 h 1.199219 v -1.199218 z m 1.828001,0 v 1.199218 h 1.201172 v -1.199218 z m 1.800782,0 v 1.199218 h 1.199218 v -1.199218 z m 1.800781,0 v 1.199218 h 1.107422 v -1.199218 z" id="path24" /><circle style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.564999" id="path1-7-53" cx="33.972233" cy="19.319817" r="2.3135188" /><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7-5" cx="23.335806" cy="19.319817" r="2.3135188" /></g></svg>',"bonds-yes-hbonds-no":'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><rect style="fill:#ffffff;fill-opacity:1;stroke:#ffffff;stroke-width:0.355503;stroke-dasharray:none;stroke-dashoffset:0.0831496;stroke-opacity:1" id="rect25" width="1.3572845" height="1.1344972" x="27.961069" y="23.823376" /><path style="color:#000000;fill:#000000;stroke-width:0.3;stroke-dasharray:none;stroke-dashoffset:0.108" d="m 23.654019,24.391204 h 10" id="path25" /><path style="color:#000000;fill:#808080;stroke:#ffffff;stroke-width:0.3;stroke-dasharray:none;stroke-dashoffset:0.022;stroke-opacity:1;fill-opacity:1" d="m 23.625124,23.791016 v 1.199218 h 1.091797 v -1.199218 z m 1.691406,0 v 1.199218 h 1.201172 v -1.199218 z m 1.800781,0 v 1.199218 h 1.199219 v -1.199218 z m 1.828001,0 v 1.199218 h 1.201172 v -1.199218 z m 1.800782,0 v 1.199218 h 1.199218 v -1.199218 z m 1.800781,0 v 1.199218 h 1.107422 v -1.199218 z" id="path24" /><circle style="fill:#808080;stroke:none;stroke-width:0.564999;fill-opacity:1" id="path1-7-53" cx="33.972233" cy="24.391207" r="2.3135188" /><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7-5" cx="23.335806" cy="24.391207" r="2.3135188" /><path style="fill:#000000;stroke:#000000;stroke-width:0.6;stroke-dasharray:none" d="M 28.654019,10.932651 V 27.762155" id="path7" /><g id="path8" style="stroke-width:0.4;stroke-dasharray:none;stroke:#ffffff;stroke-opacity:1;fill:#000000;fill-opacity:1"><path style="color:#000000;fill:#000000;stroke-width:0.4;stroke-dasharray:none;stroke:#ffffff;stroke-opacity:1;fill-opacity:1" d="m 23.654019,14.248425 h 10" id="path23" /><path style="color:#000000;fill:#000000;stroke-width:0.4;stroke-dasharray:none;stroke:#ffffff;stroke-opacity:1;fill-opacity:1" d="m 23.654297,13.648438 v 1.199218 h 10 v -1.199218 z" id="path22" /></g><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7" cx="23.335806" cy="14.248425" r="2.3135188" /><circle style="fill:#000000;stroke:none;stroke-width:0.564999;fill-opacity:1" id="path1-7-7" cx="33.972233" cy="14.248425" r="2.3135188" /></g></svg>',"bonds-yes-hbonds-none":'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><path style="fill:#000000;stroke:#000000;stroke-width:0.6;stroke-dasharray:none" d="M 28.654019,10.932651 V 27.762155" id="path7" /><g id="path8" style="fill:#000000;fill-opacity:1;stroke:#ffffff;stroke-width:0.4;stroke-dasharray:none;stroke-opacity:1" transform="translate(0,5.0717688)"><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:#ffffff;stroke-width:0.4;stroke-dasharray:none;stroke-opacity:1" d="m 23.654019,14.248425 h 10" id="path23" /><path style="color:#000000;fill:#000000;fill-opacity:1;stroke:#ffffff;stroke-width:0.4;stroke-dasharray:none;stroke-opacity:1" d="m 23.654297,13.648438 v 1.199218 h 10 v -1.199218 z" id="path22" /></g><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7" cx="23.335806" cy="19.319817" r="2.3135188" /><circle style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.564999" id="path1-7-7" cx="33.972233" cy="19.319817" r="2.3135188" /></g></svg>',"bonds-yes-hbonds-yes":'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1" /><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><path style="fill:#000000;stroke:#000000;stroke-width:0.6;stroke-dasharray:none" d="M 28.654019,10.932651 V 27.762155" id="path7" /><g id="path8" style="stroke-width:0.4;stroke-dasharray:none;stroke:#ffffff;stroke-opacity:1;fill:#000000;fill-opacity:1"><path style="color:#000000;fill:#000000;stroke-width:0.4;stroke-dasharray:none;stroke:#ffffff;stroke-opacity:1;fill-opacity:1" d="m 23.654019,14.248425 h 10" id="path23" /><path style="color:#000000;fill:#000000;stroke-width:0.4;stroke-dasharray:none;stroke:#ffffff;stroke-opacity:1;fill-opacity:1" d="m 23.654297,13.648438 v 1.199218 h 10 v -1.199218 z" id="path22" /></g><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7" cx="23.335806" cy="14.248425" r="2.3135188" /><circle style="fill:#000000;stroke:none;stroke-width:0.564999;fill-opacity:1" id="path1-7-7" cx="33.972233" cy="14.248425" r="2.3135188" /><rect style="fill:#ffffff;fill-opacity:1;stroke:#ffffff;stroke-width:0.355503;stroke-dasharray:none;stroke-dashoffset:0.0831496;stroke-opacity:1" id="rect25" width="1.3572845" height="1.1344972" x="27.961069" y="23.823376" /><path style="color:#000000;fill:#000000;stroke-width:0.3;stroke-dasharray:none;stroke-dashoffset:0.108" d="m 23.654019,24.391204 h 10" id="path25" /><path style="color:#000000;fill:#000000;stroke:#ffffff;stroke-width:0.3;stroke-dasharray:none;stroke-dashoffset:0.022;stroke-opacity:1;fill-opacity:1" d="m 23.625124,23.791016 v 1.199218 h 1.091797 v -1.199218 z m 1.691406,0 v 1.199218 h 1.201172 v -1.199218 z m 1.800781,0 v 1.199218 h 1.199219 v -1.199218 z m 1.828001,0 v 1.199218 h 1.201172 v -1.199218 z m 1.800782,0 v 1.199218 h 1.199218 v -1.199218 z m 1.800781,0 v 1.199218 h 1.107422 v -1.199218 z" id="path24" /><circle style="fill:#000000;stroke:none;stroke-width:0.564999;fill-opacity:1" id="path1-7-53" cx="33.972233" cy="24.391207" r="2.3135188" /><circle style="fill:#000000;stroke:none;stroke-width:0.565;stroke-dasharray:none" id="path1-7-5" cx="23.335806" cy="24.391207" r="2.3135188" /></g></svg>'},upload:'<svg width="17.850384mm" height="17.850386mm" viewBox="0 0 17.850384 17.850386" version="1.1" id="svg1" (0e150ed6c4, 2023-07-21)"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><id="namedview1" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" showguides="false" /><defs id="defs1"><marker style="overflow:visible" id="ArrowWide" refX="0" refY="0" orient="auto-start-reverse" arrow" markerWidth="1" markerHeight="1" viewBox="0 0 1 1" preserveAspectRatio="xMidYMid"><path style="fill:none;stroke:context-stroke;stroke-width:1;stroke-linecap:butt" d="M 3,-3 0,0 3,3" transform="rotate(180,0.125,0)" id="path1" /></marker></defs><g 1" id="layer1" transform="translate(-19.728827,-10.394623)"><text xml:space="preserve" style="font-size:7.05556px;fill:#e6e6e6;stroke:none;stroke-width:0.5;stroke-linecap:round;stroke-dasharray:none" x="22.242813" y="28.151989" id="text2"><tspan id="tspan2" style="font-size:7.05556px;fill:#1a1a1a;stroke-width:0.5;stroke-linecap:round;stroke-dasharray:none" x="22.242813" y="28.151989">CIF</tspan></text><path style="fill:none;stroke:#000000;stroke-width:0.68;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1" d="m 20.714121,18.107197 v 3.07807 h 15.879794 v -3.07807" id="path2" /><path style="fill:none;stroke:#000000;stroke-width:0.68;stroke-linecap:butt;stroke-dasharray:none;stroke-opacity:1;marker-end:url(#ArrowWide)" d="M 28.654018,19.170064 V 11.045456" id="path3" /></g></svg>'},ce=`
  cifview-widget {
    display: flex;
    flex-direction: column;
    font-family: system-ui, -apple-system, sans-serif;
    height: 100%;
    position: relative;
    background: #fafafa;
    border-radius: 8px;
    overflow: hidden;
  }
  
  cifview-widget .crystal-container {
    flex: 1;
    min-height: 0;
    position: relative;
  }
  
  cifview-widget .crystal-caption {
    padding: 12px 16px;
    background: #ffffff;
    border-top: 1px solid #eaeaea;
    color: #333;
    font-size: 14px;
    line-height: 1.5;
  }

  cifview-widget .button-container {
    position: absolute;
    top: 16px;
    right: 16px;
    display: flex;
    gap: 8px;
    z-index: 1000;
  }

  cifview-widget .control-button {
    width: 40px;
    height: 40px;
    border: none;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.9);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  cifview-widget .control-button:hover {
    background: #ffffff;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }

  cifview-widget .control-button svg {
    width: 24px;
    height: 24px;
  }
`;class Lt extends HTMLElement{static get observedAttributes(){return["caption","src","data","icons","filtered-atoms","options","hydrogen-mode","disorder-mode","symmetry-mode"]}constructor(){if(super(),!document.getElementById("cifview-styles")){const t=document.createElement("style");t.id="cifview-styles",t.textContent=ce,document.head.appendChild(t)}this.viewer=null,this.baseCaption="",this.selections=[],this.customIcons=null,this.userOptions={}}get icons(){return{...le,...this.customIcons}}async connectedCallback(){this.baseCaption=this.getAttribute("caption")||"",this.parseOptions(),this.parseInitialModes();const t=document.createElement("div");t.className="crystal-container",this.appendChild(t);const e=document.createElement("div");e.className="button-container",t.appendChild(e),this.buttonContainer=e;const o=document.createElement("div");o.className="crystal-caption",o.textContent=this.baseCaption,this.appendChild(o),this.captionElement=o,this.viewer=new ft(t,this.userOptions),this.viewer.selections.onChange(i=>{this.selections=i,this.updateCaption()}),this.customIcons=this.parseCustomIcons(),await this.updateFilteredAtoms();const s=this.getAttribute("src"),r=this.getAttribute("data");s?await this.loadFromUrl(s):r&&await this.loadFromString(r)}parseOptions(){const t=this.getAttribute("options");if(t)try{const e=JSON.parse(t);this.userOptions=this.mergeOptions(e)}catch(e){console.warn("Failed to parse options:",e)}}mergeOptions(t){const e={...w};return Object.keys(t).forEach(o=>{o==="elementProperties"?(e.elementProperties={...e.elementProperties},Object.keys(t.elementProperties||{}).forEach(s=>{e.elementProperties[s]={...e.elementProperties[s]||{},...t.elementProperties[s]}})):typeof t[o]=="object"&&t[o]!==null?e[o]={...e[o]||{},...t[o]}:e[o]=t[o]}),e}parseInitialModes(){const t=this.getAttribute("hydrogen-mode"),e=this.getAttribute("disorder-mode"),o=this.getAttribute("symmetry-mode");t&&(this.userOptions.hydrogenMode=t),e&&(this.userOptions.disorderMode=e),o&&(this.userOptions.symmetryMode=o)}clearButtons(){if(this.buttonContainer)for(;this.buttonContainer.firstChild;)this.buttonContainer.removeChild(this.buttonContainer.firstChild)}setupButtons(){!this.viewer||!this.viewer.state.baseStructure||(this.clearButtons(),this.viewer.numberModifierModes("hydrogen")>1&&this.addButton(this.buttonContainer,"hydrogen","Toggle Hydrogen Display"),this.viewer.numberModifierModes("disorder")>1&&this.addButton(this.buttonContainer,"disorder","Toggle Disorder Display"),this.viewer.numberModifierModes("symmetry")>1&&this.addButton(this.buttonContainer,"symmetry","Toggle Symmetry Display"))}parseCustomIcons(){try{let t;try{t=JSON.parse(this.getAttribute("icons"))}catch{throw new Error("Failed to parse custom icon definition. Needs to be valid JSON.")}if(!t)return null;const e=Object.getOwnPropertyNames(t),o=Object.getOwnPropertyNames(this.viewer.modifiers),s=e.filter(a=>!o.includes(a));if(s.length>0)throw new Error(`One or more invalid categories for custom icons: ${s.join(", ")}. Valid categories: ${o.join(", ")}`);const r={},i=[];for(const a of e){r[a]={};const n=Object.values(this.viewer.modifiers[a].MODES);Object.getOwnPropertyNames(t[e]).forEach(h=>{n.includes(h)?r[a][h]=t[a][h]:i.push([a,h])})}if(i.length>0){const a=i.map(([n,c])=>`${n}: ${c}`).join(" ,");throw new Error(`The following custom icons do not map to a valid mode: ${a}`)}return r}catch(t){return console.warn("Failed to parse custom icons:",t),null}}async updateFilteredAtoms(){const t=this.getAttribute("filtered-atoms"),e=t?t.split(","):[];this.viewer.modifiers.removeatoms.setFilteredLabels(e),e.length>0?(this.viewer.modifiers.removeatoms.mode="on",await this.viewer.setupNewStructure()):this.viewer.modifiers.removeatoms.mode="off"}addButton(t,e,o){const s=document.createElement("button");s.className=`control-button ${e}-button`;const r=this.viewer.modifiers[e].mode;s.innerHTML=this.icons[e][r],s.title=o;const i=s.querySelector("svg");i&&(i.setAttribute("alt",o),i.setAttribute("role","img"),i.setAttribute("aria-label",o)),t.appendChild(s),s.addEventListener("click",async()=>{const a=await this.viewer.cycleModifierMode(e);a.success&&(s.innerHTML=this.icons[e][a.mode])})}async attributeChangedCallback(t,e,o){if(this.viewer)switch(t){case"caption":this.baseCaption=o,this.updateCaption();break;case"src":o&&await this.loadFromUrl(o);break;case"data":o&&await this.loadFromString(o);break;case"icons":this.customIcons=this.parseCustomIcons();break;case"filtered-atoms":await this.updateFilteredAtoms();break;case"options":if(this.parseOptions(),this.viewer){const s=this.querySelector(".crystal-container");this.viewer.dispose(),this.viewer=new ft(s,this.userOptions),this.viewer.selections.onChange(r=>{this.selections=r,this.updateCaption()}),this.viewer.state.currentCifContent&&(await this.viewer.loadStructure(this.viewer.state.currentCifContent),this.setupButtons())}break;case"hydrogen-mode":this.viewer.modifiers.hydrogen&&(this.viewer.modifiers.hydrogen.mode=o,await this.viewer.updateStructure(),this.setupButtons());break;case"disorder-mode":this.viewer.modifiers.disorder&&(this.viewer.modifiers.disorder.mode=o,await this.viewer.updateStructure(),this.setupButtons());break;case"symmetry-mode":this.viewer.modifiers.symmetry&&(this.viewer.modifiers.symmetry.mode=o,await this.viewer.setupNewStructure(),this.setupButtons());break}}async loadFromUrl(t){try{const o=await(await fetch(t)).text();await this.viewer.loadStructure(o),this.setupButtons()}catch(e){console.error("Error loading structure:",e)}}async loadFromString(t){try{await this.viewer.loadStructure(t),this.setupButtons()}catch(e){console.error("Error loading structure:",e)}}updateCaption(){let t=this.baseCaption;if(this.selections.length>0){t.endsWith(".")||(t+="."),t+=" Selected Atoms and Bonds: ";const e=this.selections.map(o=>{const s="#"+o.color.toString(16).padStart(6,"0");let r="";if(o.type==="atom")r=`${o.data.label} (${o.data.atomType})`;else if(o.type==="bond"){const i=Et(o.data.bondLength,o.data.bondLengthSU);r=`${o.data.atom1Label}-${o.data.atom2Label}: ${i} `}else o.type==="hbond"&&(r=`${o.data.donorAtomLabel}${o.data.acceptorAtomLabel}`);return`<span style="color:${s}">${r}</span>`}).join(", ");t+=e+"."}this.captionElement.innerHTML=t,this.viewer.controls.handleResize()}disconnectedCallback(){this.viewer&&this.viewer.dispose()}}if(typeof window<"u"&&window.customElements)try{window.customElements.define("cifview-widget",Lt)}catch(l){l.message.includes("already been defined")||console.warn("Failed to register cifview-widget:",l)}p.AtomLabelFilter=ot,p.BondGenerator=st,p.CIF=gt,p.CifViewWidget=Lt,p.CrystalStructure=T,p.CrystalViewer=ft,p.DisorderFilter=et,p.HydrogenFilter=tt,p.ORTEP3JsStructure=Dt,p.SymmetryGrower=q,p.formatValueEsd=Et,p.tryToFixCifBlock=Ot,Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
